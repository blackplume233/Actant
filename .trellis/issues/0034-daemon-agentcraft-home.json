{
  "id": 34,
  "title": "Daemon 未读取 AGENTCRAFT_HOME 环境变量",
  "status": "closed",
  "labels": [
    "bug",
    "priority:P1",
    "qa"
  ],
  "milestone": null,
  "body": "## 测试发现\n\n**场景**: 即兴探索 - Bilibili 视频分析 Agent\n**步骤**: 环境准备 - 启动 Daemon\n\n## 复现方式\n\n```bash\n# 设置环境变量\nexport AGENTCRAFT_HOME=/tmp/test-agentcraft\nexport AGENTCRAFT_SOCKET=/tmp/test-agentcraft/agentcraft.sock\nexport AGENTCRAFT_LAUNCHER_MODE=mock\n\n# 启动 Daemon\nnode packages/cli/dist/bin/agentcraft.js daemon start\n\n# 检查状态\nnode packages/cli/dist/bin/agentcraft.js daemon status\n```\n\n## 期望行为\n\nDaemon 应该使用 `$AGENTCRAFT_HOME` 作为工作目录，创建 socket 文件到 `/tmp/test-agentcraft/agentcraft.sock`。\n\n## 实际行为\n\nDaemon 忽略了环境变量，使用了默认目录 `/Users/muyuli/.agentcraft`。\n\n日志显示：\n```\n\"socketPath\":\"/Users/muyuli/.agentcraft/agentcraft.sock\"\n\"configDir\":\"/Users/muyuli/.agentcraft/configs/templates\"\n```\n\n检查代码确认：\n- `packages/cli/src/daemon-entry.ts` 创建 Daemon 时未传入配置\n- `packages/api/src/services/app-context.ts` 未读取 `AGENTCRAFT_HOME` 环境变量\n\n## 分析\n\n`daemon-entry.ts` 中直接实例化 Daemon：\n```typescript\nconst daemon = new Daemon();\n```\n\n`AppContext` 构造函数：\n```typescript\nthis.homeDir = config?.homeDir ?? DEFAULT_HOME;\n```\n\n没有从环境变量读取 `homeDir` 的逻辑。\n\n修复方案：\n1. `AppContext` 应该检查 `process.env.AGENTCRAFT_HOME`\n2. 或者 `daemon-entry.ts` 读取环境变量后传入配置\n\n影响：\n- 无法使用隔离环境进行测试\n- 无法在同一机器上运行多个 Daemon 实例\n- 违背 `.trellis/spec/config-spec.md` 中关于环境变量的规范",
  "author": "cursor-agent",
  "assignees": [],
  "relatedFiles": [],
  "relatedIssues": [],
  "taskRef": null,
  "githubRef": "blackplume233/AgentCraft#39",
  "closedAs": "completed",
  "comments": [
    {
      "text": "Closed as completed",
      "date": "2026-02-20T17:59:07",
      "author": "cursor-agent"
    }
  ],
  "createdAt": "2026-02-20T17:38:57",
  "updatedAt": "2026-02-20T17:59:07",
  "closedAt": "2026-02-20T17:59:07"
}
