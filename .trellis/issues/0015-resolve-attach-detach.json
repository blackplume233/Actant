{
  "id": 15,
  "title": "agent.resolve / agent.attach / agent.detach API — 外部 Spawn 支持",
  "status": "closed",
  "labels": [
    "core",
    "feature",
    "api",
    "priority:P1"
  ],
  "milestone": "near-term",
  "body": "## 目标\n\n实现三个新 RPC 方法，允许外部客户端（Unreal/Unity 等）自行 spawn Agent 进程，同时将状态注册到 AgentCraft 进行跟踪。\n\n## 背景\n\n外部客户端可能需要自行管理 Agent 进程（保留对 ACP 连接的完全控制），但同时希望 AgentCraft 提供 workspace 物化和状态追踪。这是四种外部接入模式中的 \"Self-spawn + Attach\" 模式。\n\n## 功能\n\n### agent.resolve\n- 获取 spawn 所需的全部信息（command, args, env, workspaceDir）而不启动进程\n- 若实例不存在但提供了 template，自动创建实例（含 workspace 物化）\n- 返回 ResolveResult 结构\n\n### agent.attach\n- 外部客户端 spawn 后调用，告知 AgentCraft PID\n- 设置 processOwnership: \"external\"，status: \"running\"\n- 注册 ProcessWatcher 监控（检测 PID 意外死亡 → status: \"crashed\"）\n- 防止重复 attach（返回 AGENT_ALREADY_ATTACHED 错误）\n\n### agent.detach\n- 外部客户端终止进程后调用\n- 清除 processOwnership、pid，status → stopped\n- 可选 cleanup: true 删除 ephemeral workspace\n\n## 新增配置字段\n\n- `AgentInstanceMeta.processOwnership`: \"managed\" | \"external\"\n- `AgentInstanceMeta.workspacePolicy`: \"persistent\" | \"ephemeral\"\n- `AgentStatus` 新值: \"crashed\"\n\n## CLI 命令\n\n- `agentcraft agent resolve <name> -t <template>`\n- `agentcraft agent attach <name> --pid <pid>`\n- `agentcraft agent detach <name> [--cleanup]`\n\n## 依赖\n\n- #8 ProcessWatcher（attach 后需要 PID 监控）\n- #9 LaunchMode 行为分化（processOwnership 与 LaunchMode 交互）\n\n## 验收\n\n- [ ] agent.resolve 返回完整 spawn 信息\n- [ ] agent.resolve 支持 template 参数自动创建\n- [ ] agent.attach 正确更新 meta 并注册 ProcessWatcher\n- [ ] agent.detach 正确清理状态\n- [ ] detach cleanup 删除 ephemeral workspace\n- [ ] 重复 attach 返回错误\n- [ ] ProcessWatcher 检测到 PID 死亡 → crashed\n- [ ] CLI 命令可用\n- [ ] 单元测试覆盖",
  "author": "cursor-agent",
  "assignees": [],
  "relatedFiles": [
    "packages/shared/src/types/agent.types.ts",
    "packages/core/src/state/instance-meta-schema.ts",
    "packages/api/src/handlers/"
  ],
  "relatedIssues": [
    8,
    9
  ],
  "taskRef": null,
  "githubRef": null,
  "closedAs": "completed",
  "comments": [
    {
      "text": "Closed as completed",
      "date": "2026-02-20T15:09:27",
      "author": "cursor-agent"
    }
  ],
  "createdAt": "2026-02-20T18:00:00",
  "updatedAt": "2026-02-20T15:09:27",
  "closedAt": "2026-02-20T15:09:27"
}
