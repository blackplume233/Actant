{
  "id": 52,
  "title": "AgentTemplate 应当可通过 Source 分享，Preset 中也应包含 AgentTemplate",
  "status": "open",
  "labels": ["feature", "source", "template", "priority:P1"],
  "milestone": "phase-3",
  "body": "## 问题\n\n当前 Source 系统（GitHub / Local 等）可以同步和分享 Skill、Prompt、McpServer、Workflow 四种组件，以及 Preset 组合包。但 **AgentTemplate 本身不在可分享组件之列**，这是一个重大遗漏。\n\nAgentTemplate 是 Actant 的核心产物 — 它定义了一个完整的 Agent 配置。用户理应能够：\n1. 将自己编写的 AgentTemplate 发布到 Source（GitHub 仓库或本地包）\n2. 从他人的 Source 安装 AgentTemplate 到本地 TemplateRegistry\n3. 在 Preset 中引用 AgentTemplate，实现 \"一键获得完整 Agent 配置包\"\n\n## 现状分析\n\n### FetchResult（component-source.ts）\n\n```typescript\nexport interface FetchResult {\n  manifest: PackageManifest;\n  skills: SkillDefinition[];\n  prompts: PromptDefinition[];\n  mcpServers: McpServerDefinition[];\n  workflows: WorkflowDefinition[];\n  presets: PresetDefinition[];\n  // ❌ 没有 templates\n}\n```\n\n### PackageManifest（source.types.ts）\n\n```typescript\nexport interface PackageManifest {\n  name: string;\n  components?: {\n    skills?: string[];\n    prompts?: string[];\n    mcp?: string[];\n    workflows?: string[];\n    // ❌ 没有 templates\n  };\n  presets?: string[];\n}\n```\n\n### PresetDefinition（source.types.ts）\n\n```typescript\nexport interface PresetDefinition {\n  name: string;\n  description?: string;\n  skills?: string[];\n  prompts?: string[];\n  mcpServers?: string[];\n  workflows?: string[];\n  // ❌ 没有 templates\n}\n```\n\n### SourceManagerDeps（source-manager.ts）\n\n```typescript\nexport interface SourceManagerDeps {\n  skillManager: BaseComponentManager<SkillDefinition>;\n  promptManager: BaseComponentManager<PromptDefinition>;\n  mcpConfigManager: BaseComponentManager<McpServerDefinition>;\n  workflowManager: BaseComponentManager<WorkflowDefinition>;\n  // ❌ 没有 templateRegistry\n}\n```\n\n## 提议方案\n\n### 1. FetchResult 新增 templates 字段\n\n```typescript\nexport interface FetchResult {\n  manifest: PackageManifest;\n  skills: SkillDefinition[];\n  prompts: PromptDefinition[];\n  mcpServers: McpServerDefinition[];\n  workflows: WorkflowDefinition[];\n  presets: PresetDefinition[];\n  templates: AgentTemplate[];       // ✅ 新增\n}\n```\n\n### 2. PackageManifest.components 新增 templates\n\n```typescript\nexport interface PackageManifest {\n  name: string;\n  components?: {\n    skills?: string[];\n    prompts?: string[];\n    mcp?: string[];\n    workflows?: string[];\n    templates?: string[];           // ✅ 新增\n  };\n  presets?: string[];\n}\n```\n\n### 3. PresetDefinition 新增 templates 字段\n\n```typescript\nexport interface PresetDefinition {\n  name: string;\n  description?: string;\n  skills?: string[];\n  prompts?: string[];\n  mcpServers?: string[];\n  workflows?: string[];\n  templates?: string[];             // ✅ 新增\n}\n```\n\n### 4. SourceManagerDeps 新增 templateRegistry\n\n```typescript\nexport interface SourceManagerDeps {\n  skillManager: BaseComponentManager<SkillDefinition>;\n  promptManager: BaseComponentManager<PromptDefinition>;\n  mcpConfigManager: BaseComponentManager<McpServerDefinition>;\n  workflowManager: BaseComponentManager<WorkflowDefinition>;\n  templateRegistry: TemplateRegistry; // ✅ 新增\n}\n```\n\n### 5. SourceManager 注入逻辑扩展\n\n`injectComponents()` 和 `removeNamespacedComponents()` 需要处理 templates，将远程模板以 `package@name` 命名空间注入到 TemplateRegistry。\n\n### 6. LocalSource / GitHubSource 加载 templates/ 目录\n\n在 Source 目录结构中新增 `templates/` 目录，Source 实现类需扫描并加载其中的 `.json` 模板定义文件。\n\n### 7. applyPreset 扩展\n\n`applyPreset()` 当前只展开 skills/prompts/mcpServers/workflows 引用。如果 preset 包含 templates，应将模板注册到本地 TemplateRegistry（而非展开到某个模板的 domainContext 中 — 因为 template 是独立的顶层实体）。\n\n可考虑新增 `installPreset()` 方法区别于 `applyPreset()`：\n- `applyPreset(presetName, templateName)` — 将 preset 中的组件（skills/prompts 等）合并到已有模板\n- `installPreset(presetName)` — 安装 preset 中的所有模板到本地，同时安装依赖组件\n\n### 8. CLI / RPC 扩展\n\n```bash\n# 列出 Source 中的模板\nagentcraft source templates <sourceName>\n\n# 从 Source 安装模板\nagentcraft template install <package>@<templateName>\n\n# 导出模板为可分享格式\nagentcraft template export <name> [--out]\n```\n\n## 目录结构示例\n\n```\nmy-agent-package/\n├── agentcraft.json          # PackageManifest\n├── skills/\n│   ├── code-review.md\n│   └── test-writer.md\n├── prompts/\n│   └── system-prompt.md\n├── templates/               # ✅ 新增\n│   ├── code-reviewer.json   # AgentTemplate\n│   └── test-engineer.json   # AgentTemplate\n└── presets/\n    └── full-dev-suite.json  # 包含 templates 引用\n```\n\n## 验收标准\n\n- [ ] `FetchResult` 新增 `templates: AgentTemplate[]` 字段\n- [ ] `PackageManifest.components` 新增 `templates?: string[]`\n- [ ] `PresetDefinition` 新增 `templates?: string[]` 字段\n- [ ] `SourceManagerDeps` 包含 `templateRegistry`\n- [ ] `SourceManager.injectComponents()` 将远程模板注入 TemplateRegistry\n- [ ] `SourceManager.removeNamespacedComponents()` 处理模板清除\n- [ ] `LocalSource` / `GitHubSource` 可扫描加载 `templates/` 目录\n- [ ] Preset 安装可将模板注册到本地\n- [ ] 至少 1 个示例 Source 包含可分享的 AgentTemplate\n- [ ] 相关单元测试覆盖\n- [ ] CLI 支持从 Source 安装模板",
  "author": "human",
  "assignees": [],
  "relatedFiles": [
    "packages/core/src/source/component-source.ts",
    "packages/core/src/source/source-manager.ts",
    "packages/core/src/source/local-source.ts",
    "packages/core/src/source/github-source.ts",
    "packages/shared/src/types/source.types.ts",
    "packages/shared/src/types/template.types.ts",
    "packages/core/src/template/registry/template-registry.ts"
  ],
  "relatedIssues": [38, 49, 51],
  "taskRef": null,
  "githubRef": null,
  "closedAs": null,
  "comments": [],
  "createdAt": "2026-02-21T23:15:00",
  "updatedAt": "2026-02-21T23:15:00",
  "closedAt": null
}
