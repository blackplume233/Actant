{
  "id": 25,
  "title": "测试用例实现深度审查 — 类型安全、断言与配对缺口",
  "status": "open",
  "labels": [
    "enhancement",
    "priority:P2",
    "quality",
    "review"
  ],
  "milestone": null,
  "body": "## 审查发现（深度审查所有测试用例实现）\n\n### 1. 类型安全（与 #24 重叠，此处为测试侧摘要）\n\n- **process-watcher.test.ts**：`exitHandler = vi.fn<(info: ProcessExitInfo) => void>()` 的返回值与 `ProcessExitHandler` 不兼容，需显式类型或断言；测试运行时通过，但 type-check 失败。\n- **launch-mode-handler.test.ts**：`modes.map(getLaunchModeHandler)` 得到数组后直接 `handlers[0].mode` 等访问，TS 认为可能 undefined，需断言或守卫。\n- **agent-manager.test.ts**：第 403 行声明 `pid` 未使用，应删除或使用。\n\n### 2. 测试与源码配对\n\n- **有对应测试的模块**：AgentManager、AgentInitializer、ContextMaterializer、instance-meta-io、ProcessWatcher、ProcessLauncher、backend-resolver、create-launcher、process-utils、LaunchModeHandler、RestartTracker、TemplateRegistry、TemplateLoader、template-schema、type-alignment、domain-context-resolver、Skill/Prompt/Workflow/McpConfig 各 Manager、platform、logger、errors；API 侧 template-handlers、agent-handlers、socket-server；CLI 仅有 e2e-cli.test。\n- **无明显单测的源码**：`instance-meta-schema.ts`（仅被 io 使用）、`api/src/daemon/pid-file.ts`、`handler-registry.ts` 单独逻辑、`daemon.ts` 主流程；CLI 包见 #20。\n\n### 3. 测试实现质量（亮点与可改进点）\n\n- **亮点**：agent-manager.test 与 agent-initializer.test 使用临时目录、afterEach 清理、makeTemplate/makeMeta 工厂，结构清晰；ProcessWatcher 使用 fake timers 与 isProcessAlive mock，覆盖轮询与退出回调；instance-meta-io 覆盖损坏 JSON、update、scan。\n- **可改进**：部分测试依赖 `setTimeout(r, 120)` 等固定延迟，在慢环境可能 flaky，可考虑 `vi.advanceTimersByTimeAsync` 或等待条件；ProcessWatcher 测试中 handler 类型若修复（#24）可同时收紧 mock 签名便于重构。\n\n### 4. 建议\n\n- 优先修复 #24 使 type-check 通过。\n- 为 `instance-meta-schema.ts`（校验/默认值逻辑）和 `pid-file.ts`（读写与锁）考虑补充单元测试。\n- 在 CI 中强制 `pnpm run type-check`，避免仅 `pnpm test` 通过而类型仍红。",
  "author": "cursor-agent",
  "assignees": [],
  "relatedFiles": [],
  "relatedIssues": [],
  "taskRef": null,
  "githubRef": null,
  "closedAs": null,
  "comments": [
    {
      "text": "[Review 更严格] 补充：1) 测试代码也应禁止非空断言，见 #26。2) 测试中固定 setTimeout 存在 flaky 风险，见 #28。3) CI 须强制 type-check，见 #27。",
      "date": "2026-02-20T13:19:17",
      "author": "cursor-agent"
    }
  ],
  "createdAt": "2026-02-20T13:17:08",
  "updatedAt": "2026-02-20T13:19:17",
  "closedAt": null
}
