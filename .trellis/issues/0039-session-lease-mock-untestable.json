{
  "id": 39,
  "title": "Session Lease API 在 mock launcher 模式下无法端到端测试",
  "status": "open",
  "labels": [
    "bug",
    "qa",
    "acp",
    "priority:P1"
  ],
  "milestone": null,
  "body": "## 测试发现\n\n**场景**: Issue #35 随机漫步测试\n**步骤**: 2.5 / 2.9 - session.create 调用\n\n## 复现方式\n\n```bash\nexport ACTANT_HOME=$(mktemp -d)\nexport ACTANT_LAUNCHER_MODE=mock\n\n# 启动 Daemon + 创建 Agent\nactant daemon start --foreground &\nactant template load <template.json>  # backend.type = \"cursor\"\nactant agent create test -t tpl\nactant agent start test\n\n# 尝试创建 session\n# RPC: session.create {agentName: \"test\", clientId: \"c1\"}\n```\n\n## 期望行为\n\n在 mock 模式下能够创建 session lease 并测试 session.cancel 等核心功能。\n\n## 实际行为\n\n两种失败路径：\n1. `cursor` 后端: 返回 `Agent has no ACP connection`（因为只有 claude-code 后端创建 ACP 连接）\n2. `claude-code` 后端: Agent 立即变为 stopped（ProcessWatcher 检测到假 PID 10000+ 不存活）\n\n## 分析\n\nMock launcher 返回的假 PID 不对应真实进程，ProcessWatcher 在 5 秒内标记 agent 为 stopped。\n\n即使 agent 暂时 running，非 ACP 后端不建立 ACP 连接。session.create 的 `hasAcpConnection` 检查失败。\n\n对于 claude-code 后端，虽然 `isAcpBackend` 返回 true，但 mock launcher 不触发 `acpManager.connect()` 的真实 spawn，导致 ACP 连接也不存在。\n\n## 建议修复\n\n选项 A: 在 MockLauncher 中支持 mock ACP 连接，返回可控的 session 响应\n选项 B: 添加 MockAcpConnectionManager，配合 mock launcher 使用\n选项 C: 创建单元测试直接测试 session handlers（mock AppContext）\n\n推荐选项 C 作为最小修复方案。",
  "author": "qa-agent",
  "assignees": [],
  "relatedFiles": [
    "packages/api/src/handlers/session-handlers.ts",
    "packages/core/src/manager/launcher/mock-launcher.ts",
    "packages/core/src/session/session-registry.ts"
  ],
  "comments": [],
  "createdAt": "2026-02-21T10:20:00.000Z",
  "updatedAt": "2026-02-21T10:20:00.000Z",
  "closedAt": null,
  "closedAs": null,
  "githubRef": "blackplume233/AgentCraft#44"
}
