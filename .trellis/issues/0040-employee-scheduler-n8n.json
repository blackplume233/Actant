{
  "id": 40,
  "title": "雇员型 Agent 实现 — 内置调度器 + N8N 集成",
  "status": "open",
  "labels": [
    "feature",
    "architecture",
    "scheduler",
    "priority:P1"
  ],
  "milestone": "mid-term",
  "body": "## 目标\n\n实现长时间运行的雇员型 Agent，内置简单调度器（Heartbeat / Cron / Hook / Webhook），并支持可选的 N8N 集成。\n\n**与 #37 的关系**：本 Issue 是 #37（雇员型 Agent 设计）的实现版本，细化了调度器实现方案，新增了 N8N 集成考量。#37 保留为原始设计文档。\n\n## 架构设计\n\n### 内置调度器\n\n```\nEmployeeScheduler\n  ├── InputRouter        → 管理所有 InputSource，统一分发到 TaskQueue\n  ├── TaskQueue          → per-agent 串行队列，priority-sorted\n  ├── TaskDispatcher     → dequeue → AcpConnection.prompt() → ExecutionLog\n  └── InputSources:\n       ├── HeartbeatInput  → setInterval，可配置间隔\n       ├── CronInput       → cron 表达式（使用 croner 库）\n       ├── HookInput       → 内部事件（agent:started, task:completed 等）\n       └── WebhookInput    → HTTP 接收（Hono 路由）\n```\n\n### N8N 集成（三种模式）\n\n**模式 1: N8N → AgentCraft（N8N 作为调度器）**\n- N8N 通过 Webhook 触发 AgentCraft 的雇员 Agent\n- AgentCraft WebhookReceiver 接收 → TaskQueue → 执行 → callback 返回结果\n\n**模式 2: AgentCraft → N8N（Agent 使用 N8N 能力）**\n- Agent 通过 MCP Server 调用 N8N 的 API\n- MCP Tools: n8n_trigger_workflow, n8n_list_workflows, n8n_get_execution\n\n**模式 3: 双向集成（推荐最终形态）**\n- N8N 做复杂调度和外部事件编排\n- AgentCraft 做 Heartbeat/Hook 等紧耦合调度\n- 双方通过 Webhook + MCP 双向通信\n\n### 为什么不完全依赖 N8N？\n\n| 考量 | 内置调度器 | N8N |\n|------|-----------|-----|\n| 部署复杂度 | 零依赖 | 需要单独部署 |\n| Heartbeat | 紧耦合 Agent 状态 | 不适合 |\n| Hook（内部事件） | 直接访问 AgentManager | 需要桥接 |\n| 复杂编排 | 不擅长 | 核心能力 |\n| 外部集成 | 需自行实现 | 丰富生态 |\n\n结论：Heartbeat + Hook + 简单 Cron 内置，复杂编排推荐 N8N。\n\n## 模板配置\n\n```json\n{\n  \"schedule\": {\n    \"heartbeat\": {\n      \"enabled\": true,\n      \"intervalMs\": 1800000,\n      \"prompt\": \"检查是否有新任务\",\n      \"suppressNoAction\": true\n    },\n    \"cron\": [\n      { \"schedule\": \"0 9 * * 1-5\", \"prompt\": \"晨检报告\", \"label\": \"morning\" }\n    ],\n    \"hooks\": [\n      { \"event\": \"agent:started\", \"prompt\": \"检查待处理事项\" }\n    ],\n    \"webhooks\": [\n      { \"path\": \"/webhook/github\", \"promptTemplate\": \"GitHub: {{event}}\" }\n    ],\n    \"n8n\": { \"enabled\": true, \"callbackUrl\": \"http://n8n:5678/webhook/agentcraft-callback\" }\n  }\n}\n```\n\n## 实现分阶段\n\n### Phase 1: TaskQueue + Dispatcher 基础\n\n```\npackages/core/src/scheduler/\n  ├── task-queue.ts\n  ├── task-dispatcher.ts\n  ├── execution-log.ts\n  └── index.ts\n```\n\n- TaskQueue：per-agent 串行队列\n- TaskDispatcher：dequeue → promptAgent → record\n- AgentManager 集成：acp-service + schedule → 启动 dispatcher\n- CLI: `agent dispatch <name> \"prompt\"`\n\n### Phase 2: InputRouter + 内置 InputSources\n\n```\npackages/core/src/scheduler/inputs/\n  ├── input-source.ts\n  ├── input-router.ts\n  ├── heartbeat-input.ts\n  ├── cron-input.ts       ← 使用 croner 库\n  ├── hook-input.ts\n  └── index.ts\n```\n\n- 模板 schema 扩展 `schedule` 字段\n- CLI: `schedule list/pause/resume`\n\n### Phase 3: Webhook + N8N Bridge\n\n```\npackages/api/src/http/webhook-handler.ts\npackages/core/src/scheduler/inputs/webhook-input.ts\npackages/core/src/scheduler/inputs/n8n-bridge.ts\n```\n\n- Webhook HMAC 验证\n- N8N payload 解析 + callback\n- CLI: `agent logs / agent watch / agent tasks`\n\n## 依赖\n\n| 依赖 | 状态 | 说明 |\n|------|------|------|\n| #11 acp-service 崩溃重启 | ✅ 完成 | 进程保活基础 |\n| #12 Daemon ↔ Agent 通信 | ✅ 完成 | AcpConnection 基础 |\n| #37 原始设计 | 参考 | 设计文档 |\n| croner | 新增依赖 | Cron 解析库（零依赖、ESM） |\n\n## 验收标准\n\n- [ ] TaskQueue 串行执行 + 优先级\n- [ ] Heartbeat 定时触发 Agent 检查\n- [ ] Cron 按表达式定时派发任务\n- [ ] Hook 在内部事件时触发 Agent 行动\n- [ ] `agent dispatch` 手动派发任务\n- [ ] `agent logs` 查看执行历史\n- [ ] `agent tasks` 查看任务队列\n- [ ] Webhook 接收 + HMAC 验证\n- [ ] N8N Bridge：Webhook → Agent → Callback\n- [ ] 模板支持 schedule 配置字段\n- [ ] 任务失败正确处理（记录、触发 hook、可选重试）",
  "author": "human",
  "assignees": [],
  "relatedFiles": [
    "packages/core/src/scheduler/task-queue.ts",
    "packages/core/src/scheduler/task-dispatcher.ts",
    "packages/core/src/scheduler/execution-log.ts",
    "packages/core/src/scheduler/inputs/input-source.ts",
    "packages/core/src/scheduler/inputs/input-router.ts",
    "packages/core/src/scheduler/inputs/heartbeat-input.ts",
    "packages/core/src/scheduler/inputs/cron-input.ts",
    "packages/core/src/scheduler/inputs/hook-input.ts",
    "packages/core/src/scheduler/inputs/webhook-input.ts",
    "packages/core/src/scheduler/inputs/n8n-bridge.ts",
    "packages/api/src/http/webhook-handler.ts",
    "packages/core/src/manager/agent-manager.ts",
    "packages/core/src/template/schema/template-schema.ts"
  ],
  "relatedIssues": [37, 11, 12, 13, 17, 38],
  "taskRef": null,
  "githubRef": null,
  "closedAs": null,
  "comments": [],
  "createdAt": "2026-02-21T12:00:00",
  "updatedAt": "2026-02-21T12:00:00",
  "closedAt": null
}
