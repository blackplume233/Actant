{
  "id": 55,
  "title": "Actant 安装流程 · Help 指令 · 本地部署自更新机制",
  "status": "open",
  "labels": ["feature", "cli", "devx", "documentation", "priority:P0"],
  "milestone": "phase-3",
  "body": "## 背景\n\nActant 已完成 Phase 1–3 核心功能开发，但缺乏正式的安装流程、内置帮助系统和本地部署更新机制。用户（开发者本人）需要：\n1. 将 Actant 安装到合适的全局目录，作为日常持续使用的工具\n2. 通过 `actant help` 快速查阅可用命令和用法\n3. 在持续开发过程中，能将最新代码无缝更新到本地已部署的版本，同时保持已运行 Agent 的正常工作\n\n## 一、正式安装流程文档与脚本 (Install)\n\n### 问题\n\n当前 Actant 只能在开发目录中通过 `pnpm dev` 运行，没有正式的安装流程。作为一个需要持续使用的开发者工具，需要：\n- 全局可执行的 `actant` 命令\n- 合理的目录结构（代码目录 vs 数据目录 vs 配置目录）\n- 开发模式与生产模式并存\n\n### 方案\n\n#### 1.1 目录规划\n\n```\n开发目录（源码）:\n  G:/Workspace/AgentWorkSpace/AgentCraft/   # 持续开发\n\n运行时数据目录 (~/.actant/):\n  ~/.actant/\n  ├── config.json          # 全局配置\n  ├── data/\n  │   ├── templates/       # 用户模板\n  │   ├── agents/          # Agent 实例 workspace\n  │   └── sources/         # 缓存的 Source 内容\n  ├── logs/                # Daemon 日志\n  └── daemon.sock          # Daemon socket\n```\n\n#### 1.2 安装方式\n\n**方式 A — pnpm link（开发者推荐）：**\n```bash\n# 在项目根目录\npnpm build\npnpm --filter @actant/cli link --global\n\n# 验证\nactant --version\nactant help\n```\n\n**方式 B — npm global install（发布后）：**\n```bash\nnpm install -g actant\n```\n\n**方式 C — 脚本安装（便捷）：**\n提供 `scripts/install.sh`（Linux/macOS）和 `scripts/install.ps1`（Windows）：\n- 检查 Node.js >= 22、pnpm >= 9\n- `pnpm install && pnpm build`\n- `pnpm --filter @actant/cli link --global`\n- 创建 `~/.actant/` 目录结构\n- 验证安装成功\n\n#### 1.3 安装文档\n\n在 `docs/getting-started.md` 创建正式安装文档：\n- 前置依赖（Node.js 22+、pnpm 9+）\n- 三种安装方式的步骤说明\n- 首次运行引导（`actant daemon start` → `actant agent create`）\n- 目录结构说明\n- 常见问题（权限、PATH、socket 路径）\n\n### 验收标准 — Install\n\n- [ ] `scripts/install.ps1`（Windows）安装脚本可用\n- [ ] `scripts/install.sh`（Linux/macOS）安装脚本可用\n- [ ] 安装后 `actant` 全局命令可用\n- [ ] `docs/getting-started.md` 包含完整安装指南\n- [ ] `~/.actant/` 目录结构在首次运行时自动创建\n\n---\n\n## 二、Help 指令实现 (Help)\n\n### 问题\n\n当前 CLI 使用 commander 的默认 `-h/--help` 机制，缺少：\n- 顶层 `actant help` 子命令（不止 `--help` flag）\n- 分组展示命令（Agent 管理、组件管理、系统管理）\n- 常用 workflow 示例\n- 上下文感知的帮助（`actant help agent` 显示 agent 子命令的详细帮助）\n\n### 方案\n\n#### 2.1 `actant help` 顶层命令\n\n```\n$ actant help\n\n  Actant v0.1.0 — Build, manage, and compose AI agents\n\n  Quick Start:\n    actant daemon start              启动守护进程\n    actant agent create my-agent     创建 Agent\n    actant agent start my-agent      启动 Agent\n    actant agent chat my-agent       与 Agent 对话\n\n  Agent 管理:\n    agent create|start|stop|list|chat|run    管理 Agent 生命周期\n    template list|show                       管理 Agent 模板\n    proxy <name>                             ACP 代理转发\n\n  组件管理:\n    skill list|add|remove|show       管理技能定义\n    prompt list|add|remove|show      管理提示词\n    mcp list|show                    管理 MCP Server 配置\n    workflow list|show               管理工作流\n    plugin list|add|remove|show      管理插件\n\n  共享生态:\n    source list|add|remove|sync      管理组件来源\n    preset list|apply                管理预设包\n\n  调度:\n    schedule start|stop|status       管理雇员型 Agent 调度\n\n  系统:\n    daemon start|stop|status         Daemon 管理\n    help [command]                   查看帮助\n    --version                        显示版本号\n\n  Tips:\n    使用 actant help <command> 查看详细帮助\n    直接运行 actant 进入交互式 REPL 模式\n```\n\n#### 2.2 `actant help <command>` 子命令帮助\n\n```\n$ actant help agent\n\n  Agent 管理命令\n\n  actant agent create <name> [--template <tpl>]  创建新 Agent\n  actant agent start <name>                      启动 Agent\n  actant agent stop <name>                       停止 Agent\n  actant agent list                              列出所有 Agent\n  actant agent chat <name>                       进入交互对话\n  actant agent run <name> --prompt <text>         单次运行\n  actant agent dispatch <name> --input <data>     触发调度任务\n\n  示例:\n    actant agent create reviewer --template code-review-agent\n    actant agent start reviewer\n    actant agent chat reviewer\n```\n\n#### 2.3 实现方式\n\n在 `packages/cli/src/commands/help.ts` 创建 help 命令：\n- 使用 commander 的 `.helpInformation()` 获取各命令帮助文本\n- 自定义格式化输出（分组、着色、Quick Start）\n- `actant help` → 显示总览\n- `actant help <cmd>` → 显示特定命令的详细帮助\n- `actant help <cmd> <subcmd>` → 显示子命令帮助\n\n### 验收标准 — Help\n\n- [ ] `actant help` 显示分组的命令总览和 Quick Start\n- [ ] `actant help <command>` 显示特定命令的详细帮助和示例\n- [ ] help 输出包含 chalk 着色（终端友好）\n- [ ] 在 program.ts 中注册 help 命令\n\n---\n\n## 三、本地部署自更新机制 (Self-Update)\n\n### 问题\n\n用户在同一台机器上：\n- **开发**：持续在源码目录开发 Actant 新功能\n- **使用**：同时作为日常工具使用本地部署的 Actant 管理 Agent\n\n需要一个机制，让 AI（或用户自己）能：\n1. 将源码目录的最新代码编译并更新到已部署的版本\n2. 更新过程中保持已运行的 Agent 不中断（或优雅重启）\n3. 更新失败时能回滚\n\n### 方案\n\n#### 3.1 `actant self-update` 命令\n\n核心流程：\n```\nactant self-update [--source <path>] [--force]\n\n1. 检测源码目录（默认读取 ~/.actant/config.json 中的 devSourcePath）\n2. 在源码目录执行 pnpm build\n3. 备份当前已部署版本\n4. 重新 link 新版本\n5. 验证新版本可用（actant --version）\n6. 如果 Daemon 正在运行：\n   a. 通知已连接的 Agent 即将重启\n   b. 优雅停止 Daemon（graceful shutdown）\n   c. 重启 Daemon\n   d. 验证 Agent 恢复正常\n7. 如果验证失败，自动回滚到备份版本\n```\n\n#### 3.2 全局配置 `~/.actant/config.json`\n\n```json\n{\n  \"devSourcePath\": \"G:/Workspace/AgentWorkSpace/AgentCraft\",\n  \"autoUpdate\": false,\n  \"updateChannel\": \"local\",\n  \"backup\": {\n    \"enabled\": true,\n    \"maxBackups\": 3\n  }\n}\n```\n\n#### 3.3 更新策略 — Agent 保活\n\n```\n更新流程中的 Agent 保活策略:\n\n1. 预检查:\n   - 列出当前运行中的 Agent\n   - 检查是否有 Agent 处于活跃交互中（有 session）\n   - 如有活跃 session，警告用户并需 --force 确认\n\n2. 优雅重启 Daemon:\n   - Daemon 发送 SIGTERM → Agent 进程不受影响（Agent 是独立进程）\n   - Daemon 在 meta store 中记录所有 running Agent 的 PID\n   - 新 Daemon 启动后，通过 PID 重新 attach 已运行的 Agent\n   - 已有的 RestartTracker（#11）机制确保 Agent 恢复\n\n3. 回滚:\n   - 保留上一版本的编译产物备份\n   - 如果新版本 Daemon 启动失败，自动回滚\n   - 回滚后重新启动 Daemon\n```\n\n#### 3.4 AI 辅助更新工作流\n\n对于 AI 助手（如在 Cursor 中），更新流程可以是：\n```\n1. AI 完成代码修改\n2. AI 运行 pnpm test:changed 确保测试通过\n3. AI 运行 pnpm build 编译\n4. AI 运行 actant self-update --source . 更新本地部署\n5. AI 验证 actant daemon status 确认 Daemon 正常\n6. AI 验证已有 Agent 仍在运行\n```\n\n也可以在 `.cursor/commands/` 或 `.agents/skills/` 中封装为一个 skill/command。\n\n#### 3.5 版本追踪\n\n```typescript\n// actant self-update --check\n{\n  \"installed\": {\n    \"version\": \"0.1.0\",\n    \"buildTime\": \"2026-02-22T10:00:00Z\",\n    \"commitHash\": \"abc1234\"\n  },\n  \"source\": {\n    \"version\": \"0.1.0\",\n    \"commitHash\": \"def5678\",\n    \"dirty\": true,\n    \"ahead\": 3\n  },\n  \"needsUpdate\": true\n}\n```\n\n### 验收标准 — Self-Update\n\n- [ ] `~/.actant/config.json` 支持 `devSourcePath` 配置\n- [ ] `actant self-update` 命令实现完整更新流程\n- [ ] `actant self-update --check` 显示当前版本和源码版本对比\n- [ ] 更新前自动备份当前版本\n- [ ] Daemon 优雅重启后自动 reattach 运行中的 Agent\n- [ ] 更新失败时自动回滚\n- [ ] 提供 AI 辅助更新的 Cursor command 或 skill\n\n---\n\n## 实施优先级\n\n| 优先级 | 模块 | 内容 | 复杂度 |\n|--------|------|------|--------|\n| P0 | Install | 安装脚本 + 文档 + 目录结构初始化 | 低 |\n| P0 | Help | `actant help` 命令 + 分组展示 | 低 |\n| P1 | Self-Update | `actant self-update` 基础流程（build → link → verify） | 中 |\n| P1 | Self-Update | Daemon 优雅重启 + Agent reattach | 中 |\n| P2 | Self-Update | 备份/回滚机制 + 版本追踪 | 中 |\n| P2 | Self-Update | AI 辅助更新 skill/command 封装 | 低 |",
  "author": "human",
  "assignees": [],
  "relatedFiles": [
    "packages/cli/src/program.ts",
    "packages/cli/src/bin/actant.ts",
    "packages/cli/package.json",
    "packages/shared/src/platform/platform.ts",
    "packages/core/src/manager/agent-manager.ts",
    "packages/api/src/daemon/daemon.ts",
    "package.json"
  ],
  "relatedIssues": [34, 38],
  "taskRef": null,
  "githubRef": null,
  "closedAs": null,
  "comments": [],
  "createdAt": "2026-02-22T12:00:00",
  "updatedAt": "2026-02-22T12:00:00",
  "closedAt": null
}
