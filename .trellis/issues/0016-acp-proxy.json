{
  "id": 16,
  "title": "ACP Proxy — 标准 ACP 协议网关",
  "status": "open",
  "labels": [
    "acp",
    "feature",
    "protocol",
    "priority:P1"
  ],
  "milestone": "mid-term",
  "body": "## 目标\n\n实现 ACP Proxy（`agentcraft proxy`），使外部 ACP Client（IDE / Unreal / Unity）可以标准 ACP/stdio 协议接入 AgentCraft 托管的 Agent，无需了解 AgentCraft 内部实现。\n\n## 背景\n\nACP 是不对称协议（Client 提供环境，Agent 消费）。托管 Agent 的 ACP/stdio 连接已被 AgentCraft Daemon 占用。ACP Proxy 在外部客户端和 Daemon 之间搭建协议桥梁。\n\n从外部客户端视角：`agentcraft proxy` 就是一个标准 ACP Agent，配置方式与 `claude` / `cursor-agent` 完全相同。\n\n## 架构\n\n```\n外部 ACP Client\n    │  ACP / stdio\nagentcraft proxy --agent <name>\n    │  JSON-RPC / Unix Socket\nAgentCraft Daemon\n    │  ACP / stdio\n托管 Agent\n```\n\n## 两种模式\n\n### Workspace 隔离模式（默认）\n- Agent 环境请求在 AgentCraft workspace 内闭环\n- 外部客户端只发 prompt、收 response\n- 适用：纯任务委托\n\n### 环境穿透模式（--env-passthrough）\n- Agent 的 fs/readTextFile 等请求穿透回外部客户端\n- Agent 操作外部客户端的文件系统\n- 适用：远程 Agent 协作\n\n## 功能\n\n1. **ACP 握手翻译**：将 ACP initialize 映射为 proxy.connect RPC\n2. **会话消息转发**：将 ACP session/prompt 映射为 proxy.forward RPC\n3. **流式响应回传**：将 Daemon 流式响应转为 ACP session/update\n4. **环境穿透**（可选）：Agent 环境请求 → Daemon → Proxy → 外部客户端 → 回传\n5. **优雅断开**：Proxy 退出时调用 proxy.disconnect\n\n## 外部客户端配置示例\n\n```json\n{\n  \"agent\": {\n    \"command\": \"agentcraft\",\n    \"args\": [\"proxy\", \"--agent\", \"my-agent\"],\n    \"protocol\": \"acp/stdio\"\n  }\n}\n```\n\n## Daemon 侧新增\n\n- ProxySession 管理（连接状态、EnvChannel 路由）\n- proxy.connect / proxy.disconnect / proxy.forward / proxy.envCallback RPC 方法\n- EnvChannel: local | passthrough\n\n## 依赖\n\n- #9 LaunchMode 行为分化\n- #15 agent.resolve / attach / detach（Proxy 启动时可自动 resolve）\n- #12 ACP 协议集成（Daemon 侧 ACP Client 实现）\n\n## 验收\n\n- [ ] `agentcraft proxy <name>` 可启动，外部 ACP Client 可连接\n- [ ] ACP initialize → 正确返回能力声明\n- [ ] ACP session/prompt → 任务转发到 Agent → 响应回传\n- [ ] Workspace 隔离模式可用\n- [ ] 环境穿透模式可用\n- [ ] Proxy 退出时优雅断开\n- [ ] 集成测试覆盖两种模式",
  "author": "cursor-agent",
  "assignees": [],
  "relatedFiles": [
    "packages/cli/src/commands/",
    "packages/api/src/handlers/"
  ],
  "relatedIssues": [9, 12, 15],
  "taskRef": null,
  "githubRef": "blackplume233/AgentCraft#15",
  "closedAs": null,
  "comments": [],
  "createdAt": "2026-02-20T18:00:00",
  "updatedAt": "2026-02-20T18:00:00",
  "closedAt": null
}
