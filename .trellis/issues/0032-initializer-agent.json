{
  "id": 32,
  "title": "Initializer: 可扩展的 Agent 初始化流程框架",
  "status": "open",
  "labels": [
    "feature",
    "priority:P1"
  ],
  "milestone": "mid-term",
  "body": "## 目标\n\n实现一个可扩展、可配置的 **Initializer** 框架，在 Agent 物化（materialization）阶段执行自定义初始化流程。\n\n## 背景\n\n当前 `AgentInitializer` 只完成基础工作：\n1. 创建 workspace 目录\n2. 物化 Domain Context（skills → AGENTS.md, mcpServers → mcp.json 等）\n3. 写入 .agentcraft.json\n\n但配置中已定义了 `InitializerConfig` 结构，支持声明初始化步骤：\n```typescript\ninterface InitializerConfig {\n  steps: InitializerStep[];\n}\n\ninterface InitializerStep {\n  type: string;\n  config?: Record<string, unknown>;\n}\n```\n\n这些步骤目前**未被实际执行**。\n\n## 参考：Trellis 工作流模式\n\nTrellis 使用 `.trellis/workflow.md` 定义开发流程，包含：\n- 阶段（phase）划分\n- 每个阶段的任务清单\n- 可重复的步骤执行\n\nInitializer 应借鉴此模式，提供**声明式 + 可编程**的初始化能力。\n\n## 需求\n\n### 1. InitializerStep 基类设计\n\n```typescript\nabstract class InitializerStepExecutor {\n  readonly type: string;\n  \n  // 验证配置是否合法\n  abstract validate(config: unknown): ValidationResult;\n  \n  // 执行步骤\n  abstract execute(\n    context: StepContext,\n    config: unknown\n  ): Promise<StepResult>;\n  \n  // 可选：回滚（失败时调用）\n  rollback?(\n    context: StepContext,\n    config: unknown,\n    error: Error\n  ): Promise<void>;\n}\n\ninterface StepContext {\n  workspaceDir: string;\n  instanceMeta: AgentInstanceMeta;\n  template: AgentTemplate;\n  logger: Logger;\n  // 步骤间共享数据\n  state: Map<string, unknown>;\n}\n\ninterface StepResult {\n  success: boolean;\n  // 输出到下一步的数据\n  output?: Record<string, unknown>;\n  // 用户可见的消息\n  message?: string;\n}\n```\n\n### 2. 内置步骤实现\n\n参考 Trellis 的常见初始化场景：\n\n| 步骤类型 | 用途 | 配置示例 |\n|---------|------|---------|\n| `git-clone` | 克隆代码仓库 | `{ repo: \"https://...\", branch?: \"main\", depth?: 1 }` |\n| `git-init` | 初始化新仓库 | `{ initialBranch?: \"main\" }` |\n| `npm-install` | 安装 Node 依赖 | `{ registry?: \"...\", args?: [\"--frozen-lockfile\"] }` |\n| `file-copy` | 复制模板文件 | `{ from: \"./templates/config\", to: \"./config\" }` |\n| `file-template` | 渲染模板文件 | `{ template: \"...\", output: \"./.env\", variables: {...} }` |\n| `exec` | 执行任意命令 | `{ command: \"make\", args: [\"setup\"] }` |\n| `mkdir` | 创建目录结构 | `{ paths: [\"./logs\", \"./temp\"] }` |\n| `write-file` | 写入文件 | `{ path: \"./README.md\", content: \"...\" }` |\n\n### 3. 执行引擎\n\n```typescript\nclass InitializationPipeline {\n  constructor(\n    private stepRegistry: StepRegistry,\n    private options?: PipelineOptions\n  );\n  \n  async run(\n    steps: InitializerStep[],\n    context: StepContext\n  ): Promise<PipelineResult>;\n  \n  // 支持 dry-run 模式\n  async dryRun(steps: InitializerStep[]): Promise<ValidationResult[]>;\n  \n  // 失败策略\n  private handleFailure(\n    failedStep: InitializerStep,\n    error: Error,\n    executedSteps: ExecutedStep[]\n  ): Promise<void>;\n}\n```\n\n**执行特性：**\n- 顺序执行（步骤间有依赖关系）\n- 事务性：失败时回滚已执行的步骤（如删除已 clone 的目录）\n- 幂等性检测：支持标记步骤为幂等，中断后可安全重试\n- 超时控制：每个步骤可配置超时\n- 进度报告：回调或事件通知执行进度\n\n### 4. 集成点\n\n修改 `AgentInitializer.createInstance()`：\n\n```typescript\nasync createInstance(...) {\n  // ... 现有代码 ...\n  \n  // 执行初始化步骤（如果有）\n  if (template.initializer?.steps) {\n    const pipeline = new InitializationPipeline(this.stepRegistry);\n    const result = await pipeline.run(template.initializer.steps, {\n      workspaceDir,\n      instanceMeta: meta,\n      template,\n      logger,\n      state: new Map(),\n    });\n    \n    if (!result.success) {\n      // 清理 workspace 并抛出错误\n      await this.cleanup(workspaceDir);\n      throw new InitializationError(result.errors);\n    }\n  }\n  \n  return meta;\n}\n```\n\n### 5. 配置验证\n\n在 `template validate` 时预检初始化配置：\n- 所有步骤类型是否已注册\n- 配置是否符合步骤的 schema\n- 检测循环依赖（如果未来支持步骤依赖图）\n\n## 验收标准\n\n- [ ] `InitializerStepExecutor` 抽象基类\n- [ ] `InitializationPipeline` 执行引擎（支持顺序执行、失败回滚、超时）\n- [ ] 至少 5 个内置步骤实现（git-clone, npm-install, file-copy, exec, mkdir）\n- [ ] 步骤注册机制（支持用户扩展自定义步骤）\n- [ ] 集成到 `AgentInitializer`，在创建实例时自动执行\n- [ ] `template validate` 支持预检初始化配置\n- [ ] 完整的单元测试覆盖\n- [ ] 文档和配置示例\n\n## 设计原则\n\n1. **可扩展性**：通过注册机制支持自定义步骤，不修改核心代码\n2. **可配置性**：所有行为通过声明式配置控制\n3. **可观测性**：详细的日志、进度回调、执行报告\n4. **安全性**：超时控制、资源限制、敏感信息（如 token）不直接暴露在配置中\n5. **故障恢复**：失败回滚、幂等重试\n\n## 参考文档\n\n- 当前实现：`packages/core/src/initializer/`\n- Trellis Workflow：`.trellis/workflow.md`\n- 配置规范：`.trellis/spec/config-spec.md` §5 InitializerConfig",
  "author": "cursor-agent",
  "assignees": [],
  "relatedFiles": [],
  "relatedIssues": [],
  "taskRef": null,
  "githubRef": null,
  "closedAs": null,
  "comments": [],
  "createdAt": "2026-02-20T16:18:19",
  "updatedAt": "2026-02-20T16:18:19",
  "closedAt": null
}
