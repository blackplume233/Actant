{
  "id": 30,
  "title": "detachAgent cleanup 测试断言与实现语义不匹配 — 1 个单元测试持续失败",
  "status": "closed",
  "labels": [
    "core",
    "priority:P1",
    "quality",
    "review"
  ],
  "milestone": null,
  "body": "## 审查发现\n\n`packages/core/src/manager/agent-manager.test.ts` 中的 `detachAgent with cleanup should destroy the agent` 测试**持续失败**。\n\n## 证据\n\n**失败输出：**\n```\nexpect(manager.getAgent(\"cleanup-agent\")).toBeUndefined();\n// 实际返回了 { status: \"stopped\", workspacePolicy: \"persistent\", ... }\n```\n\n**根因分析：**\n\n1. 测试代码（第 518-524 行）：创建 agent → attach → detachAgent(name, { cleanup: true }) → 期望 getAgent 返回 undefined\n2. 实现代码（`agent-manager.ts` 第 326 行）：`if (options?.cleanup && meta.workspacePolicy === \"ephemeral\")` — cleanup 仅在 ephemeral workspace 时触发 destroy\n3. 测试创建的 agent 默认 `workspacePolicy: \"persistent\"`，所以 cleanup 条件不满足，agent 不会被销毁\n\n**spec 对照：** Issue #15 验收条件写「detach cleanup 删除 ephemeral workspace」，代码行为与 spec 一致，**测试断言不符合 spec 语义**。\n\n## 建议\n\n修复测试：在 cleanup 测试中创建 ephemeral workspace 的 agent：\n```typescript\nawait manager.createAgent(\"cleanup-agent\", \"test-tpl\", { workspacePolicy: \"ephemeral\" });\n```\n或拆为两个测试：persistent 不删除 + ephemeral 删除。",
  "author": "cursor-agent",
  "assignees": [],
  "relatedFiles": [],
  "relatedIssues": [],
  "taskRef": null,
  "githubRef": "blackplume233/Actant#35",
  "closedAs": "completed",
  "comments": [
    {
      "text": "Closed as completed",
      "date": "2026-02-20T15:50:23",
      "author": "cursor-agent"
    }
  ],
  "createdAt": "2026-02-20T15:08:43",
  "updatedAt": "2026-02-20T15:50:23",
  "closedAt": "2026-02-20T15:50:23"
}
