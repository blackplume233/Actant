{
  "id": 24,
  "title": "core 包 type-check 失败 — 测试与源码类型错误阻塞质量门禁",
  "status": "closed",
  "labels": [
    "core",
    "priority:P1",
    "quality",
    "review"
  ],
  "milestone": null,
  "body": "## 审查发现\n\n在「深度审查所有测试用例实现」中执行 `pnpm run type-check` 时，**packages/core** 报错，导致全仓库 type-check 失败，阻塞 CI/质量门禁。\n\n## 证据\n\n`pnpm run type-check` 在 core 包内报出：\n\n1. **agent-manager.test.ts:403** — TS6133: `pid` is declared but its value is never read.\n2. **launch-mode-handler.test.ts:84–87** — TS2532: Object is possibly 'undefined'（`handlers[0]` 等数组访问未做存在性检查）。\n3. **process-watcher.test.ts** — 多处 TS2345: `Mock<Procedure | Constructable>` 不能赋值给 `ProcessExitHandler`（`vi.fn<...>()` 的返回类型与 `(info: ProcessExitInfo) => void | Promise<void>` 不兼容）。\n4. **instance-meta-io.ts:50,52** — TS2339/TS2352: `processOwnership` 不存在于 `AgentInstanceMeta`，且类型转换不安全（**源码问题**，非仅测试）。\n\n## 建议\n\n- **agent-manager.test.ts**：删除未使用的 `pid` 变量或改为 `void pid` / 在断言中使用。\n- **launch-mode-handler.test.ts**：对 `handlers[0]` 等使用非空断言或 `expect(handlers[i]).toBeDefined()` 后访问，或使用 `handlers[0]!` 并加注释说明 map 长度已知。\n- **process-watcher.test.ts**：将 `exitHandler` 显式类型为 `ProcessExitHandler` 或 `vi.fn<ProcessExitHandler>()`，或使用类型断言 `as ProcessExitHandler` 以通过类型检查。\n- **instance-meta-io.ts**：对照 `AgentInstanceMeta` 类型定义（如 `packages/shared/src/types/agent.types.ts`）修正 `processOwnership` 的读写或从 meta 类型中补充该字段并在 instance-meta-schema 中同步。\n\n修复后应保证 `pnpm run type-check` 全绿。",
  "author": "cursor-agent",
  "assignees": [],
  "relatedFiles": [],
  "relatedIssues": [],
  "taskRef": null,
  "githubRef": null,
  "closedAs": "completed",
  "comments": [
    {
      "text": "[Review 更严格] instance-meta-io 修复建议：不要用 `as AgentInstanceMeta` 和 `Record<string, unknown> & { processOwnership?: ... }` 的 cast；应基于 schema 的 result.data 推断类型并补全默认值（backendType/processOwnership），或为 Zod 的 output 类型与 AgentInstanceMeta 建单一映射，避免手写 cast 与类型不同步。",
      "date": "2026-02-20T13:19:16",
      "author": "cursor-agent"
    },
    {
      "text": "[Review 2026-02-20] type-check 状态更新：执行 pnpm build 后，原先 7 个错误减至 4 个。原因是 shared 包 dist 过期导致 WorkspacePolicy/DetachResult 找不到。build 后剩余错误全部来自 AgentInstanceMeta 接口 vs Zod Schema 的 required/optional 不同步（workspacePolicy/processOwnership），已创建 #31 跟踪。",
      "date": "2026-02-20T15:09:06",
      "author": "cursor-agent"
    },
    {
      "text": "Closed as completed",
      "date": "2026-02-20T15:50:22",
      "author": "cursor-agent"
    }
  ],
  "createdAt": "2026-02-20T13:16:54",
  "updatedAt": "2026-02-20T15:50:22",
  "closedAt": "2026-02-20T15:50:22"
}
