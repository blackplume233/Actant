{
  "id": 33,
  "title": "Template: 耐久测试专用 Agent 配置 (Endurance Test Agent)",
  "status": "open",
  "labels": [
    "feature",
    "priority:P2"
  ],
  "milestone": "near-term",
  "body": "## 目标\n\n创建一个专门用于执行**耐久测试**（Endurance Testing）的 Agent Template，配置使用 `claude-code` 作为后端，使用默认模型提供者，能够自动化运行项目的耐久测试套件。\n\n## 背景\n\nAgentCraft 已经建立了完整的耐久测试规范（`.trellis/spec/endurance-testing.md`），包含 6 个 Phase 1 场景和多个验证不变量。目前这些测试需要手动执行：\n\n```bash\n# 快速回归\nENDURANCE_DURATION_MS=5000 pnpm test:endurance\n\n# 发版前完整验证\nENDURANCE_DURATION_MS=600000 pnpm test:endurance\n```\n\n需要一个**专用的 Agent** 来自动化执行这些测试、分析结果并生成报告。\n\n## 需求\n\n### 1. Agent Template 配置\n\n创建 `configs/templates/endurance-tester.json`：\n\n```json\n{\n  \"name\": \"endurance-tester\",\n  \"version\": \"1.0.0\",\n  \"description\": \"专门用于执行 AgentCraft 耐久测试的 Agent，自动运行测试、分析结果、生成报告\",\n  \"backend\": {\n    \"type\": \"claude-code\",\n    \"config\": {}\n  },\n  \"provider\": {\n    \"type\": \"anthropic\",\n    \"config\": {\n      \"model\": \"claude-3-5-sonnet-20241022\"\n    }\n  },\n  \"domainContext\": {\n    \"skills\": [\n      \"endurance-test-executor\",\n      \"test-result-analyzer\",\n      \"performance-regression-detector\"\n    ],\n    \"prompts\": [\n      \"endurance-tester-system\",\n      \"test-report-generator\"\n    ],\n    \"mcpServers\": [\n      {\n        \"name\": \"filesystem\",\n        \"command\": \"npx\",\n        \"args\": [\"-y\", \"@modelcontextprotocol/server-filesystem\", \"/workspace\"]\n      }\n    ],\n    \"workflow\": \"endurance-test-workflow\"\n  },\n  \"initializer\": {\n    \"steps\": [\n      { \"type\": \"git-init\" },\n      { \"type\": \"npm-install\" },\n      { \"type\": \"exec\", \"config\": { \"command\": \"pnpm\", \"args\": [\"build\"] } }\n    ]\n  },\n  \"metadata\": {\n    \"purpose\": \"endurance-testing\",\n    \"team\": \"platform\",\n    \"category\": \"testing\"\n  }\n}\n```\n\n### 2. 需要创建的配套资源\n\n#### Skills（放在 `configs/skills/`）\n\n**skill: endurance-test-executor**\n```markdown\n# Endurance Test Executor\n\n执行 AgentCraft 耐久测试套件。\n\n## 能力\n- 运行快速回归测试（5s）\n- 运行完整耐久测试（10min）\n- 运行深度浸泡测试（1h+）\n- 并行执行多个场景\n\n## 命令\n- `pnpm test:endurance` - 默认 30s 测试\n- `ENDURANCE_DURATION_MS=5000 pnpm test:endurance` - 快速回归\n- `ENDURANCE_DURATION_MS=600000 pnpm test:endurance` - 完整验证\n```\n\n**skill: test-result-analyzer**\n```markdown\n# Test Result Analyzer\n\n分析耐久测试结果，识别问题模式。\n\n## 分析维度\n1. 失败场景识别（E-LIFE, E-SVC, E-SHOT 等）\n2. 不变量违反检测（INV-DISK, INV-CLEAN, INV-STATUS 等）\n3. 性能退化检测（操作计数趋势）\n4. 错误分类（状态机错误、资源泄漏、进程残留）\n```\n\n**skill: performance-regression-detector**\n```markdown\n# Performance Regression Detector\n\n检测耐久测试中的性能退化。\n\n## 检测指标\n- 操作吞吐量（ops/ms）\n- 内存使用趋势\n- 进程启动时间\n- 状态转换延迟\n\n## 基线对比\n- 与历史测试记录对比\n- 阈值告警（下降 > 20%）\n```\n\n#### Prompts（放在 `configs/prompts/`）\n\n**prompt: endurance-tester-system**\n```markdown\n你是一个专门的耐久测试工程师 Agent。你的任务是自动化执行 AgentCraft 的耐久测试套件，确保系统在长期运行下的稳定性和正确性。\n\n## 核心职责\n1. 执行耐久测试（快速回归、完整验证、深度浸泡）\n2. 分析测试结果，识别失败模式和性能退化\n3. 生成结构化的测试报告\n4. 对发现的问题进行分类和优先级排序\n\n## 耐久测试场景（Phase 1）\n- E-LIFE: 完整生命周期循环\n- E-SVC: acp-service 崩溃重启\n- E-SHOT: one-shot 执行与清理\n- E-EXT: 外部 Spawn 完整流程\n- E-DAEMON: Daemon 重启恢复\n- E-MIX: 混合并发操作\n\n## 不变量检查\n- INV-DISK: 磁盘/缓存一致性\n- INV-CLEAN: 资源清理完整性\n- INV-STATUS: 状态值合法性\n- INV-COUNT: 缓存计数准确性\n- INV-PID: PID 无残留\n- INV-OWNER: 所有权正确性\n\n## 输出格式\n所有测试报告使用以下结构：\n```yaml\ntest_run:\n  timestamp: ISO8601\n  duration_ms: number\n  scenarios_tested: string[]\nresults:\n  passed: number\n  failed: number\n  errors: []\nperformance:\n  baseline_comparison: {}\nregressions_detected: []\nrecommendations: []\n```\n```\n\n**prompt: test-report-generator**\n```markdown\n生成耐久测试报告的详细指南。\n\n## 报告结构\n1. 执行摘要（通过/失败状态）\n2. 场景覆盖详情\n3. 不变量验证结果\n4. 性能指标趋势\n5. 发现的 issues\n6. 修复建议\n\n## 优先级分类\n- P0: 状态机错误、数据丢失风险\n- P1: 资源泄漏、性能显著退化\n- P2: 边缘 case 失败、轻微性能下降\n- P3: 建议优化项\n```\n\n#### Workflow（放在 `configs/workflows/`）\n\n**workflow: endurance-test-workflow**\n```markdown\n# Endurance Test Workflow\n\n## Phase 1: 环境准备\n- [ ] 检查 Node.js 版本 (>= 22)\n- [ ] 检查 pnpm 版本 (>= 9)\n- [ ] 安装依赖 `pnpm install`\n- [ ] 构建项目 `pnpm build`\n\n## Phase 2: 快速回归\n- [ ] 运行 5s 快速耐久测试\n- [ ] 验证所有 Phase 1 场景通过\n- [ ] 检查 6 个不变量\n\n## Phase 3: 完整验证（可选）\n- [ ] 运行 10 分钟耐久测试\n- [ ] 收集性能基线数据\n- [ ] 对比历史趋势\n\n## Phase 4: 报告生成\n- [ ] 汇总测试结果\n- [ ] 识别失败模式\n- [ ] 生成 YAML 格式报告\n- [ ] 输出到 `.trellis/reports/endurance-{timestamp}.md`\n```\n\n### 3. 初始化器步骤依赖\n\n此 Template 依赖 Issue #32（Initializer 框架）完成后才能完全工作：\n- `git-init`: 初始化 workspace\n- `npm-install`: 安装依赖\n- `exec`: 执行构建命令\n\n在 #32 完成前，可以使用以下 workaround：\n\n```bash\n# 手动创建实例并初始化\nagentcraft agent create --template endurance-tester --id tester-1\ncd ~/.agentcraft/instances/tester-1\npnpm install\npnpm build\n```\n\n### 4. Agent 使用方式\n\n#### One-shot 模式（CI 集成）\n```bash\nagentcraft agent start tester-1 --mode one-shot --task \"run-quick-regression\"\n```\n\n#### Service 模式（长期监控）\n```bash\nagentcraft agent start tester-1 --mode acp-service\n# 然后定期通过 ACP 调用执行测试\n```\n\n## 验收标准\n\n- [ ] `configs/templates/endurance-tester.json` 模板文件\n- [ ] `configs/skills/endurance-test-executor.md` Skill 定义\n- [ ] `configs/skills/test-result-analyzer.md` Skill 定义\n- [ ] `configs/skills/performance-regression-detector.md` Skill 定义\n- [ ] `configs/prompts/endurance-tester-system.md` Prompt 定义\n- [ ] `configs/prompts/test-report-generator.md` Prompt 定义\n- [ ] `configs/workflows/endurance-test-workflow.md` Workflow 定义\n- [ ] 模板通过验证 `agentcraft template validate`\n- [ ] 可成功创建实例 `agentcraft agent create --template endurance-tester`\n- [ ] 文档：使用指南和示例报告\n\n## 依赖\n\n- Issue #32: Initializer 框架（用于自动执行 `pnpm install` 和 `pnpm build`）\n- 可选：Template hot-reload（Issue #5）可简化配置迭代\n\n## 关联文档\n\n- `.trellis/spec/endurance-testing.md` - 耐久测试规范\n- `.trellis/spec/config-spec.md` - 配置规范",
  "author": "cursor-agent",
  "assignees": [],
  "relatedFiles": [],
  "relatedIssues": [],
  "taskRef": null,
  "githubRef": null,
  "closedAs": null,
  "comments": [],
  "createdAt": "2026-02-20T16:20:26",
  "updatedAt": "2026-02-20T16:20:26",
  "closedAt": null
}
