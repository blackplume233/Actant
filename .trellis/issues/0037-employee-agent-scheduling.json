{
  "id": 37,
  "title": "雇员型 Agent — 持续调度与主动行为系统",
  "status": "open",
  "labels": [
    "feature",
    "architecture",
    "acp",
    "priority:P1"
  ],
  "milestone": "mid-term",
  "body": "## 目标\n\n实现雇员型 Agent 的持续调度能力，使 Daemon 能够像管理员工一样管理长驻 Agent——不仅保持进程存活，还能主动派发任务、响应事件、定时执行。\n\n**核心差异**：当前 `acp-service` 模式只做了「保活」（崩溃重启），但雇员型 Agent 需要「保活 + 调度 + 主动行为」。\n\n## 参考：OpenClaw 的输入系统\n\nOpenClaw 的核心设计洞察是 **将 Time 和 State 视为 Input**，使 Agent 具备主动行为而非仅仅被动响应。它定义了六种输入类型：\n\n| 输入类型 | 说明 | AgentCraft 对应 |\n|----------|------|----------------|\n| **Messages** | 人类通过各渠道发送的消息 | `agent.prompt` / `agent chat` |\n| **Heartbeats** | 定时器（默认 30 分钟）提示 Agent \"检查是否有待办任务\" | **新增：HeartbeatInput** |\n| **Cron Jobs** | 按 cron 表达式定时触发，带具体指令 | **新增：CronInput** |\n| **Hooks** | 内部状态变更触发（系统启动、任务完成等） | **新增：HookInput** |\n| **Webhooks** | 外部系统通知（GitHub PR、Jira ticket 等） | **新增：WebhookInput** |\n| **Agent-to-Agent** | Agent 间消息传递，协作完成任务 | MCP Server (#17) |\n\nOpenClaw 的关键设计：\n- Hub-and-Spoke 架构：Gateway 做连接管理和消息路由，不做推理\n- Lane Queue：每个 session 串行执行（一个 prompt 完成才发下一个）\n- SOUL.md / AGENTS.md / TOOLS.md：agent 配置与能力声明（AgentCraft 已有类似设计）\n- Memory 分层：Context（临时，token 窗口内） vs Memory（持久，磁盘存储）\n- Debounced Indexing：批量写入避免频繁索引\n\n## 架构设计\n\n### 雇员型 Agent 连接模型\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│  AgentCraft Daemon                                          │\n│                                                             │\n│  ┌─── Input Router ───────────────────────────────────────┐ │\n│  │                                                         │ │\n│  │  ┌────────────┐  ┌───────────┐  ┌──────────────────┐  │ │\n│  │  │ Heartbeat  │  │ Cron      │  │ Webhook          │  │ │\n│  │  │ Timer      │  │ Scheduler │  │ Receiver         │  │ │\n│  │  │ (30min)    │  │ (crontab) │  │ (HTTP endpoint)  │  │ │\n│  │  └─────┬──────┘  └─────┬─────┘  └────────┬─────────┘  │ │\n│  │        │               │                  │            │ │\n│  │        ▼               ▼                  ▼            │ │\n│  │  ┌──────────────────────────────────────────────────┐  │ │\n│  │  │           Task Queue (per agent, serial)         │  │ │\n│  │  │  [heartbeat] [cron:email] [webhook:pr-42] [hook] │  │ │\n│  │  └──────────────────────┬───────────────────────────┘  │ │\n│  │                         │                              │ │\n│  │                    dequeue → dispatch                   │ │\n│  └─────────────────────────┼──────────────────────────────┘ │\n│                            │                                │\n│                            ▼                                │\n│  ┌─── AcpConnection ─────────────────────────────────────┐ │\n│  │  prompt(sessionId, taskPrompt)                         │ │\n│  │  ← sessionUpdate (streaming)                           │ │\n│  │  → execution log                                       │ │\n│  └─────────────────────────┬─────────────────────────────┘ │\n│                            │ ACP / stdio                    │\n└────────────────────────────┼────────────────────────────────┘\n                             ▼\n                      ┌──────────────┐\n                      │ Agent 子进程  │  cwd = agent workspace\n                      │ (长驻运行)    │  domain context 完整\n                      └──────────────┘\n```\n\n### 与工具型 Agent 的对比\n\n| 维度 | 工具型 (#35) | 雇员型 (本 issue) |\n|------|------------|------------------|\n| AcpConnection 归属 | Proxy/Chat CLI | **Daemon** |\n| 进程生命周期 | 跟随连接 | **长驻，Daemon 管理** |\n| 驱动方 | 人类（IDE/Chat） | **Daemon 调度器** |\n| 输入来源 | 人类 prompt | Heartbeat / Cron / Webhook / Hook / Agent-to-Agent / 人类 |\n| cwd | agent workspace | agent workspace |\n| launchMode | interactive / acp-background | **acp-service** |\n| processOwnership | external | **managed** |\n\n两种类型共存，不需要 ACP Gateway。\n\n## 输入系统设计\n\n### 1. Heartbeat — 主动检查\n\n定时提示 Agent 检查是否有待办事项。这是雇员型 Agent \"活力感\" 的核心来源。\n\n```typescript\ninterface HeartbeatConfig {\n  enabled: boolean;\n  intervalMs: number;         // 默认 30 分钟\n  prompt: string;             // \"检查是否有待处理的任务\"\n  suppressNoAction: boolean;  // Agent 无操作时不记录\n}\n```\n\n行为：\n- 每隔 `intervalMs` 发送 heartbeat prompt\n- Agent 检查环境状态（文件变更、pending tasks 等）\n- 如果 Agent 回复 \"无需操作\"，可选择静默（suppressNoAction）\n- 如果 Agent 发现需要处理的事项，正常执行\n\n### 2. Cron — 定时任务\n\n按 cron 表达式定时触发，带具体指令。\n\n```typescript\ninterface CronConfig {\n  schedule: string;           // cron 表达式: \"0 9 * * 1-5\"\n  prompt: string;             // \"检查邮件并汇总重要事项\"\n  label?: string;             // 任务标签: \"morning-email\"\n  timezone?: string;          // 时区\n}\n```\n\n示例场景：\n- `\"0 9 * * 1-5\"`: 工作日早 9 点检查邮件\n- `\"0 */4 * * *\"`: 每 4 小时巡检代码仓库\n- `\"0 18 * * 5\"`: 每周五下午 6 点生成周报\n\n### 3. Hook — 内部事件触发\n\n内部状态变更触发 Agent 行动。\n\n```typescript\ninterface HookConfig {\n  event: HookEvent;\n  prompt: string;\n}\n\ntype HookEvent =\n  | \"agent:started\"         // Agent 进程启动完成\n  | \"agent:recovered\"       // 崩溃重启恢复\n  | \"task:completed\"        // 上一个任务完成\n  | \"task:failed\"           // 上一个任务失败\n  | \"memory:updated\"        // 记忆系统更新（future）\n  | \"agent:idle\"            // Agent 空闲超过阈值\n```\n\n### 4. Webhook — 外部事件触发\n\n外部系统通过 HTTP 通知 Agent。\n\n```typescript\ninterface WebhookConfig {\n  path: string;              // \"/agents/:name/webhook/:event\"\n  secret?: string;           // HMAC 验证\n  promptTemplate: string;    // \"处理 GitHub event: {{payload}}\"\n}\n```\n\n示例：\n- GitHub Push → Agent 自动 code review\n- Jira Ticket Created → Agent 分析并回复\n- Slack @mention → Agent 响应团队问题\n\n### 5. Agent-to-Agent — 协作\n\n通过 MCP Server (#17) 实现，Agent A 完成任务后可派发给 Agent B。\n\n## Task Queue 设计\n\n### 串行执行（参考 OpenClaw Lane Queue）\n\nACP session 是串行的——一个 prompt 响应完才能发下一个。Task Queue 保证执行顺序：\n\n```typescript\ninterface TaskQueue {\n  enqueue(task: AgentTask): void;\n  dequeue(): AgentTask | undefined;\n  peek(): AgentTask | undefined;\n  size: number;\n  isProcessing: boolean;\n}\n\ninterface AgentTask {\n  id: string;\n  source: \"heartbeat\" | \"cron\" | \"hook\" | \"webhook\" | \"prompt\" | \"agent\";\n  prompt: string;\n  priority: number;           // 0 = 最高\n  createdAt: string;\n  metadata?: Record<string, unknown>;\n}\n```\n\n### 执行流程\n\n```\n1. Input 到达（heartbeat/cron/webhook/prompt）\n2. 创建 AgentTask，入队\n3. 如果 Agent 空闲 → 立即 dequeue + dispatch\n4. 如果 Agent 忙碌 → 等待当前任务完成\n5. dispatch: acpConnection.prompt(sessionId, task.prompt)\n6. 收集 sessionUpdate → 记录执行日志\n7. 完成 → 触发 task:completed hook → dequeue 下一个\n8. 失败 → 触发 task:failed hook → 可选重试\n```\n\n### 优先级\n\n- 人类 prompt（`agent.prompt` RPC）> Webhook > Cron > Heartbeat\n- 高优先级任务可插队（enqueue 到队首）\n\n## 可观测性\n\n### Execution Log\n\n每次任务执行记录：\n\n```typescript\ninterface ExecutionRecord {\n  taskId: string;\n  agentName: string;\n  source: string;\n  prompt: string;\n  startedAt: string;\n  completedAt?: string;\n  status: \"running\" | \"completed\" | \"failed\" | \"cancelled\";\n  responseText?: string;\n  toolCalls?: string[];\n  durationMs?: number;\n}\n```\n\n### 观察命令\n\n```bash\nagentcraft agent logs my-employee           # 查看历史执行日志\nagentcraft agent watch my-employee          # 实时订阅 sessionUpdate 流\nagentcraft agent tasks my-employee          # 查看任务队列状态\nagentcraft agent dispatch my-employee \"...\" # 手动派发任务\n```\n\n### Notification Stream\n\nDaemon 通过 RPC stream 或 Unix socket 向观察者推送实时通知。观察者是只读的，不参与 ACP 协议。\n\n## 模板配置\n\n在 AgentTemplate 中新增 `schedule` 字段：\n\n```json\n{\n  \"name\": \"pr-reviewer\",\n  \"backendType\": \"claude-code\",\n  \"launchMode\": \"acp-service\",\n  \"schedule\": {\n    \"heartbeat\": {\n      \"enabled\": true,\n      \"intervalMs\": 1800000,\n      \"prompt\": \"检查是否有新的 PR 需要审查\",\n      \"suppressNoAction\": true\n    },\n    \"cron\": [\n      {\n        \"schedule\": \"0 9 * * 1-5\",\n        \"prompt\": \"生成昨日代码审查报告\",\n        \"label\": \"daily-report\"\n      }\n    ],\n    \"webhooks\": [\n      {\n        \"path\": \"/webhook/github\",\n        \"promptTemplate\": \"GitHub 事件: {{event}} - {{payload.action}} on {{payload.repository.full_name}}\"\n      }\n    ],\n    \"hooks\": [\n      {\n        \"event\": \"agent:started\",\n        \"prompt\": \"你已启动。检查待处理事项并向我汇报。\"\n      }\n    ]\n  },\n  \"domainContext\": {\n    \"skills\": [\"code-review\", \"github-integration\"],\n    \"prompts\": [\"pr-reviewer-system\"],\n    \"mcpServers\": [\"github-mcp\"]\n  }\n}\n```\n\n## 实现计划\n\n### Phase 1: Task Queue + Dispatch 基础\n\n1. **`packages/core/src/scheduler/task-queue.ts`**（新增）— 串行任务队列\n2. **`packages/core/src/scheduler/task-dispatcher.ts`**（新增）— 任务派发器\n3. **`packages/core/src/manager/agent-manager.ts`**（修改）— 集成 dispatcher\n4. **CLI: `agent dispatch <name> \"prompt\"`**（新增）— 手动派发\n\n### Phase 2: 输入系统\n\n1. **`packages/core/src/scheduler/inputs/heartbeat-input.ts`**（新增）\n2. **`packages/core/src/scheduler/inputs/cron-input.ts`**（新增）\n3. **`packages/core/src/scheduler/inputs/hook-input.ts`**（新增）\n4. **`packages/core/src/scheduler/inputs/input-router.ts`**（新增）— 统一路由\n5. 模板 schema 扩展 `schedule` 字段\n\n### Phase 3: Webhook + 可观测性\n\n1. **`packages/api/src/http/webhook-server.ts`**（新增）— HTTP webhook 接收\n2. **`packages/core/src/scheduler/execution-log.ts`**（新增）— 执行日志\n3. **CLI: `agent logs` / `agent watch` / `agent tasks`**（新增）\n4. RPC stream 通知推送\n\n### Phase 4: 与 Memory 集成（依赖 #1/#2）\n\n- Agent 执行结果持久化到 Memory\n- Heartbeat 检查包含 Memory 上下文\n- Daily summary 自动写入 Memory\n\n## 依赖\n\n| 依赖 | 状态 | 说明 |\n|------|------|------|\n| #11 acp-service 崩溃重启 | ✅ 完成 | 进程保活基础 |\n| #12 Daemon ↔ Agent 通信 | ✅ 完成 | AcpConnection 基础 |\n| #13 Plugin 体系 | 待开始 | Heartbeat/Scheduler 可作为 Plugin |\n| #17 MCP Server | 待开始 | Agent-to-Agent 通信 |\n| #1/#2 Memory 系统 | 待开始 | Phase 4 依赖 |\n\n## 与 #13 Plugin 体系的关系\n\n#13 定义了 Plugin 接口（onStart / onStop / onTick）和 HeartbeatMonitor。本 issue 的输入系统可以实现为 Plugin：\n\n- HeartbeatInput → HeartbeatMonitor plugin 的扩展\n- CronInput → Scheduler plugin\n- 如果 #13 先实现 Plugin 接口，本 issue 的各 Input 可作为 Plugin 注册\n- 如果本 issue 先实现，可后续重构为 Plugin 形态\n\n建议：本 issue 先实现核心调度能力（不依赖 Plugin 接口），#13 后续提供 Plugin 化的重构路径。\n\n## 验收标准\n\n- [ ] Daemon 可持续调度 acp-service 模式的 Agent（任务串行执行）\n- [ ] Heartbeat 定时触发 Agent 主动检查任务\n- [ ] Cron 按表达式定时派发任务\n- [ ] Hook 在内部事件时触发 Agent 行动\n- [ ] Task Queue 保证串行执行、支持优先级\n- [ ] `agent dispatch` 手动派发任务\n- [ ] `agent logs` 查看执行历史\n- [ ] `agent watch` 实时观察 Agent 输出\n- [ ] 模板支持 `schedule` 配置字段\n- [ ] 任务失败时正确处理（记录、触发 hook、可选重试）",
  "author": "human",
  "assignees": [],
  "relatedFiles": [
    "packages/core/src/scheduler/task-queue.ts",
    "packages/core/src/scheduler/task-dispatcher.ts",
    "packages/core/src/scheduler/inputs/heartbeat-input.ts",
    "packages/core/src/scheduler/inputs/cron-input.ts",
    "packages/core/src/scheduler/inputs/hook-input.ts",
    "packages/core/src/scheduler/inputs/input-router.ts",
    "packages/core/src/scheduler/execution-log.ts",
    "packages/api/src/http/webhook-server.ts",
    "packages/core/src/manager/agent-manager.ts",
    "packages/acp/src/connection.ts",
    "packages/acp/src/connection-manager.ts"
  ],
  "relatedIssues": [
    11,
    12,
    13,
    17,
    35,
    1,
    2
  ],
  "taskRef": null,
  "githubRef": "blackplume233/AgentCraft#41",
  "closedAs": null,
  "comments": [{"text": "Phase 3c MVP completed: TaskQueue + TaskDispatcher (#48), InputRouter + HeartbeatInput/CronInput/HookInput (#49), EmployeeScheduler + CLI integration (#50). 51/51 scheduler tests passing. Remaining P2 optional items: WebhookInput + HMAC, N8N Bridge, agent watch command. Keeping open as reference design doc for future enhancements.", "date": "2026-02-22T12:00:00", "author": "cursor-agent"}],
  "createdAt": "2026-02-21T06:00:00",
  "updatedAt": "2026-02-22T12:00:00",
  "closedAt": null
}
