{
  "id": 35,
  "title": "ACP Proxy 完整协议转发 — 运行 Proxy 等同运行完整 ACP Agent",
  "status": "open",
  "labels": [
    "acp",
    "feature",
    "protocol",
    "priority:P1"
  ],
  "milestone": "mid-term",
  "body": "## 目标\n\n将 ACP Proxy 从当前的「简化消息转发桥」升级为「完整 ACP 协议代理」，使得 `agentcraft proxy <name>` 对外部客户端而言 **等同于直接连接一个完整的 ACP Agent**。外部客户端通过 Proxy 可以完成整个 ACP 生命周期：连接握手、能力协商、会话管理、工具授权、工具调用/注入、流式响应、环境请求转发等。\n\n## 背景\n\n当前 ACP Proxy (#16) 已实现基本的消息转发，但存在关键不足：\n\n1. **握手是硬编码的**：Proxy 返回固定的 `initialize` 响应，未反映真实 Agent 的能力声明\n2. **仅支持 `session/prompt` 和 `session/cancel`**：缺失 `session/new`、`session/load`、`setSessionMode` 等完整会话管理\n3. **工具授权未转发**：Agent 的 `requestPermission` 请求在 Daemon 侧被 auto-approve 或 deny，外部客户端完全无感知\n4. **工具调用不透明**：Agent 执行的 tool_call / tool_call_update 事件未实时回传到外部客户端\n5. **无流式响应**：当前 `proxy.forward` 等待完整响应后一次返回，外部客户端看不到中间过程\n6. **环境请求穿透未实现**：`--env-passthrough` 模式设计了但 `readTextFile`/`writeTextFile`/`terminal` 等请求未真正穿透回外部客户端\n7. **反向通道缺失**：Daemon→Proxy 方向无推送能力，导致 Agent 回调无法实时回传\n\n## 方案选择：Proxy Direct Bridge（双连接桥接）\n\n### 弃用方案：增强 proxy.forward（Daemon 中继）\n\n原方案（增强 `proxy.forward` + 新增流式 RPC）存在根本性问题：\n- 需要改造 Daemon 的 SocketServer 支持双向推送（JSON-RPC 标准不支持 server-initiated messages）\n- 每条 ACP 消息都要经过 ACP→RPC→ACP 两次协议翻译，复杂且易出错\n- 需要逐个枚举所有 ACP 方法（14+），且每次 ACP 协议升级都要同步更新 RPC 层\n\n### 采用方案：Proxy Direct Bridge\n\n核心思路：**Proxy 进程自己持有两端 ACP 连接**，在它们之间做透明桥接。\n\n```\nExternal ACP Client (IDE / Cursor / Claude Desktop)\n    │\n    │  ACP / stdio (完整双向)\n    ▼\nagentcraft proxy <name>\n    ┌──────────────────────────────────────────┐\n    │  AgentSideConnection  (扮演 ACP Agent)   │ ← 接收外部客户端请求\n    │           │                               │\n    │       AcpBridge (透明桥接)                │ ← 根据模式决定回调处理\n    │           │                               │\n    │  ClientSideConnection (扮演 ACP Client)   │ ← 向 Agent 发送请求\n    └──────────────────────────────────────────┘\n         │                          │\n    ACP / stdio                JSON-RPC / socket\n         │                          │\n    Agent 子进程              AgentCraft Daemon\n    (claude-agent-acp)       (仅生命周期跟踪)\n```\n\n关键变化：\n- **Proxy 直接 spawn Agent 子进程**，而非依赖 Daemon 的 ACP 连接\n- **Daemon 仅做生命周期管理**（resolve → attach → detach），不持有 ACP 连接\n- **所有 ACP 方法自动支持**，无需逐个枚举，SDK 升级时零成本兼容\n- **session/update、requestPermission 等回调零延迟透传**，无需 polling 或 long-polling\n\n### 优势对比\n\n| 维度 | 增强 proxy.forward | Proxy Direct Bridge |\n|------|-------------------|--------------------|\n| 协议完整性 | 需逐个枚举 ACP 方法 | 自动支持所有方法 |\n| 实时性 | 需改造双向 RPC | 原生 ACP 流式 |\n| 复杂度 | 高（双协议翻译） | 低（透明桥接） |\n| 未来兼容 | ACP 升级需同步 RPC | ACP 升级零成本 |\n| Daemon 改造 | 大（需双向推送） | 无（仅用 resolve/attach/detach） |\n\n## 数据流设计\n\n### Client → Agent 方向（Agent 接口方法全部透传）\n\n```\nIDE --[initialize]--> AgentSideConnection --> Bridge --> ClientSideConnection --[initialize]--> Agent\nIDE --[session/new]--> AgentSideConnection --> Bridge --> ClientSideConnection --[session/new]--> Agent\nIDE --[session/prompt]--> ... --> Agent\nIDE --[session/cancel]--> ... --> Agent\nIDE --[session/load]--> ... --> Agent\nIDE --[setSessionMode]--> ... --> Agent\nIDE --[setSessionConfigOption]--> ... --> Agent\nIDE --[authenticate]--> ... --> Agent\n// unstable 方法同样透传\nIDE --[forkSession]--> ... --> Agent\nIDE --[resumeSession]--> ... --> Agent\nIDE --[listSessions]--> ... --> Agent\nIDE --[setSessionModel]--> ... --> Agent\n```\n\n### Agent → Client 方向（根据模式处理）\n\n**Workspace 隔离模式（默认）**:\n```\nAgent --[sessionUpdate]--> CSC --> Bridge --> ASC --[sessionUpdate]--> IDE    (始终转发)\nAgent --[requestPermission]--> CSC --> Bridge --> 自动批准                    (本地处理)\nAgent --[readTextFile]--> CSC --> Bridge --> 本地文件系统 (workspace 内)       (本地处理)\nAgent --[writeTextFile]--> CSC --> Bridge --> 本地文件系统 (workspace 内)      (本地处理)\nAgent --[createTerminal]--> CSC --> Bridge --> 本地终端                       (本地处理)\n```\n\n**Env 穿透模式（--env-passthrough）**:\n```\nAgent --[sessionUpdate]--> CSC --> Bridge --> ASC --[sessionUpdate]--> IDE    (始终转发)\nAgent --[requestPermission]--> CSC --> Bridge --> ASC --[requestPermission]--> IDE  (穿透)\nAgent --[readTextFile]--> CSC --> Bridge --> ASC --[readTextFile]--> IDE      (穿透到 IDE 端文件系统)\nAgent --[writeTextFile]--> CSC --> Bridge --> ASC --[writeTextFile]--> IDE    (穿透)\nAgent --[createTerminal]--> CSC --> Bridge --> ASC --[createTerminal]--> IDE  (穿透到 IDE 端终端)\n```\n\n## 实现计划\n\n### Phase 1: AcpBridge 核心实现\n\n**新增 `packages/acp/src/bridge.ts`**\n\n```typescript\nimport { AgentSideConnection, ClientSideConnection, ndJsonStream } from '@agentclientprotocol/sdk';\nimport type { ChildProcess } from 'node:child_process';\n\nexport interface AcpBridgeOptions {\n  mode: 'workspace-isolation' | 'env-passthrough';\n  cwd: string;\n  autoApprove?: boolean;\n}\n\nexport class AcpBridge {\n  private agentSide: AgentSideConnection;  // 面向外部客户端\n  private clientSide: ClientSideConnection; // 面向 Agent 进程\n\n  constructor(\n    agentProcess: ChildProcess,\n    proxyStdin: Readable,\n    proxyStdout: Writable,\n    options: AcpBridgeOptions,\n  );\n\n  get closed(): Promise<void>;\n  async close(): Promise<void>;\n}\n```\n\n桥接实现要点:\n- **Agent 接口**: `AgentSideConnection` 构造时提供 Agent handler，所有方法 (`initialize`, `newSession`, `prompt`, `cancel` 等) 直接调用 `clientSide` 对应方法透传\n- **Client 接口**: `ClientSideConnection` 构造时提供 Client handler:\n  - `sessionUpdate`: 始终调用 `agentSide.sessionUpdate()` 转发\n  - `requestPermission`: workspace-isolation 时自动批准，env-passthrough 时调用 `agentSide.requestPermission()` 穿透\n  - `readTextFile` / `writeTextFile`: workspace-isolation 时本地处理（在 cwd 内），env-passthrough 时穿透\n  - `createTerminal` / `terminalOutput` / `releaseTerminal` / `waitForTerminalExit` / `killTerminal`: 同上\n\n### Phase 2: 重写 Proxy CLI\n\n**重写 `packages/cli/src/commands/proxy.ts`**\n\n新流程:\n1. 连接 Daemon，调用 `agent.resolve({ name, template })` 获取 spawn 信息\n2. 调用 `agent.status({ name })` 检查 Agent 未在运行，否则报错\n3. `child_process.spawn(command, args, { cwd, stdio: ['pipe','pipe','pipe'] })` 启动 Agent\n4. 调用 `agent.attach({ name, pid })` 注册到 Daemon\n5. 创建 `AcpBridge(agentProcess, process.stdin, process.stdout, options)`\n6. 等待 `bridge.closed`（外部客户端断开或 Agent 退出）\n7. 终止 Agent 子进程\n8. 调用 `agent.detach({ name })` 清理\n\n### Phase 3: 更新导出和文档\n\n- **`packages/acp/src/index.ts`**: 新增导出 `AcpBridge`, `AcpBridgeOptions`\n- **`packages/api/src/handlers/proxy-handlers.ts`**: 保留现有实现但标注 legacy，新 CLI proxy 不再使用\n- **`.trellis/spec/api-contracts.md`**: 更新 section 7 描述新架构\n\n## 边界情况处理\n\n- **Agent 已通过 `agent.start` 运行**: Proxy 报错 \"Agent is already running. Stop it first with `agentcraft agent stop <name>`\"\n- **Agent 不存在**: 使用 `-t/--template` 选项自动创建（`agent.resolve` 支持 template 参数）\n- **Agent 进程意外退出**: Bridge 检测到 ClientSideConnection 关闭 → 通知外部客户端 → Proxy 退出\n- **外部客户端断开**: Bridge 检测到 AgentSideConnection 关闭 → 终止 Agent 进程 → 清理\n- **SIGINT/SIGTERM**: Proxy 优雅关闭 → 终止 Agent → detach → 退出\n- **多 Proxy 同一 Agent**: `agent.attach` 会检测冲突，第二个 proxy 报 AGENT_ALREADY_ATTACHED 错误\n\n## 依赖\n\n- `@agentclientprotocol/sdk` v0.14.1 — 需使用 `AgentSideConnection` 和 `ClientSideConnection`\n- #16 ACP Proxy 基础（✅ 已完成）\n- #12 Daemon ↔ Agent 通信（✅ 已完成）\n- 已有 `agent.resolve` / `agent.attach` / `agent.detach` RPC 方法（✅ 已实现）\n\n## 需要修改的文件\n\n| 文件 | 变更 |\n|------|------|\n| `packages/acp/src/bridge.ts` | **新增** — AcpBridge 核心桥接类 |\n| `packages/acp/src/index.ts` | 新增导出 AcpBridge |\n| `packages/cli/src/commands/proxy.ts` | **重写** — resolve → spawn → attach → AcpBridge → detach 流程 |\n| `packages/api/src/handlers/proxy-handlers.ts` | 保留 legacy，不再被新 proxy 使用 |\n| `.trellis/spec/api-contracts.md` | 更新 section 7 架构描述 |\n| `packages/acp/src/__tests__/bridge.test.ts` | **新增** — Bridge 单元测试 |\n\n## 验收标准\n\n- [ ] 外部 ACP Client 通过 `agentcraft proxy <name>` 连接，收到真实 Agent 能力声明（非硬编码）\n- [ ] 可通过 Proxy 完成 `initialize` → `session/new` → `session/prompt` → `session/cancel` 全流程\n- [ ] Agent 的 `session/update` 通知实时流式转发到外部客户端\n- [ ] Agent 的 `requestPermission` 在 env-passthrough 模式下穿透到外部客户端\n- [ ] Agent 的 `readTextFile`/`writeTextFile` 在 workspace-isolation 模式下本地处理，env-passthrough 模式下穿透\n- [ ] `session/load`、`setSessionMode` 等完整 ACP 生命周期方法均可通过 Proxy 使用\n- [ ] Proxy 退出时 Agent 进程优雅终止，Daemon 中状态正确清理\n- [ ] 单元测试覆盖 AcpBridge 核心转发逻辑和双模式切换\n- [ ] 与 Claude Desktop / Cursor 等标准 ACP Client 联调通过",
  "author": "cursor-agent",
  "assignees": [],
  "relatedFiles": [
    "packages/acp/src/bridge.ts",
    "packages/acp/src/index.ts",
    "packages/cli/src/commands/proxy.ts",
    "packages/api/src/handlers/proxy-handlers.ts",
    "packages/acp/src/connection.ts",
    ".trellis/spec/api-contracts.md"
  ],
  "relatedIssues": [16, 12],
  "taskRef": null,
  "githubRef": null,
  "closedAs": null,
  "comments": [
    {
      "text": "方案更新：从增强 proxy.forward（Daemon 中继）改为 Proxy Direct Bridge（双连接桥接）。Proxy 进程直接持有 AgentSideConnection + ClientSideConnection，透明桥接所有 ACP 方法，Daemon 仅做 resolve/attach/detach 生命周期管理。详细设计见 body 更新。",
      "date": "2026-02-21T02:30:00",
      "author": "cursor-agent"
    }
  ],
  "createdAt": "2026-02-20T18:30:00",
  "updatedAt": "2026-02-21T02:30:00",
  "closedAt": null
}
