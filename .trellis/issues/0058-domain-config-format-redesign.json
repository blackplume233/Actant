{
  "id": 58,
  "title": "DomainContext 各类型目录结构与格式设计 — 每种类型一个完整的文件体系",
  "status": "open",
  "labels": ["architecture", "design", "dx", "priority:P0"],
  "milestone": "phase-4",
  "body": "## 背景\n\n当前 Actant 的每种 Domain Context 组件（Skills、Prompts 等）都是一个扁平的 JSON 文件。这种设计对于 MVP 足够，但无法支撑真正有深度的领域组件。\n\nClaude Code 的 Skill 系统是优秀参考：一个 Skill 是一个**目录**，包含 SKILL.md + scripts/ + examples/ + templates/ 等子结构。Actant 的每种 Domain Context 类型都应当有同等深度的设计。\n\n**这些格式定义本身是项目的重要产出。**\n\n完整设计文档: `docs/design/domain-context-formats.md`\n\n---\n\n## 设计原则\n\n1. **目录即组件**：每个组件是一个目录，不是单个文件\n2. **manifest.json 是入口**：每个目录必须有 `manifest.json` 作为元数据和配置入口（JSON 格式）\n3. **内容文件用自然格式**：指令/文档用 `.md`，脚本用 `.sh/.py`，结构化数据用 `.json`\n4. **向后兼容**：仍支持单个 `.json` 文件作为简单模式\n5. **公共信封 + 类型特有字段**：所有类型共享一组基础字段（`$type`, `$version`, `name`, `description`, `version`, `tags`, `origin`），各自扩展专属字段\n\n---\n\n## 公共信封（Common Envelope）\n\n所有类型的 manifest.json 共享：\n\n```json\n{\n  \"$type\": \"skill\",\n  \"$version\": 1,\n  \"name\": \"code-review\",\n  \"description\": \"...\",\n  \"version\": \"1.0.0\",\n  \"tags\": [\"review\"],\n  \"origin\": { \"type\": \"builtin\" }\n}\n```\n\nOrigin 三种类型：`builtin`（内置）、`source`（Source 同步，含 syncHash/syncedAt/modified）、`local`（用户创建）。\n\n---\n\n## 一、Skill — 技能\n\n参考：[Claude Code Skills](https://code.claude.com/docs/zh-CN/skills)\n\n### 目录结构\n\n```\nskills/code-review/\n├── manifest.json          # 元数据 + 调用控制（必需）\n├── content.md             # 主要技能内容/指令（必需）\n├── templates/             # Agent 需要填写的输出模板\n│   └── review-report.md\n├── examples/              # 示例输出\n│   └── sample-review.md\n├── scripts/               # Agent 可执行的脚本\n│   └── lint-check.sh\n└── references/            # 按需加载的参考文档\n    └── style-guide.md\n```\n\n### manifest.json 核心字段\n\n| 字段 | 说明 |\n|------|------|\n| `content` | 主内容文件路径（目录模式）或内联文本（简单模式） |\n| `invocation.modelInvocable` | Agent 可否自动加载（默认 true） |\n| `invocation.userInvocable` | 用户可否 `/skill-name` 触发（默认 true） |\n| `invocation.argumentHint` | 调用时参数提示 |\n| `context` | `inline`（当前会话）或 `fork`（子 Agent 运行） |\n| `allowedTools` | 激活时可用工具白名单 |\n| `dependencies` | 依赖的其他 Skill |\n| `files.{templates,examples,scripts,references}` | 子文件引用 |\n\n---\n\n## 二、Prompt — 提示词\n\n### 目录结构\n\n```\nprompts/system-code-reviewer/\n├── manifest.json          # 元数据 + 变量定义（必需）\n├── content.md             # 主模板（支持 {{variable}} 和 {{>partial}}）\n├── variants/              # 变体版本\n│   ├── zh-CN.md           # 中文版\n│   ├── concise.md         # 简洁版\n│   └── strict.md          # 严格版\n├── partials/              # 可复用片段\n│   ├── header.md\n│   └── footer.md\n└── examples/              # 渲染后示例\n```\n\n### manifest.json 核心字段\n\n| 字段 | 说明 |\n|------|------|\n| `role` | `system` / `user` / `assistant` |\n| `content` | 主模板文件路径 |\n| `variables` | 带类型/默认值/校验的变量定义 |\n| `variables.*.type` | `string` / `number` / `boolean` / `enum` |\n| `variables.*.options` | enum 时的可选值列表 |\n| `variants` | 命名变体，各指向不同内容文件 |\n| `partials` | 可复用片段，`{{>name}}` 语法引用 |\n| `compose` | 组合其他 Prompt 内容 |\n\n---\n\n## 三、Workflow — 工作流\n\n### 目录结构\n\n```\nworkflows/trellis-standard/\n├── manifest.json          # 元数据 + 阶段定义（必需）\n├── overview.md            # 工作流总体说明\n├── phases/                # 各阶段指令（按编号排序）\n│   ├── 01-context.md\n│   ├── 02-plan.md\n│   ├── 03-implement.md\n│   ├── 04-test.md\n│   └── 05-record.md\n├── checklists/            # 质量检查清单\n│   └── code-quality.json  # items: [{id, text, command?, auto}]\n├── templates/             # 产出物模板\n│   ├── session-journal.md\n│   └── pr-description.md\n├── hooks/                 # 生命周期钩子脚本\n│   ├── pre-phase.sh\n│   └── post-workflow.sh\n└── examples/\n```\n\n### manifest.json 核心字段\n\n| 字段 | 说明 |\n|------|------|\n| `phases[]` | 有序阶段列表 |\n| `phases[].{id,name,content,required,estimatedMinutes}` | 阶段定义 |\n| `checklists[].{file,appliesTo}` | 质量门，绑定到阶段 |\n| `templates` | 产出物模板（日志、PR 等） |\n| `hooks.{prePhase,postWorkflow,...}` | 生命周期钩子 |\n| `settings.{allowSkipPhase,requireChecklistPass,autoRecord}` | 行为设置 |\n\nChecklist items 支持 `auto: true` + `command` 自动执行判定，或 `auto: false` 需人工/Agent 判断。\n\n---\n\n## 四、MCP Server — MCP 服务配置\n\n### 目录结构\n\n```\nmcp/filesystem/\n├── manifest.json          # 连接配置 + 工具权限（必需）\n├── README.md              # 使用文档\n├── profiles/              # 多环境配置\n│   ├── development.json   # 局部覆盖\n│   └── production.json\n└── scripts/\n    ├── health-check.sh\n    └── setup.sh\n```\n\n### manifest.json 核心字段\n\n| 字段 | 说明 |\n|------|------|\n| `transport.{type,command,args,env,url}` | 传输配置（stdio/sse/streamable-http） |\n| `transport.env` | 支持 `{{workspaceDir}}` 插值 |\n| `profiles` | 环境特定覆盖 |\n| `tools.{autoApprove,deny}` | 工具权限白名单/黑名单 |\n| `healthCheck.{enabled,intervalMs,timeoutMs,script}` | 健康检查 |\n| `connection.{maxRetries,retryDelayMs,idleTimeoutMs}` | 连接管理 |\n| `setup.{script,requiredEnv}` | 首次安装 |\n\n---\n\n## 五、Plugin — 插件\n\n### 目录结构\n\n```\nplugins/memory/\n├── manifest.json          # 插件元数据 + 配置（必需）\n├── README.md              # 使用文档\n├── config-schema.json     # 配置项 JSON Schema（校验+自动补全）\n├── scripts/\n│   ├── setup.sh\n│   └── migrate.sh\n└── examples/\n    └── custom-config.json\n```\n\n### manifest.json 核心字段\n\n| 字段 | 说明 |\n|------|------|\n| `pluginType` | `npm` / `file` / `config` |\n| `source` | npm 包名或文件路径 |\n| `enabled` | 是否启用 |\n| `config` | 插件配置参数 |\n| `configSchema` | JSON Schema 文件路径 |\n| `compatibility.{backends,minBackendVersion}` | 后端兼容性 |\n| `lifecycle.{setup,migrate}` | 安装/迁移脚本 |\n| `dependencies` | 依赖的其他插件 |\n\n---\n\n## 六、Template — Agent 模板\n\n### 目录结构\n\n```\ntemplates/code-review-agent/\n├── manifest.json          # 完整 Agent 蓝图（必需）\n├── README.md              # 模板使用文档\n├── overrides/             # 预设覆盖方案\n│   ├── strict.json\n│   └── quick.json\n├── initializer/           # 自定义初始化脚本\n│   └── post-create.sh\n└── examples/\n    └── usage.md\n```\n\n### manifest.json 核心字段\n\n| 字段 | 说明 |\n|------|------|\n| `extends` | 父模板——继承+增量覆盖 |\n| `backend` / `provider` | Agent 后端和模型提供者 |\n| `domainContext.{skills,prompts,mcpServers,workflow,plugins}` | 引用的领域组件（支持 `@source/name` FQN） |\n| `parameters` | 类型化参数——创建 Instance 时传入 |\n| `overrides` | 预设覆盖方案文件 |\n| `initializer.steps[]` | 初始化步骤序列 |\n| `schedule` | 调度配置（雇员型 Agent） |\n\n继承机制：数组字段用 `\"...inherit\"` 保留父模板内容并追加，不含则直接替换。\n\n---\n\n## 七、未来类型\n\n遵循同样的目录模式：\n- **Knowledge** — 知识库：documents/ + index.json，按需检索\n- **Evaluator** — 评估器：rubric.json + test-cases/，评估 Agent 输出质量\n- **Guardrail** — 安全规则：rules.json + patterns/，行为边界约束\n\n---\n\n## 八、加载机制\n\n组件发现顺序：\n1. 目录 + `manifest.json` → 目录模式\n2. `.json` 文件（非 `_` 前缀）→ 简单模式\n3. `@` 前缀目录 → 递归扫描（Source 命名空间）\n\nFQN 解析优先级：本地精确匹配 → `@*/` 搜索 → 多 Source 同名则报错要求 FQN。\n\n---\n\n## 速查表\n\n| 类型 | 入口 | 核心子文件 | 关键特性 |\n|------|------|-----------|----------|\n| **Skill** | manifest.json | content.md, scripts/, templates/, examples/, references/ | 调用控制, 工具白名单, 依赖链, fork 执行 |\n| **Prompt** | manifest.json | content.md, variants/, partials/ | 类型化变量, 多语言变体, 片段复用, 组合引用 |\n| **Workflow** | manifest.json | overview.md, phases/, checklists/, templates/, hooks/ | 有序阶段, 质量门, 生命周期钩子, 产出物模板 |\n| **MCP** | manifest.json | README.md, profiles/, scripts/ | 多环境, 健康检查, 工具权限, 连接管理 |\n| **Plugin** | manifest.json | README.md, config-schema.json, scripts/ | 配置 schema, 兼容性, 生命周期脚本, 依赖 |\n| **Template** | manifest.json | README.md, overrides/, initializer/, examples/ | 继承/组合, 参数化, 覆盖方案, 预览/dry-run |",
  "author": "human",
  "assignees": [],
  "relatedFiles": [
    "docs/design/domain-context-formats.md",
    "packages/core/src/domain/base-component-manager.ts",
    "packages/core/src/domain/skill/skill-manager.ts",
    "packages/core/src/domain/prompt/prompt-manager.ts",
    "packages/core/src/domain/workflow/workflow-manager.ts",
    "packages/core/src/domain/mcp/mcp-config-manager.ts",
    "packages/core/src/domain/plugin/plugin-manager.ts",
    "packages/core/src/source/source-manager.ts",
    "packages/api/src/services/app-context.ts",
    "packages/shared/src/types/domain-component.types.ts",
    "packages/shared/src/types/template.types.ts",
    "configs/skills/code-review.json",
    "configs/prompts/system-code-reviewer.json",
    "configs/workflows/trellis-standard.json",
    "configs/mcp/filesystem.json",
    "configs/plugins/memory-plugin.json",
    "configs/templates/code-review-agent.json",
    "docs/stage/v0.1.0/config-schemas.md"
  ],
  "relatedIssues": [56, 55],
  "taskRef": null,
  "githubRef": null,
  "closedAs": null,
  "comments": [],
  "createdAt": "2026-02-22T18:30:00",
  "updatedAt": "2026-02-22T20:00:00",
  "closedAt": null
}
