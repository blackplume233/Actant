{
  "id": 39,
  "title": "Workspace 构造器 — 面向不同 Agent 后端的差异化构建",
  "status": "open",
  "labels": [
    "feature",
    "architecture",
    "priority:P1"
  ],
  "milestone": "mid-term",
  "body": "## 目标\n\n用 Strategy Pattern 重构 workspace 构建流程，使不同 Agent 后端（Cursor / Claude Code / Custom）能产出各自最优的 workspace 文件结构。\n\n**当前问题**：\n- `ContextMaterializer` 路径硬编码（AGENTS.md、prompts/system.md 等），不区分后端差异\n- 无目录骨架（scaffold），只写 domain context 文件\n- 无 Plugin 物化能力\n- 无构建后验证\n\n## 设计方案：Strategy-based WorkspaceBuilder\n\n### BackendBuilder 接口\n\n```typescript\ninterface BackendBuilder {\n  readonly backendType: AgentBackendType;\n  scaffold(workspaceDir: string, meta: AgentInstanceMeta): Promise<void>;\n  materializeSkills(workspaceDir: string, skills: SkillDefinition[]): Promise<void>;\n  materializePrompts(workspaceDir: string, prompts: PromptDefinition[]): Promise<void>;\n  materializeMcpConfig(workspaceDir: string, servers: McpServerRef[]): Promise<void>;\n  materializePlugins(workspaceDir: string, plugins: PluginDefinition[]): Promise<void>;\n  injectPermissions(workspaceDir: string, permissions: PermissionSet): Promise<void>;\n  materializeWorkflow(workspaceDir: string, workflow: WorkflowDefinition): Promise<void>;\n  verify(workspaceDir: string): Promise<VerifyResult>;\n}\n```\n\n### 各后端差异\n\n**CursorBuilder**:\n- `.cursor/rules/*.mdc` — 每个 skill 一个规则文件\n- `.cursor/mcp.json` — MCP 配置\n- `.cursor/extensions.json` — 推荐扩展（plugins）\n- `AGENTS.md` — skill 概述\n- `prompts/system.md` — system prompt\n\n**ClaudeCodeBuilder**:\n- `.claude/mcp.json` — MCP 配置\n- `.claude/settings.local.json` — 权限\n- `.claude/plugins.json` — Cloud Code plugins\n- `CLAUDE.md` — 主指令文件（skills + prompts 聚合）\n- `AGENTS.md` — Agent Skills 声明\n\n**CustomBuilder**:\n- 通过 `template.backend.config.builderConfig` 自定义所有路径\n\n### 构建 Pipeline\n\n```\nWorkspaceBuilder.build():\n  1. resolve     → 解析 template 引用的所有组件\n  2. validate    → 检查组件兼容性\n  3. scaffold    → 创建目录结构 + 骨架文件\n  4. materialize → 逐项物化 domain context + plugins\n  5. inject      → 注入权限、环境变量、后端特定配置\n  6. verify      → 检查文件完整性\n```\n\n### 迁移策略\n\n1. 新建 WorkspaceBuilder + CursorBuilder + ClaudeCodeBuilder\n2. AgentInitializer 注入 WorkspaceBuilder\n3. ContextMaterializer 标记 @deprecated\n4. 迁移所有调用方 → 删除 ContextMaterializer\n\n## 实现计划\n\n1. 定义 `BackendBuilder` 接口 + `BuildResult` 类型\n2. 实现 `CursorBuilder`\n3. 实现 `ClaudeCodeBuilder`\n4. 实现 `WorkspaceBuilder` 编排层\n5. 迁移 `AgentInitializer` 使用新 Builder\n6. `CustomBuilder` + 可配置路径\n7. 集成测试 + E2E 测试更新\n\n## 文件路径\n\n```\npackages/core/src/builder/\n  ├── workspace-builder.ts        # 编排层\n  ├── backend-builder.ts          # 接口定义\n  ├── cursor-builder.ts           # Cursor 后端\n  ├── claude-code-builder.ts      # Claude Code 后端\n  ├── custom-builder.ts           # 可配置自定义后端\n  └── index.ts\n```\n\n## 验收标准\n\n- [ ] CursorBuilder 正确生成 Cursor 项目结构\n- [ ] ClaudeCodeBuilder 正确生成 Claude Code 项目结构（含 CLAUDE.md、plugins）\n- [ ] CustomBuilder 支持配置化路径\n- [ ] Pipeline 六步骤全部实现\n- [ ] 现有测试全部通过（兼容性）\n- [ ] ContextMaterializer 标记 deprecated\n- [ ] E2E 测试使用新 Builder 验证",
  "author": "human",
  "assignees": [],
  "relatedFiles": [
    "packages/core/src/initializer/context/context-materializer.ts",
    "packages/core/src/initializer/agent-initializer.ts",
    "packages/core/src/template/schema/template-schema.ts",
    "packages/core/src/domain/skill/skill-manager.ts",
    "packages/core/src/domain/prompt/prompt-manager.ts"
  ],
  "relatedIssues": [23, 38, 26],
  "taskRef": null,
  "githubRef": null,
  "closedAs": null,
  "comments": [],
  "createdAt": "2026-02-21T12:00:00",
  "updatedAt": "2026-02-21T12:00:00",
  "closedAt": null
}
