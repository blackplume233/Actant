{
  "id": 51,
  "title": "AgentTemplate 权限控制 — 对齐 Claude Code permissions 配置结构",
  "status": "open",
  "labels": ["feature", "template", "security", "priority:P1"],
  "milestone": "phase-3",
  "body": "## 问题\n\n当前 `AgentTemplateSchema` 没有权限控制字段。`ContextMaterializer.materializeClaudePermissions()` 硬编码了一组 allow-list（Bash, Read, Write, Edit, MultiEdit, WebFetch, WebSearch + MCP tools），所有 Agent 无论角色都获得完全一样的权限，模板作者无法做精细控制。\n\n## 设计原则\n\n**直接对齐 Claude Code 原生 `permissions` + `sandbox` 结构**，而非另建一套抽象。好处：\n- 模板作者的心智模型与 Claude Code 文档一致\n- ContextMaterializer 只需透传/合并，无需复杂映射\n- 未来 Claude Code 新增权限特性时兼容性好\n\n## 参考：Claude Code 权限体系\n\n来源: https://code.claude.com/docs/en/permissions\n\n### permissions 对象\n\n```jsonc\n{\n  \"permissions\": {\n    \"allow\": [\"Bash(npm run *)\", \"Read\", \"mcp__puppeteer\"],\n    \"deny\":  [\"Bash(rm *)\", \"WebFetch\"],\n    \"ask\":   [\"Write\", \"Edit\"]\n  }\n}\n```\n\n求值顺序: **deny → ask → allow**，首个匹配规则生效。\n\n### 工具模式语法\n\n| 模式 | 示例 | 效果 |\n|------|------|------|\n| 仅工具名 | `Bash` | 匹配该工具所有调用 |\n| 精确命令 | `Bash(npm run build)` | 精确匹配 |\n| 通配符 | `Bash(npm run *)` | glob 模式 |\n| 域名限制 | `WebFetch(domain:example.com)` | 限制域名 |\n| 文件路径 | `Read(./.env)`, `Edit(/src/**/*.ts)` | gitignore 风格路径 |\n| MCP 工具 | `mcp__server__tool`, `mcp__server` | MCP 服务器工具 |\n| Sub-Agent | `Task(Plan)`, `Task(Explore)` | 控制子 Agent |\n| 全部 | `*` | 匹配所有 |\n\n### defaultMode\n\n| 模式 | 说明 |\n|------|------|\n| `default` | 首次使用时提示 |\n| `acceptEdits` | 自动接受文件编辑 |\n| `plan` | 只读分析模式 |\n| `dontAsk` | 除 allow 外自动拒绝 |\n| `bypassPermissions` | 跳过所有权限检查（仅限隔离环境） |\n\n### sandbox 对象（Bash 级 OS 隔离）\n\n```jsonc\n{\n  \"sandbox\": {\n    \"enabled\": true,\n    \"autoAllowBashIfSandboxed\": false,\n    \"network\": {\n      \"allowedDomains\": [\"github.com\", \"npmjs.org\"],\n      \"allowLocalBinding\": false\n    }\n  }\n}\n```\n\n### additionalDirectories\n\n扩展 Agent 的工作目录访问范围。\n\n## 提议 Schema\n\n### 1. AgentTemplateSchema 新增 `permissions` 字段\n\n```typescript\nconst PermissionModeSchema = z.enum([\n  \"default\",\n  \"acceptEdits\",\n  \"plan\",\n  \"dontAsk\",\n  \"bypassPermissions\",\n]);\n\nconst SandboxNetworkSchema = z.object({\n  allowedDomains: z.array(z.string()).optional(),\n  allowLocalBinding: z.boolean().optional(),\n}).optional();\n\nconst SandboxSchema = z.object({\n  enabled: z.boolean().default(false),\n  autoAllowBashIfSandboxed: z.boolean().default(false),\n  network: SandboxNetworkSchema,\n}).optional();\n\nconst PermissionsSchema = z.object({\n  // 核心: allow / deny / ask — Claude Code 原生格式\n  allow: z.array(z.string()).optional(),\n  deny:  z.array(z.string()).optional(),\n  ask:   z.array(z.string()).optional(),\n\n  // 权限模式\n  defaultMode: PermissionModeSchema.optional(),\n\n  // Bash 沙箱\n  sandbox: SandboxSchema,\n\n  // 额外工作目录\n  additionalDirectories: z.array(z.string()).optional(),\n}).optional();\n\n// AgentTemplateSchema 新增\nconst AgentTemplateSchema = z.object({\n  name, version, description,\n  backend,\n  provider,\n  domainContext,\n  initializer,\n  permissions: PermissionsSchema,    // ← 新增\n  metadata,\n});\n```\n\n### 2. 预设（preset）— 语法糖\n\n常用场景提供预设，减少样板：\n\n```typescript\nconst PermissionsWithPresetSchema = z.union([\n  // 字符串引用预设\n  z.enum([\"permissive\", \"standard\", \"restricted\", \"readonly\"]),\n  // 完整对象\n  PermissionsSchema,\n]);\n```\n\n预设定义：\n\n| 预设 | allow | deny | ask | defaultMode |\n|------|-------|------|-----|-------------|\n| `permissive` | `[\"*\"]` | `[]` | `[]` | `bypassPermissions` |\n| `standard` | `[\"Read\", \"Edit\", \"Write\", \"Bash(npm run *)\", \"Bash(git *)\", \"WebFetch\", \"WebSearch\"]` | `[]` | `[\"Bash\"]` | `default` |\n| `restricted` | `[\"Read\", \"WebSearch\"]` | `[\"Bash\", \"WebFetch\"]` | `[\"Edit\", \"Write\"]` | `dontAsk` |\n| `readonly` | `[\"Read\", \"WebFetch\", \"WebSearch\"]` | `[\"Bash\", \"Edit\", \"Write\", \"MultiEdit\"]` | `[]` | `plan` |\n\n### 3. ContextMaterializer 改造\n\n```typescript\nasync materializePermissions(\n  workspaceDir: string,\n  permissions: PermissionsInput | undefined,\n  mcpServers: McpServerRef[],\n  backendType: AgentBackendType,\n): Promise<void> {\n  // 1. 解析 preset → 完整 permissions 对象\n  const resolved = resolvePreset(permissions);\n\n  // 2. 自动追加 MCP 工具到 allow（如果 allow 中没有 '*'）\n  if (!resolved.allow?.includes('*')) {\n    for (const server of mcpServers) {\n      resolved.allow ??= [];\n      resolved.allow.push(`mcp__${server.name}`);\n    }\n  }\n\n  // 3. 按后端类型物化\n  if (backendType === 'claude-code') {\n    // 直接写入 .claude/settings.local.json — 结构天然对齐\n    const settings = {\n      permissions: {\n        allow: resolved.allow ?? [],\n        deny:  resolved.deny ?? [],\n        ...(resolved.ask ? { ask: resolved.ask } : {}),\n      },\n      ...(resolved.sandbox ? { sandbox: resolved.sandbox } : {}),\n    };\n    await writeFile(join(configDir, 'settings.local.json'), JSON.stringify(settings, null, 2));\n  } else if (backendType === 'cursor') {\n    // Cursor 不支持完全相同的格式，做最佳映射\n    // ...\n  }\n}\n```\n\n### 4. 未设置 permissions 时的默认行为\n\n向后兼容：当模板不包含 `permissions` 字段时，行为等同于当前硬编码逻辑（`permissive` 预设 + MCP 工具自动追加）。\n\n## 模板示例\n\n### 全权限 Agent（当前默认行为）\n\n```yaml\npermissions: \"permissive\"\n```\n\n### 代码审查 Agent（只读）\n\n```yaml\npermissions: \"readonly\"\n```\n\n### 定制权限\n\n```yaml\npermissions:\n  allow:\n    - Read\n    - \"Bash(npm run test *)\"\n    - \"Bash(npm run lint *)\"\n    - \"Bash(git diff *)\"\n    - \"WebFetch(domain:github.com)\"\n    - \"WebFetch(domain:npmjs.org)\"\n  deny:\n    - \"Bash(rm *)\"\n    - \"Bash(git push *)\"\n  ask:\n    - Write\n    - Edit\n  defaultMode: default\n  sandbox:\n    enabled: true\n    network:\n      allowedDomains:\n        - github.com\n        - npmjs.org\n```\n\n## 验收标准\n\n- [ ] AgentTemplateSchema 新增 `permissions` 字段（支持 preset 字符串或完整对象）\n- [ ] Zod schema 校验通过，支持 Claude Code 所有工具模式语法\n- [ ] ContextMaterializer 根据 permissions 动态生成配置，不再硬编码\n- [ ] 未设置 permissions 时向后兼容（等同 `permissive`）\n- [ ] 预设解析正确（permissive / standard / restricted / readonly）\n- [ ] Claude Code 后端: 直接映射到 `.claude/settings.local.json`\n- [ ] Cursor 后端: 做最佳适配映射\n- [ ] 关联 #36 的实例级覆盖与审计需求\n- [ ] 单元测试覆盖各 preset + 自定义 permissions\n- [ ] 更新模板示例文档",
  "author": "cursor-agent",
  "assignees": [],
  "relatedFiles": [
    "packages/core/src/template/schema/template-schema.ts",
    "packages/core/src/initializer/context/context-materializer.ts",
    "packages/shared/src/types/domain-component.types.ts",
    "docs/design/mvp-next-design.md"
  ],
  "relatedIssues": [36, 39, 46, 50],
  "taskRef": null,
  "githubRef": null,
  "closedAs": null,
  "comments": [
    {
      "author": "cursor-agent",
      "body": "与 #36 的关系：#36 提出了权限管理的整体需求（模板级 + 实例级 + 审计），本 issue 聚焦 **模板级 permissions schema 设计**，直接对齐 Claude Code 原生结构。#36 中的实例级覆盖和审计日志可作为后续增强。",
      "createdAt": "2026-02-21T22:45:00"
    }
  ],
  "createdAt": "2026-02-21T22:30:00",
  "updatedAt": "2026-02-21T22:45:00",
  "closedAt": null
}
