---
id: 31
title: "质量规范禁止模式：非空断言（!）在源码与测试中的全面清除"
status: closed
labels:
  - core
  - "priority:P1"
  - quality
  - review
milestone: null
author: cursor-agent
assignees: []
relatedIssues: []
relatedFiles: []
taskRef: null
githubRef: "blackplume233/Actant#31"
closedAs: completed
createdAt: "2026-02-20T13:19:00"
updatedAt: "2026-02-20T14:55:40"
closedAt: "2026-02-20T14:55:40"
---

## 审查发现（更严格标准）

`.trellis/spec/backend/quality-guidelines.md` 明确 **Don't: Non-null Assertions (`!`)**，要求用守卫或抛错替代。当前仓库在**生产代码**与**测试代码**中仍有多处 `!`，违反规范。

## 证据

### 生产代码（1 处，必须修复）

| 文件 | 行号 | 代码 |
|------|------|------|
| `packages/core/src/manager/launcher/process-launcher.ts` | 60 | `resolve({ pid: child.pid! })` |

`spawn` 事件触发时 Node 会设置 `pid`，但类型上仍可能 undefined。建议改为：`if (child.pid != null) resolve({ pid: child.pid }); else resolve({ pid: 0 });` 或抛错，避免 `!`。

### 测试代码（多处，建议一并清除）

| 文件 | 行号 | 说明 |
|------|------|------|
| `packages/core/src/manager/agent-manager.test.ts` | 264, 276, 405 | `getAgent(...)!.pid!` — 建议 `expect(agent).toBeDefined()` 后 `agent!.pid` 或 `agent?.pid` + expect |
| `packages/core/src/manager/launcher/process-launcher.test.ts` | 40 | `resolve(child.pid!)` — 同上，守卫或 expect |
| `packages/api/src/daemon/__tests__/socket-server.test.ts` | 95, 120, 131, 143, 144 | `res.error!` — 可 `expect(res.error).toBeDefined(); expect(res.error!.code)` 或断言后取 |
| `packages/core/src/template/loader/template-loader.test.ts` | 29, 63 | `mcpServers![0]!` — 可先 `expect(mcpServers?.[0]).toBeDefined()` 再访问 |

## 建议

- 生产代码：**禁止 `!`**，一律用 `if (x == null) throw ...` 或返回值类型收窄。
- 测试代码：**同一标准**，用 `expect(x).toBeDefined()` 或类型守卫后访问，避免依赖 `!`，便于后续严格 TS 配置（如 `noUncheckedIndexedAccess`）时测试不报错。
- 在 Code Review Checklist 中显式勾选「No non-null assertions」。

---

## Comments

### cursor-agent — 2026-02-20T14:55:40

Closed as completed
