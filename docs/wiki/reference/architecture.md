---
generated: true
---

<!-- GENERATED BY update-wiki-from-stage.mjs — DO NOT EDIT MANUALLY -->

# 架构概览

> 基于 v0.2.2 (2026-02-24)

# Actant v0.2.2 — Architecture Document

> **Actant** is "Docker for AI Agents" — a platform to build, manage, and compose AI agents with pluggable backends, declarative configuration, and a component ecosystem.

## Tech Stack

| Layer | Technology |
|-------|-----------|
| Runtime | Node.js 20+ / TypeScript 5.7 |
| Build | tsup (ESM) + pnpm workspaces |
| Validation | Zod |
| CLI | Commander.js |
| IPC | JSON-RPC 2.0 over Unix socket / Windows named pipe |
| Agent Protocol | ACP (Agent Client Protocol) |
| Testing | Vitest |
| Package Manager | pnpm 10 |

## Monorepo Structure

```
packages/
├── shared/       @actant/shared      Types, logger, config helpers (foundation)
├── core/         @actant/core        Runtime engine (managers, builders, domain)
├── api/          @actant/api         Daemon, socket server, RPC handlers
├── cli/          @actant/cli         CLI frontend (commander-based)
├── acp/          @actant/acp         Agent Client Protocol adapter
├── pi/           @actant/pi          Pi — in-process lightweight agent backend
├── mcp-server/   @actant/mcp-server  MCP server integration
└── actant/       actant              Meta-package + global binary
```

### Package Dependency Graph

```
                    ┌──────────┐
                    │  actant  │  (meta-package)
                    └────┬─────┘
          ┌──────┬───────┼───────┬──────┬──────┐
          ▼      ▼       ▼       ▼      ▼      ▼
        cli    api     core    acp    pi    mcp-server
          │      │       │       │      │      │
          ├──────┤       │       ├──────┘      │
          │      ├───────┤       │             │
          │      │       │       ▼             │
          └──────┴───────┴──► shared ◄─────────┘
```

## Module Architecture

### 1. `@actant/shared` — Foundation Types

Pure type definitions and shared utilities. No runtime logic.

- **Types**: `AgentInstanceMeta`, `AgentTemplate`, `BackendDefinition`, `VersionedComponent`, `DomainContextConfig`, `SourceConfig`, `RPC method map`
- **Utilities**: Logger (pino), IPC helpers, platform detection
- **Error hierarchy**: `ActantError` → `AgentNotFoundError`, `ConfigValidationError`, `ComponentReferenceError`, etc.

### 2. `@actant/core` — Runtime Engine

The core logic layer containing all business rules.

#### Manager (`src/manager/`)

- **AgentManager** — The central orchestrator for agent lifecycle
  - State machine: `created → starting → running → stopping → stopped`
  - Launch modes: `direct`, `acp-background`, `acp-service`, `one-shot`
  - Process ownership: `managed` (Actant spawns) or `external` (user spawns, Actant attaches)
  - Workspace policy: `persistent` or `ephemeral`
  - Methods: `createAgent`, `startAgent`, `stopAgent`, `destroyAgent`, `runPrompt`, `streamPrompt`, `resolveAgent`, `openAgent`, `attachAgent`, `detachAgent`

- **ProcessLauncher** — Spawns backend processes
- **LaunchModeHandler** — Determines behavior on process exit per launch mode
- **RestartTracker** — Manages restart policies for `acp-service` mode
- **ProcessWatcher** — Monitors process health via PID polling

#### Domain (`src/domain/`)

All domain components are `VersionedComponent`s managed by `BaseComponentManager`:

| Manager | Component | Persistence Dir |
|---------|-----------|-----------------|
| `SkillManager` | `SkillDefinition` | `configs/skills/` |
| `PromptManager` | `PromptDefinition` | `configs/prompts/` |
| `McpConfigManager` | `McpServerDefinition` | `configs/mcp/` |
| `WorkflowManager` | `WorkflowDefinition` | `configs/workflows/` |
| `PluginManager` | `PluginDefinition` | `configs/plugins/` |
| `BackendManager` | `BackendDefinition` | `configs/backends/` |

`BaseComponentManager` provides: `register`, `unregister`, `get`, `has`, `list`, `add`, `update`, `remove`, `importFromFile`, `exportToFile`, `search`, `filter`, `loadFromDirectory`, `validate`.

`BackendManager` adds: `registerAcpResolver`, `getAcpResolver`, `supportsMode`, `requireMode`, `checkAvailability`, `getInstallMethods`.

#### Backend System (`src/domain/backend/` + `src/manager/launcher/`)

Backends are `VersionedComponent`s (JSON-serializable) with behavioral extensions:

```
BackendDefinition (data, serializable)
├── name, version, description, tags
├── supportedModes: ["resolve", "open", "acp"]
├── resolveCommand / openCommand / acpCommand (PlatformCommand)
├── openSpawnOptions (OpenSpawnOptions)
├── existenceCheck (BackendExistenceCheck)
└── install (BackendInstallMethod[])

BackendManager (behavior, non-serializable)
├── acpResolvers: Map<string, AcpResolverFn>
├── checkAvailability() — runs existenceCheck
└── getInstallMethods() — platform-filtered
```

Built-in backends:

| Backend | Modes | Binary | Notes |
|---------|-------|--------|-------|
| `cursor` | resolve, open | `cursor.cmd` / `cursor` | IDE; shell spawn |
| `cursor-agent` | resolve, open, acp | `agent` | TUI; cwd-based open |
| `claude-code` | resolve, open, acp | `claude-agent-acp.cmd` / `claude` | resolvePackage for ACP |
| `pi` | acp | in-process | ACP owns process |
| `custom` | resolve | user-defined | Fallback |

#### Source System (`src/source/`)

- **SourceManager** — Manages external component repositories
- **GitHubSource** — Shallow clone from GitHub
- **LocalSource** — Reads from local directory
- **Namespacing**: Components from sources get `packageName@componentName` prefix
- **Default source**: `actant-hub` at `github.com/blackplume233/actant-hub.git`

Supports: skills, prompts, mcp, workflows, backends, presets, templates.

#### Builder System (`src/builder/`)

Materializes agent workspaces from domain context:

- **WorkspaceBuilder** — Orchestrates context materialization
- **CursorBuilder** — `.cursor/` config files (rules, mcp.json, extensions.json)
- **ClaudeCodeBuilder** — `.claude/` config files (CLAUDE.md, settings.json)
- **Handlers**: `SkillsHandler`, `PromptsHandler`, `McpServersHandler`, `WorkflowHandler`

#### Template System (`src/template/`)

- **TemplateLoader** — Loads from files, validates via Zod
- **TemplateRegistry** — In-memory registry
- **TemplateFileWatcher** — Hot-reload on file changes
- **Validation**: `AgentTemplateSchema` (Zod) validates all fields

#### Initializer System (`src/initializer/`)

Creates agent instance directories via pipeline:

- **InitializationPipeline** — Sequential steps
- Steps: `MkdirStep`, `FileCopyStep`, `GitCloneStep`, `NpmInstallStep`, `ExecStep`
- **ContextMaterializer** — Assembles domain components into workspace

#### Scheduler (`src/scheduler/`)

- **EmployeeScheduler** — Manages heartbeat, cron, hook triggers
- **TaskDispatcher** — Priority queue, sequential execution
- **ExecutionLog** — Per-agent execution history
- Configs: `HeartbeatConfig` (intervalMs), `CronConfig` (pattern), `HookConfig` (eventName)

#### Provider (`src/provider/`)

- **ModelProviderRegistry** — Manages AI provider configs
- Built-in: `anthropic`, `openai`, `gemini`, `openrouter`

### 3. `@actant/api` — Daemon & Handlers

#### Daemon (`src/daemon/`)

- **Daemon** — Long-running background service
- **SocketServer** — JSON-RPC 2.0 over Unix socket / Windows named pipe
- **PidFile** — Process lock via PID file
- **AcpRelayServer** — Routes ACP session updates to CLI clients

#### Handlers (`src/handlers/`)

62 RPC methods across 11 handler groups:

| Handler | Method Count | Key Methods |
|---------|-------------|-------------|
| template | 5 | list, get, load, unload, validate |
| agent | 16 | create, start, stop, destroy, status, list, resolve, open, attach, detach, run, prompt, adopt, dispatch, tasks, logs |
| session | 5 | create, prompt, cancel, close, list |
| domain (×5) | 25 | list, get, add, update, remove, import, export (per type) |
| source | 5 | list, add, remove, sync, validate |
| preset | 3 | list, show, apply |
| daemon | 2 | ping, shutdown |
| proxy | 3 | connect, disconnect, forward |
| schedule | 1 | list |

#### AppContext (`src/services/`)

- Initializes all managers, registries, and services
- Registers built-in backends, providers
- Loads domain components from disk and sources
- Registers Pi backend with ACP resolver

### 4. `@actant/cli` — Command-Line Interface

68 subcommands organized into 15 command groups:

| Group | Commands | Description |
|-------|----------|-------------|
| agent | 17 | Full lifecycle management |
| template | 5 | Template CRUD |
| skill | 5 | Skill CRUD |
| prompt | 5 | Prompt CRUD |
| mcp | 5 | MCP server config CRUD |
| workflow | 5 | Workflow CRUD |
| plugin | 5 | Plugin CRUD |
| source | 5 | Source management |
| preset | 3 | Preset management |
| schedule | 1 | Schedule listing |
| daemon | 3 | Daemon control |
| proxy | 1 | ACP proxy |
| setup | 1 | Interactive wizard |
| self-update | 1 | Auto-update |
| help | 1 | Help display |

- **RpcClient** — Connects to daemon via socket, sends JSON-RPC requests
- **Output formats**: `table` (default), `json` via `-f` flag
- **Error presentation**: Colored RPC error codes with context

### 5. `@actant/acp` — Agent Client Protocol

- **AcpConnection** — Manages lifecycle of one agent subprocess via ACP SDK
- **AcpConnectionManager** — Pool of connections by agent name
- **AcpCommunicator** — Implements `AgentCommunicator` over ACP
- **AcpGateway** — IDE ↔ Agent bridge (upstream `AgentSide` ↔ downstream `ClientSide`)
- **ClientCallbackRouter** — Routes permission requests, file operations, terminal ops
- **LocalTerminalManager** — Local terminal handling for headless mode

### 6. `@actant/pi` — Lightweight In-Process Agent

- **PiBuilder** — Workspace builder for Pi agents
- **PiCommunicator** — Direct LLM communication (Anthropic, OpenAI, etc.)
- **ACP Bridge** — `pi-acp-bridge` binary for ACP protocol compliance
- No external binary needed — runs within the Actant process

## Core Data Flows

### Agent Creation Flow

```
CLI: actant agent create myagent -t template
  │
  ▼
RPC: agent.create { name, template }
  │
  ▼
AgentManager.createAgent()
  ├── TemplateRegistry.get(templateName)
  ├── AgentInitializer.initialize()
  │   ├── InitializationPipeline.execute()
  │   │   ├── MkdirStep (create instance dir)
  │   │   ├── FileCopyStep (copy initializer files)
  │   │   └── ExecStep (run init commands)
  │   └── ContextMaterializer.materialize()
  │       ├── WorkspaceBuilder.build(domainContext)
  │       │   ├── SkillsHandler → AGENTS.md / .claude/
  │       │   ├── PromptsHandler → prompts in workspace
  │       │   ├── McpServersHandler → .cursor/mcp.json
  │       │   └── WorkflowHandler → .trellis/workflow.md
  │       └── Write instance-meta.json
  └── Return AgentInstanceMeta
```

### Agent Run Flow (One-Shot)

```
CLI: actant agent run myagent --prompt "hello"
  │
  ▼
RPC: agent.run { name, prompt }
  │
  ▼
AgentManager.runPrompt()
  ├── Ensure agent exists (or auto-create from template)
  ├── Determine launch mode: one-shot
  ├── Start agent if not running
  │   ├── BackendResolver.resolveAcpBackend() or resolveBackend()
  │   └── ProcessLauncher.launch() or AcpConnection.connect()
  ├── Communicator.runPrompt(prompt)
  │   ├── AcpCommunicator: session.create → session.prompt → session.close
  │   └── ClaudeCodeCommunicator: spawn claude -p --output-format json
  └── Return { text, sessionId }
```

### Agent Open Flow

```
CLI: actant agent open myagent
  │
  ▼
RPC: agent.open { name }
  │
  ▼
AgentManager.openAgent()
  ├── BackendResolver.openBackend(backendType, workspaceDir)
  │   ├── BackendManager.get(backendType)
  │   ├── getPlatformCommand(openCommand)
  │   └── Return { command, args, cwd?, openSpawnOptions }
  └── Return result to CLI
  │
  ▼
CLI: spawn(command, args, { cwd, ...openSpawnOptions, detached: true })
```

## Agent Lifecycle State Machine

```
                    ┌─────────┐
          create ──►│ created │
                    └────┬────┘
                         │ start
                    ┌────▼────┐
                    │starting │
                    └────┬────┘
              success ───┤      ├─── failure
                    ┌────▼────┐ │  ┌───────┐
                    │ running │ └─►│ error │
                    └────┬────┘    └───────┘
                         │ stop
                    ┌────▼────┐
                    │stopping │
                    └────┬────┘
                         │
                    ┌────▼────┐
          destroy ──│ stopped │
                    └─────────┘
```

**Launch Modes and Exit Behavior:**

| Mode | On Process Exit | On Daemon Restart |
|------|----------------|-------------------|
| `direct` | → stopped | → stopped |
| `acp-background` | → stopped | → stopped |
| `acp-service` | → restart (if under limit) | → restart |
| `one-shot` | → destroy (if autoDestroy) | → stopped |

## Configuration Hierarchy

```
AgentTemplate
├── name, version, description
├── backend: { type, args?, env? }
├── provider: { type, protocol?, model?, apiKey? }
├── domainContext
│   ├── skills: string[]          → SkillDefinition[]
│   ├── prompts: string[]         → PromptDefinition[]
│   ├── mcpServers: McpServerRef[]
│   ├── subAgents: SubAgentRef[]
│   ├── workflows: string[]       → WorkflowDefinition[]
│   └── plugins: string[]         → PluginDefinition[]
├── permissions: { allow, deny, ask, defaultMode }
├── initializer: { steps[] }
├── schedule: { heartbeat?, cron?, hooks? }
└── metadata: Record<string, string>
```

## Built-in Resources

### Backends (via actant-hub + built-in)

| Name | Type | Modes |
|------|------|-------|
| cursor | IDE | resolve, open |
| cursor-agent | TUI | resolve, open, acp |
| claude-code | CLI | resolve, open, acp |
| pi | In-process | acp |
| custom | User-defined | resolve |

### Providers

| Name | Protocol |
|------|----------|
| anthropic | anthropic |
| openai | openai |
| gemini | openai |
| openrouter | openai |

### Default Source: actant-hub

- 3 templates: code-reviewer, qa-engineer, doc-writer
- 3 skills: code-review, test-writer, doc-writer
- 2 prompts: code-assistant, qa-assistant
- 2 MCP servers: filesystem, memory-server
- 4 backends: cursor, cursor-agent, claude-code, pi
- 2 presets: web-dev, devops

## Current Version Status (v0.2.2)

### Completed (Phase 1-2)

- Full agent lifecycle (create, start, stop, destroy, attach, detach)
- Multi-backend support (Cursor, Claude Code, Pi, custom)
- ACP protocol integration
- Domain component system (6 types, CRUD, import/export)
- Source system with actant-hub
- Template/preset system
- Scheduler (heartbeat, cron, hooks)
- Session lease system
- Permission system
- CLI with 68 subcommands
- Daemon with 62 RPC methods
- Backend as VersionedComponent (BackendManager)
- Backend availability checking + install methods
- `agent run` headless mode (windowsHide)
- `agent open` with backend-specific spawn config
- `agent destroy --force` idempotent behavior

### In Progress (Phase 3)

- Frontend dashboard (planned)
- Plugin execution engine
- Advanced scheduling (cross-agent dependencies)

### Known Limitations

- `gateway.lease` RPC defined but not implemented (#117)
- MCP server package is a stub
- No Linux/macOS installation script yet
- Backend `existenceCheck` requires the binary to be in PATH

---

详细版本快照见仓库中 `docs/stage/v0.2.2/architecture.md`。
