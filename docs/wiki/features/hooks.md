---
generated: true
---

<!-- GENERATED BY wiki-updater — DO NOT EDIT MANUALLY -->

# Hook 事件系统

> 当事情发生时，自动触发动作。让 Agent 平台拥有事件驱动能力。

## 概述

Hook 系统是 Actant Phase 4 的核心功能。它让你可以在 Agent 生命周期的关键节点（创建、启动、崩溃、空闲……）自动触发 Shell 命令、内置操作或向其他 Agent 发送消息。

传统方式需要人工监控 Agent 状态并手动干预。有了 Hook 系统，你可以声明"当 X 发生时，执行 Y"——就像 Git Hooks 或 Docker Events。

## 核心概念

| 概念 | 说明 |
|------|------|
| **Event（事件）** | 平台内发生的事情，如 `agent:created`、`process:crash` |
| **Hook（钩子）** | 声明"监听哪个事件 + 执行哪些动作"的规则 |
| **Action（动作）** | Hook 触发后执行的操作：Shell 命令、内置函数或 Agent 调用 |
| **Workflow** | 包含一组 Hook 声明的工作流定义文件 |
| **Scope** | Hook 的作用域：`actant`（全局）或 `instance`（绑定到特定 Agent） |

## 事件列表

### 系统事件

| 事件 | 触发时机 |
|------|---------|
| `actant:start` | Daemon 启动就绪 |
| `actant:stop` | Daemon 关闭中 |

### 实体事件

| 事件 | 触发时机 |
|------|---------|
| `agent:created` | 新 Agent 实例被创建 |
| `agent:destroyed` | Agent 实例被销毁 |
| `agent:modified` | Agent 配置发生变更 |
| `source:updated` | 组件源同步/更新 |

### 运行时事件

| 事件 | 触发时机 |
|------|---------|
| `process:start` | Agent 后端进程启动 |
| `process:stop` | Agent 后端进程正常停止 |
| `process:crash` | Agent 后端进程意外退出 |
| `process:restart` | Agent 正在崩溃重启 |
| `session:start` | ACP 会话开始 |
| `session:end` | ACP 会话结束 |
| `prompt:before` | Prompt 即将发送（拦截点） |
| `prompt:after` | Agent 完成了一次 Prompt 响应 |
| `error` | Agent 遇到运行时错误 |
| `idle` | Agent 进入空闲状态 |

### 调度事件

| 事件 | 触发时机 |
|------|---------|
| `heartbeat:tick` | 心跳定时触发 |
| `cron:*` | Cron 表达式匹配时触发（动态） |

### 用户事件

| 事件 | 触发时机 |
|------|---------|
| `user:dispatch` | 用户通过 CLI/API 派发任务 |
| `user:run` | 用户执行 one-shot 运行 |
| `user:prompt` | 用户向运行中的 Agent 发送 Prompt |

### 扩展事件

| 事件 | 触发时机 |
|------|---------|
| `plugin:*` | Plugin 自定义事件（动态） |
| `custom:*` | 自定义扩展事件（动态） |

## 动作类型

每个 Hook 可以绑定一个或多个按顺序执行的 Action。

### Shell 动作

执行一条 Shell 命令，支持变量插值：

```json
{ "type": "shell", "run": "echo Agent ${agent.name} crashed at ${timestamp}" }
```

### 内置动作

调用平台内置函数：

```json
{ "type": "builtin", "action": "actant.log", "params": { "event": "${event}" } }
```

可用的内置动作：

| 名称 | 说明 |
|------|------|
| `actant.log` | 将事件记录到 Actant 日志 |
| `actant.healthcheck` | 返回健康检查结果 |
| `actant.notify` | 发送通知（参数：`channel`、`message`） |

### Agent 动作

向另一个 Agent 发送 Prompt：

```json
{ "type": "agent", "target": "ops-agent", "prompt": "Agent ${agent.name} 崩溃了，请检查日志" }
```

### 变量插值

所有动作的字符串字段支持 `${...}` 插值：

| 变量 | 值 |
|------|------|
| `${agent.name}` | 触发事件的 Agent 名称 |
| `${event}` | 事件名称 |
| `${timestamp}` | ISO 时间戳 |

## 配置

Hook 通过 Workflow 文件声明，放在模板的 `domainContext.workflow` 中引用。

### Workflow 文件示例

```json
{
  "name": "crash-alert",
  "version": "1.0.0",
  "description": "Agent 崩溃时自动告警",
  "enabled": true,
  "level": "actant",
  "hooks": [
    {
      "on": "process:crash",
      "description": "崩溃时发送 Shell 通知并记录日志",
      "priority": 10,
      "actions": [
        { "type": "shell", "run": "curl -X POST https://hooks.slack.com/... -d '{\"text\": \"${agent.name} crashed\"}'" },
        { "type": "builtin", "action": "actant.log" }
      ]
    },
    {
      "on": "agent:created",
      "description": "新 Agent 创建时通知运维 Agent",
      "actions": [
        { "type": "agent", "target": "ops-agent", "prompt": "新 Agent ${agent.name} 已创建，请检查配置" }
      ],
      "allowedCallers": ["system", "user"]
    }
  ]
}
```

### 在模板中引用

```json
{
  "name": "my-agent",
  "domainContext": {
    "workflow": "crash-alert"
  }
}
```

### Hook 声明字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `on` | string | 是 | 监听的事件名称 |
| `actions` | Action[] | 是 | 触发后执行的动作列表（按顺序） |
| `priority` | number | 否 | 执行优先级（数字越小越先执行），默认 100 |
| `description` | string | 否 | 人类可读的说明 |
| `allowedCallers` | string[] | 否 | 限制事件来源：`system`、`user`、`agent`、`plugin` |
| `condition` | string | 否 | 条件表达式（规划中） |
| `retry` | object | 否 | 重试策略（规划中） |
| `timeoutMs` | number | 否 | 超时时间（规划中） |

### 作用域

| 级别 | `level` | 说明 |
|------|---------|------|
| 全局 | `"actant"` | 监听平台所有事件 |
| 实例 | `"instance"` | 仅监听绑定 Agent 的事件 |

## 工作原理

```
事件发生（如 Agent 崩溃）
    │
    ▼
HookEventBus 广播事件
    │
    ▼
HookRegistry 查找匹配的 Hook
  · 按事件名匹配
  · 按作用域过滤（instance 级别只看绑定的 Agent）
  · 按 allowedCallers 过滤
  · 按 priority 排序
    │
    ▼
ActionRunner 按顺序执行每个 Action
  · shell → 执行命令（30s 超时）
  · builtin → 调用内置函数
  · agent → 向目标 Agent 发送 Prompt
```

## 使用场景

| 场景 | 配置 |
|------|------|
| 崩溃告警 | `on: "process:crash"` → Shell 发送 webhook |
| 自动审查 | `on: "agent:created"` → Agent 动作通知审查 Agent |
| 定时巡检 | `on: "cron:0 9 * * *"` → Shell 执行脚本 |
| 空闲通知 | `on: "idle"` → Builtin 记录日志 |
| 级联任务 | `on: "prompt:after"` → Agent 动作触发下一个 Agent |

---

详见源码 `packages/core/src/hooks/` 和 `packages/shared/src/types/hook.types.ts`。
