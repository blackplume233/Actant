{
  "name": "multi-session-isolation",
  "description": "验证多 Session 并发创建、隔离和独立管理：多客户端 session.list、独立 cancel/close",
  "tags": ["session", "multi-client", "isolation", "concurrent", "issue-35"],
  "setup": {
    "daemon": true,
    "launcherMode": "real",
    "templates": [
      {
        "name": "multi-tpl",
        "inline": {
          "name": "multi-tpl",
          "version": "1.0.0",
          "description": "Multi-session isolation test",
          "backend": {
            "type": "claude-code",
            "config": { "model": "claude-sonnet-4-20250514" }
          },
          "provider": {
            "type": "anthropic",
            "config": { "apiKeyEnv": "ANTHROPIC_API_KEY" }
          },
          "domainContext": {}
        }
      }
    ]
  },
  "steps": [
    {
      "id": "create-agent",
      "description": "创建 Agent 实例",
      "command": "agent create multi-agent -t multi-tpl",
      "expect": "退出码 0"
    },
    {
      "id": "start-agent",
      "description": "启动 Agent（需要真实 claude-code 后端）",
      "command": "agent start multi-agent",
      "expect": "退出码 0，agent 进入 running 状态"
    },
    {
      "id": "create-session-a",
      "description": "客户端 A 创建 session",
      "command": "RPC session.create {\"agentName\":\"multi-agent\",\"clientId\":\"client-a\"}",
      "expect": "返回 SessionLeaseInfo，state=active，sessionId 不为空"
    },
    {
      "id": "create-session-b",
      "description": "客户端 B 创建 session",
      "command": "RPC session.create {\"agentName\":\"multi-agent\",\"clientId\":\"client-b\"}",
      "expect": "返回不同的 sessionId，state=active"
    },
    {
      "id": "list-sessions",
      "description": "列出所有 sessions",
      "command": "RPC session.list {\"agentName\":\"multi-agent\"}",
      "expect": "返回 2 个 session，分别对应 client-a 和 client-b"
    },
    {
      "id": "cancel-session-a",
      "description": "取消 session A",
      "command": "RPC session.cancel {\"sessionId\":\"<session-a-id>\"}",
      "expect": "返回 {ok: true}"
    },
    {
      "id": "close-session-a",
      "description": "关闭 session A",
      "command": "RPC session.close {\"sessionId\":\"<session-a-id>\"}",
      "expect": "返回 {ok: true}"
    },
    {
      "id": "list-after-close",
      "description": "关闭 A 后列出 sessions",
      "command": "RPC session.list {\"agentName\":\"multi-agent\"}",
      "expect": "返回 1 个 session（仅 client-b）"
    },
    {
      "id": "close-session-b",
      "description": "关闭 session B",
      "command": "RPC session.close {\"sessionId\":\"<session-b-id>\"}",
      "expect": "返回 {ok: true}"
    },
    {
      "id": "list-empty",
      "description": "所有 session 关闭后列表为空",
      "command": "RPC session.list {\"agentName\":\"multi-agent\"}",
      "expect": "返回空数组"
    }
  ],
  "cleanup": [
    "agent stop multi-agent",
    "agent destroy multi-agent --force"
  ],
  "notes": [
    "此场景需要 launcherMode=real 和可用的 claude 命令",
    "Session ID 需要在执行时动态获取并替换",
    "验证要点：不同 clientId 获得不同 sessionId，session 操作互不影响",
    "参见 Issue #39: mock 模式下无法运行此场景"
  ]
}
