{
  "name": "proxy-lease-mode",
  "description": "验证 proxy 命令的 Direct Bridge 和 Session Lease 双模式行为、--template 自动创建、错误处理",
  "tags": ["proxy", "lease", "direct-bridge", "issue-35"],
  "setup": {
    "daemon": true,
    "launcherMode": "mock",
    "templates": [
      {
        "name": "proxy-tpl",
        "inline": {
          "name": "proxy-tpl",
          "version": "1.0.0",
          "backend": { "type": "cursor" },
          "provider": { "type": "anthropic" },
          "domainContext": {}
        }
      }
    ]
  },
  "steps": [
    {
      "id": "proxy-help",
      "description": "proxy --help 显示双模式选项",
      "command": "proxy --help",
      "expect": "输出包含 --lease 和 -t, --template 选项"
    },
    {
      "id": "proxy-nonexistent",
      "description": "Direct Bridge 模式访问不存在的 agent",
      "command": "proxy ghost-agent",
      "expect": "返回 'Agent instance not found'"
    },
    {
      "id": "proxy-lease-nonexistent",
      "description": "Session Lease 模式访问不存在的 agent",
      "command": "proxy ghost-agent --lease",
      "expect": "返回 'Agent instance not found'"
    },
    {
      "id": "create-proxy-agent",
      "description": "创建 Agent 用于 proxy 测试",
      "command": "agent create proxy-test -t proxy-tpl",
      "expect": "退出码 0"
    },
    {
      "id": "proxy-lease-not-running",
      "description": "Session Lease 模式访问未运行的 agent",
      "command": "proxy proxy-test --lease",
      "expect": "返回 'not running' 提示"
    },
    {
      "id": "proxy-auto-create",
      "description": "Direct Bridge + --template 自动创建 agent",
      "command": "proxy auto-proxy -t proxy-tpl",
      "expect": "自动创建 auto-proxy agent（即使 spawn 失败，agent 应已创建）",
      "artifacts": "agent list 应包含 auto-proxy"
    }
  ],
  "cleanup": [
    "agent destroy proxy-test --force",
    "agent destroy auto-proxy --force"
  ],
  "notes": [
    "Direct Bridge spawn 在 mock 模式下因无真实后端进程会返回 EINVAL",
    "Session Lease 模式需要 agent 已 running 且有 ACP 连接",
    "--lease 与 --template 组合时，--template 被静默忽略（设计如此）"
  ]
}
