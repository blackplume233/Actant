{
  "name": "ultimate-real-user-journey",
  "description": "终极全旅程 QA 场景 — 模拟真实用户从首次安装到高级使用的完整旅程。覆盖全部 68 个 CLI 子命令、15 个命令组、多后端（cursor/claude-code/pi）、域组件全生命周期 CRUD + Export/Reimport roundtrip、Source/Preset 生态、Session/Proxy、调度器、安全模型、幂等性、边界条件等。设计执行时间 30-45 分钟。",
  "tags": ["ultimate", "full-coverage", "real-user", "30min+", "regression", "lifecycle", "domain-crud", "source", "preset", "session", "proxy", "scheduler", "security", "idempotency", "edge-case", "multi-backend"],
  "setup": {
    "daemon": true,
    "launcherMode": "real",
    "templates": [
      {
        "name": "qa-cursor-tpl",
        "inline": {
          "name": "qa-cursor-tpl",
          "version": "1.0.0",
          "description": "QA cursor backend - basic",
          "backend": { "type": "cursor" },
          "domainContext": {}
        }
      },
      {
        "name": "qa-claude-tpl",
        "inline": {
          "name": "qa-claude-tpl",
          "version": "1.0.0",
          "description": "QA claude-code backend",
          "backend": { "type": "claude-code" },
          "provider": { "type": "anthropic" },
          "domainContext": {}
        }
      },
      {
        "name": "qa-pi-tpl",
        "inline": {
          "name": "qa-pi-tpl",
          "version": "1.0.0",
          "description": "QA Pi backend with LLM provider",
          "backend": { "type": "pi" },
          "provider": { "type": "anthropic", "config": { "apiKeyEnv": "ANTHROPIC_API_KEY" } },
          "domainContext": {}
        }
      },
      {
        "name": "qa-rich-tpl",
        "inline": {
          "name": "qa-rich-tpl",
          "version": "1.0.0",
          "description": "QA full domain context materialization template",
          "backend": { "type": "cursor" },
          "domainContext": {
            "skills": ["code-review", "typescript-expert"],
            "prompts": ["system-code-reviewer"],
            "mcpServers": [{ "name": "filesystem", "command": "npx", "args": ["-y", "@anthropic/mcp-filesystem"] }],
            "workflow": "trellis-standard",
            "plugins": ["web-search"]
          }
        }
      },
      {
        "name": "qa-sched-tpl",
        "inline": {
          "name": "qa-sched-tpl",
          "version": "1.0.0",
          "description": "QA Pi backend with heartbeat scheduler",
          "backend": { "type": "pi" },
          "provider": { "type": "anthropic", "config": { "apiKeyEnv": "ANTHROPIC_API_KEY" } },
          "schedule": { "heartbeat": { "intervalMs": 30000 } },
          "domainContext": {}
        }
      },
      {
        "name": "qa-sec-tpl",
        "inline": {
          "name": "qa-sec-tpl",
          "version": "1.0.0",
          "description": "QA security model verification template",
          "backend": { "type": "cursor" },
          "provider": { "type": "anthropic", "config": { "apiKeyEnv": "ANTHROPIC_API_KEY" } },
          "domainContext": {}
        }
      }
    ],
    "fixtures": {
      "skill1": "configs/skills/code-review.json",
      "skill2": "configs/skills/typescript-expert.json",
      "prompt1": "configs/prompts/system-code-reviewer.json",
      "mcp1": "configs/mcp/filesystem.json",
      "workflow1": "configs/workflows/trellis-standard.json",
      "plugin1": "configs/plugins/web-search-plugin.json",
      "plugin2": "configs/plugins/memory-plugin.json",
      "template1": "configs/templates/code-review-agent.json",
      "invalidTemplate": { "inline": { "not-a-valid-template": true } }
    }
  },

  "steps": [

    {"id":"p0-version","description":"[Phase 0 基础设施] CLI 版本号","command":"--version","expect":"输出语义化版本号（如 0.2.2），退出码 0"},
    {"id":"p0-help","description":"[Phase 0 基础设施] CLI 帮助信息","command":"--help","expect":"输出帮助信息，列出全部子命令组（agent, template, daemon, skill, prompt, mcp, workflow, plugin, source, preset, schedule, proxy, setup, self-update, help），退出码 0"},
    {"id":"p0-help-agent","description":"[Phase 0 基础设施] Agent 子命令帮助","command":"help agent","expect":"列出 agent 的全部子命令（create, start, stop, destroy, status, list, resolve, open, adopt, attach, detach, run, prompt, chat, dispatch, tasks, logs），退出码 0"},
    {"id":"p0-help-template","description":"[Phase 0 基础设施] Template 子命令帮助","command":"help template","expect":"列出 template 子命令（list, show, validate, load, install），退出码 0"},
    {"id":"p0-help-source","description":"[Phase 0 基础设施] Source 子命令帮助","command":"help source","expect":"列出 source 子命令（list, add, remove, sync, validate），退出码 0"},

    {"id":"p1-setup-fullskip","description":"[Phase 1 Setup] 全跳过模式 — 验证 setup 命令基本流程","command":"setup --skip-home --skip-provider --skip-source --skip-agent --skip-autostart --skip-hello --skip-update","expect":"退出码 0，输出 Setup Complete 摘要，输出包含工作目录路径"},
    {"id":"p1-setup-verify-config","description":"[Phase 1 Setup] 白盒验证 config.json 存在","command":"_whitebox_read:$ACTANT_HOME/config.json","expect":"文件存在且为合法 JSON，包含 devSourcePath 和 update 字段","artifacts":"$ACTANT_HOME/config.json 存在"},
    {"id":"p1-setup-verify-dirs","description":"[Phase 1 Setup] 白盒验证目录结构通过 template list","command":"template list -f json","expect":"退出码 0（daemon 可正常操作目录结构），返回数组"},
    {"id":"p1-setup-repeat","description":"[Phase 1 Setup] 重复运行全跳过 setup（幂等性）","command":"setup --skip-home --skip-provider --skip-source --skip-agent --skip-autostart --skip-hello --skip-update","expect":"退出码 0，输出 Setup Complete，不报错不崩溃"},
    {"id":"p1-setup-config-unchanged","description":"[Phase 1 Setup] 白盒验证重复 setup 后 config.json 仍合法","command":"_whitebox_read:$ACTANT_HOME/config.json","expect":"文件内容仍为合法 JSON，结构完整"},
    {"id":"p1-setup-partial","description":"[Phase 1 Setup] 部分跳过（非 TTY 场景）— 不跳过 source","command":"setup --skip-home --skip-provider --skip-agent --skip-autostart --skip-hello --skip-update","expect":"触发 ExitPromptError / 用户取消处理，或直接完成。非 TTY 下 @inquirer/prompts 可能挂起或立即取消","note":"非 TTY 场景下可能出现「已取消设置向导」或正常完成（取决于 daemon 状态和 stdin 行为）"},
    {"id":"p1-setup-skiponly-home","description":"[Phase 1 Setup] 仅跳过 home，验证 ACTANT_HOME 环境变量被使用","command":"setup --skip-home --skip-provider --skip-source --skip-agent --skip-autostart --skip-hello --skip-update","expect":"退出码 0，输出包含 $ACTANT_HOME 路径而非默认 ~/.actant"},
    {"id":"p1-setup-config-structure","description":"[Phase 1 Setup] 白盒验证 config.json 完整结构","command":"_whitebox_read:$ACTANT_HOME/config.json","expect":"JSON 包含 devSourcePath（string）和 update 对象（含 maxBackups、preUpdateTestCommand、autoRestartAgents）"},

    {"id":"p2-tpl-list-init","description":"[Phase 2 Template] 列出初始模板（应含 setup 加载的 6 个）","command":"template list -f json","expect":"返回数组包含 qa-cursor-tpl、qa-claude-tpl、qa-pi-tpl、qa-rich-tpl、qa-sched-tpl、qa-sec-tpl"},
    {"id":"p2-tpl-show-cursor","description":"[Phase 2 Template] 查看 cursor 模板详情","command":"template show qa-cursor-tpl -f json","expect":"返回 JSON，name=qa-cursor-tpl，version=1.0.0，backend.type=cursor"},
    {"id":"p2-tpl-show-pi","description":"[Phase 2 Template] 查看 Pi 模板详情","command":"template show qa-pi-tpl -f json","expect":"返回 JSON，name=qa-pi-tpl，backend.type=pi，provider.type=anthropic"},
    {"id":"p2-tpl-show-sched","description":"[Phase 2 Template] 查看 scheduler 模板详情","command":"template show qa-sched-tpl -f json","expect":"返回 JSON，包含 schedule.heartbeat.intervalMs=30000"},
    {"id":"p2-tpl-validate-valid","description":"[Phase 2 Template] 验证合法模板文件","command":"template validate $FIXTURE_DIR/code-review-agent.json","expect":"输出 Valid 或确认信息，包含模板名 code-review-agent，退出码 0"},
    {"id":"p2-tpl-load-file","description":"[Phase 2 Template] 从文件加载模板","command":"template load $FIXTURE_DIR/code-review-agent.json","expect":"成功加载，退出码 0"},
    {"id":"p2-tpl-list-after-load","description":"[Phase 2 Template] 加载后列出（应为 7 个）","command":"template list -f json","expect":"返回数组，现在包含 code-review-agent"},
    {"id":"p2-tpl-show-loaded","description":"[Phase 2 Template] 查看刚加载的模板","command":"template show code-review-agent -f json","expect":"返回 JSON，name=code-review-agent，backend.type=claude-code，domainContext.skills 包含 code-review"},
    {"id":"p2-tpl-persist-check","description":"[Phase 2 Template] 白盒验证模板持久化","command":"_whitebox_read:$ACTANT_HOME/configs/templates/code-review-agent.json","expect":"文件存在且为合法 JSON，包含 name=code-review-agent","artifacts":"$ACTANT_HOME/configs/templates/code-review-agent.json 存在"},
    {"id":"p2-tpl-validate-invalid","description":"[Phase 2 Template] 验证无效模板文件","command":"template validate $FIXTURE_DIR/invalid-template.json","expect":"退出码非 0 或输出 Invalid/errors 信息"},
    {"id":"p2-tpl-validate-nofile","description":"[Phase 2 Template] 验证不存在的文件","command":"template validate /tmp/nonexistent-qa-file-xyz-99999.json","expect":"退出码非 0，错误信息提示文件不存在或无法读取"},
    {"id":"p2-tpl-show-nonexist","description":"[Phase 2 Template] 查看不存在的模板","command":"template show nonexistent-tpl-xyz-99","expect":"退出码非 0，错误信息提示模板不存在"},

    {"id":"p3-skill-list-init","description":"[Phase 3 Skill] 列出 skills（初始状态）","command":"skill list -f json","expect":"返回数组（可能为空或含 source 加载的 skill），退出码 0"},
    {"id":"p3-skill-add-1","description":"[Phase 3 Skill] 添加 code-review skill","command":"skill add $FIXTURE_DIR/code-review.json","expect":"成功添加，退出码 0"},
    {"id":"p3-skill-add-2","description":"[Phase 3 Skill] 添加 typescript-expert skill","command":"skill add $FIXTURE_DIR/typescript-expert.json","expect":"成功添加，退出码 0"},
    {"id":"p3-skill-list-two","description":"[Phase 3 Skill] 添加后列出（至少 2 个）","command":"skill list -f json","expect":"返回数组，包含 code-review 和 typescript-expert"},
    {"id":"p3-skill-show-1","description":"[Phase 3 Skill] 查看 code-review 详情","command":"skill show code-review -f json","expect":"返回 JSON，name=code-review，content 包含 Code Review Checklist，tags 包含 review"},
    {"id":"p3-skill-show-2","description":"[Phase 3 Skill] 查看 typescript-expert 详情","command":"skill show typescript-expert -f json","expect":"返回 JSON，name=typescript-expert，content 包含 TypeScript Best Practices"},
    {"id":"p3-skill-export","description":"[Phase 3 Skill] 导出 code-review 到文件","command":"skill export code-review -o $TEST_DIR/exported-skill.json","expect":"成功导出，退出码 0","artifacts":"$TEST_DIR/exported-skill.json 文件应存在且内容合法"},
    {"id":"p3-skill-verify-export","description":"[Phase 3 Skill] 白盒验证导出文件","command":"_whitebox_read:$TEST_DIR/exported-skill.json","expect":"文件为合法 JSON，包含 name=code-review 和 content 字段"},
    {"id":"p3-skill-remove","description":"[Phase 3 Skill] 移除 code-review","command":"skill remove code-review","expect":"成功移除，退出码 0"},
    {"id":"p3-skill-list-after-rm","description":"[Phase 3 Skill] 移除后列出","command":"skill list -f json","expect":"code-review 已不在列表中，typescript-expert 仍存在"},
    {"id":"p3-skill-reimport","description":"[Phase 3 Skill] 从导出文件重新导入（roundtrip 验证）","command":"skill add $TEST_DIR/exported-skill.json","expect":"成功导入，退出码 0"},
    {"id":"p3-skill-show-reimport","description":"[Phase 3 Skill] 验证 roundtrip 后数据完整","command":"skill show code-review -f json","expect":"返回 JSON，name=code-review，content 与原始一致"},

    {"id":"p3-prompt-list-init","description":"[Phase 3 Prompt] 列出 prompts（初始状态）","command":"prompt list -f json","expect":"返回数组，退出码 0"},
    {"id":"p3-prompt-add","description":"[Phase 3 Prompt] 添加 system-code-reviewer","command":"prompt add $FIXTURE_DIR/system-code-reviewer.json","expect":"成功添加，退出码 0"},
    {"id":"p3-prompt-list-after","description":"[Phase 3 Prompt] 添加后列出","command":"prompt list -f json","expect":"返回数组包含 system-code-reviewer"},
    {"id":"p3-prompt-show","description":"[Phase 3 Prompt] 查看详情","command":"prompt show system-code-reviewer -f json","expect":"返回 JSON，name=system-code-reviewer，content 包含 senior code reviewer，variables 包含 project"},
    {"id":"p3-prompt-export","description":"[Phase 3 Prompt] 导出到文件","command":"prompt export system-code-reviewer -o $TEST_DIR/exported-prompt.json","expect":"成功导出，退出码 0","artifacts":"$TEST_DIR/exported-prompt.json 存在"},
    {"id":"p3-prompt-verify-export","description":"[Phase 3 Prompt] 白盒验证导出文件","command":"_whitebox_read:$TEST_DIR/exported-prompt.json","expect":"合法 JSON，包含 name=system-code-reviewer 和 content"},
    {"id":"p3-prompt-remove","description":"[Phase 3 Prompt] 移除","command":"prompt remove system-code-reviewer","expect":"成功移除，退出码 0"},
    {"id":"p3-prompt-list-after-rm","description":"[Phase 3 Prompt] 移除后确认","command":"prompt list -f json","expect":"system-code-reviewer 已不在列表中"},
    {"id":"p3-prompt-reimport","description":"[Phase 3 Prompt] 从导出文件重新导入","command":"prompt add $TEST_DIR/exported-prompt.json","expect":"成功导入，退出码 0"},
    {"id":"p3-prompt-show-reimport","description":"[Phase 3 Prompt] 验证 roundtrip 数据完整","command":"prompt show system-code-reviewer -f json","expect":"返回 JSON 与原始一致，content 包含 senior code reviewer"},

    {"id":"p3-mcp-list-init","description":"[Phase 3 MCP] 列出 MCP 配置（初始状态）","command":"mcp list -f json","expect":"返回数组，退出码 0"},
    {"id":"p3-mcp-add","description":"[Phase 3 MCP] 添加 filesystem MCP","command":"mcp add $FIXTURE_DIR/filesystem.json","expect":"成功添加，退出码 0"},
    {"id":"p3-mcp-list-after","description":"[Phase 3 MCP] 添加后列出","command":"mcp list -f json","expect":"返回数组包含 filesystem"},
    {"id":"p3-mcp-show","description":"[Phase 3 MCP] 查看详情","command":"mcp show filesystem -f json","expect":"返回 JSON，name=filesystem，command=npx，args 包含 @anthropic/mcp-filesystem"},
    {"id":"p3-mcp-export","description":"[Phase 3 MCP] 导出到文件","command":"mcp export filesystem -o $TEST_DIR/exported-mcp.json","expect":"成功导出，退出码 0","artifacts":"$TEST_DIR/exported-mcp.json 存在"},
    {"id":"p3-mcp-verify-export","description":"[Phase 3 MCP] 白盒验证导出文件","command":"_whitebox_read:$TEST_DIR/exported-mcp.json","expect":"合法 JSON，包含 name=filesystem 和 command=npx"},
    {"id":"p3-mcp-remove","description":"[Phase 3 MCP] 移除","command":"mcp remove filesystem","expect":"成功移除，退出码 0"},
    {"id":"p3-mcp-list-after-rm","description":"[Phase 3 MCP] 移除后确认","command":"mcp list -f json","expect":"filesystem 已不在列表中"},
    {"id":"p3-mcp-reimport","description":"[Phase 3 MCP] 从导出文件重新导入","command":"mcp add $TEST_DIR/exported-mcp.json","expect":"成功导入，退出码 0"},
    {"id":"p3-mcp-show-reimport","description":"[Phase 3 MCP] 验证 roundtrip 数据完整","command":"mcp show filesystem -f json","expect":"返回 JSON 与原始一致"},

    {"id":"p3-wf-list-init","description":"[Phase 3 Workflow] 列出 workflows（初始状态）","command":"workflow list -f json","expect":"返回数组，退出码 0"},
    {"id":"p3-wf-add","description":"[Phase 3 Workflow] 添加 trellis-standard","command":"workflow add $FIXTURE_DIR/trellis-standard.json","expect":"成功添加，退出码 0"},
    {"id":"p3-wf-list-after","description":"[Phase 3 Workflow] 添加后列出","command":"workflow list -f json","expect":"返回数组包含 trellis-standard"},
    {"id":"p3-wf-show","description":"[Phase 3 Workflow] 查看详情","command":"workflow show trellis-standard -f json","expect":"返回 JSON，name=trellis-standard，content 包含 Development Workflow"},
    {"id":"p3-wf-export","description":"[Phase 3 Workflow] 导出到文件","command":"workflow export trellis-standard -o $TEST_DIR/exported-wf.json","expect":"成功导出，退出码 0","artifacts":"$TEST_DIR/exported-wf.json 存在"},
    {"id":"p3-wf-verify-export","description":"[Phase 3 Workflow] 白盒验证导出文件","command":"_whitebox_read:$TEST_DIR/exported-wf.json","expect":"合法 JSON，包含 name=trellis-standard"},
    {"id":"p3-wf-remove","description":"[Phase 3 Workflow] 移除","command":"workflow remove trellis-standard","expect":"成功移除，退出码 0"},
    {"id":"p3-wf-list-after-rm","description":"[Phase 3 Workflow] 移除后确认","command":"workflow list -f json","expect":"trellis-standard 已不在列表中"},
    {"id":"p3-wf-reimport","description":"[Phase 3 Workflow] 从导出文件重新导入","command":"workflow add $TEST_DIR/exported-wf.json","expect":"成功导入，退出码 0"},
    {"id":"p3-wf-show-reimport","description":"[Phase 3 Workflow] 验证 roundtrip 数据完整","command":"workflow show trellis-standard -f json","expect":"返回 JSON 与原始一致"},

    {"id":"p3-plugin-list-init","description":"[Phase 3 Plugin] 列出 plugins（初始状态）","command":"plugin list -f json","expect":"返回数组，退出码 0"},
    {"id":"p3-plugin-add-1","description":"[Phase 3 Plugin] 添加 web-search plugin","command":"plugin add $FIXTURE_DIR/web-search-plugin.json","expect":"成功添加，退出码 0"},
    {"id":"p3-plugin-add-2","description":"[Phase 3 Plugin] 添加 memory plugin","command":"plugin add $FIXTURE_DIR/memory-plugin.json","expect":"成功添加，退出码 0"},
    {"id":"p3-plugin-list-two","description":"[Phase 3 Plugin] 添加后列出（至少 2 个）","command":"plugin list -f json","expect":"返回数组包含 web-search 和 memory"},
    {"id":"p3-plugin-show-1","description":"[Phase 3 Plugin] 查看 web-search 详情","command":"plugin show web-search -f json","expect":"返回 JSON，name=web-search，type=npm，enabled=true"},
    {"id":"p3-plugin-show-2","description":"[Phase 3 Plugin] 查看 memory 详情","command":"plugin show memory -f json","expect":"返回 JSON，name=memory，config.storage=local"},
    {"id":"p3-plugin-export","description":"[Phase 3 Plugin] 导出 web-search 到文件","command":"plugin export web-search -o $TEST_DIR/exported-plugin.json","expect":"成功导出，退出码 0","artifacts":"$TEST_DIR/exported-plugin.json 存在"},
    {"id":"p3-plugin-verify-export","description":"[Phase 3 Plugin] 白盒验证导出文件","command":"_whitebox_read:$TEST_DIR/exported-plugin.json","expect":"合法 JSON，包含 name=web-search"},
    {"id":"p3-plugin-remove","description":"[Phase 3 Plugin] 移除 web-search","command":"plugin remove web-search","expect":"成功移除，退出码 0"},
    {"id":"p3-plugin-list-after-rm","description":"[Phase 3 Plugin] 移除后确认","command":"plugin list -f json","expect":"web-search 已不在列表中，memory 仍存在"},
    {"id":"p3-plugin-reimport","description":"[Phase 3 Plugin] 从导出文件重新导入","command":"plugin add $TEST_DIR/exported-plugin.json","expect":"成功导入，退出码 0"},
    {"id":"p3-plugin-show-reimport","description":"[Phase 3 Plugin] 验证 roundtrip 数据完整","command":"plugin show web-search -f json","expect":"返回 JSON，name=web-search，与原始一致"},

    {"id":"p4-source-list-init","description":"[Phase 4 Source] 列出 sources（应含 actant-hub 默认源）","command":"source list -f json","expect":"返回数组，包含 actant-hub（类型 github），退出码 0"},
    {"id":"p4-source-sync-hub","description":"[Phase 4 Source] 同步 actant-hub 默认源（需网络，耗时较长）","command":"source sync actant-hub","expect":"同步完成，输出同步报告（added/updated/removed 数量），退出码 0","note":"此步需要网络访问 github.com/blackplume233/actant-hub.git。如无网络，WARN 即可"},
    {"id":"p4-source-list-synced","description":"[Phase 4 Source] 同步后列出","command":"source list -f json","expect":"actant-hub 显示已同步状态和组件数量"},
    {"id":"p4-source-validate-hub","description":"[Phase 4 Source] 验证 actant-hub 源完整性","command":"source validate actant-hub","expect":"退出码 0，输出验证结果（各组件类型数量）"},
    {"id":"p4-source-validate-strict","description":"[Phase 4 Source] 严格模式验证","command":"source validate actant-hub --strict","expect":"退出码 0（严格模式下无警告），或退出码 1（有警告时 --strict 将其视为错误）"},
    {"id":"p4-source-add-local","description":"[Phase 4 Source] 添加本地 source（使用项目 configs/ 目录）","command":"source add $PROJECT_ROOT/configs --name qa-local --type local","expect":"成功添加，退出码 0","note":"$PROJECT_ROOT 应替换为项目根目录绝对路径"},
    {"id":"p4-source-list-with-local","description":"[Phase 4 Source] 添加后列出（应含 actant-hub + qa-local）","command":"source list -f json","expect":"返回数组包含 actant-hub 和 qa-local"},
    {"id":"p4-source-sync-local","description":"[Phase 4 Source] 同步本地源","command":"source sync qa-local","expect":"同步完成，退出码 0"},
    {"id":"p4-source-validate-local","description":"[Phase 4 Source] 验证本地源（configs/ 缺少 actant.json 清单）","command":"source validate qa-local","expect":"退出码 1，输出 Validation failed，因为 configs/ 目录缺少 actant.json 清单文件，但组件文件通过验证"},
    {"id":"p4-source-validate-path","description":"[Phase 4 Source] 使用 --path 直接验证目录（缺少 actant.json）","command":"source validate --path $PROJECT_ROOT/configs","expect":"退出码 1，输出 Validation failed，因为 configs/ 目录缺少 actant.json 清单文件，但组件文件通过验证"},
    {"id":"p4-source-remove-local","description":"[Phase 4 Source] 移除本地源","command":"source remove qa-local","expect":"成功移除，退出码 0"},
    {"id":"p4-source-list-after-rm","description":"[Phase 4 Source] 移除后确认","command":"source list -f json","expect":"qa-local 已不在列表中，actant-hub 仍存在"},

    {"id":"p5-preset-list","description":"[Phase 5 Preset] 列出全部 presets","command":"preset list -f json","expect":"返回数组（如 actant-hub 已同步，应包含 web-dev、devops 等 preset），退出码 0"},
    {"id":"p5-preset-list-hub","description":"[Phase 5 Preset] 按 source 筛选 preset","command":"preset list actant-hub -f json","expect":"返回 actant-hub 的 preset 列表"},
    {"id":"p5-preset-show-webdev","description":"[Phase 5 Preset] 查看 web-dev preset 详情","command":"preset show actant-hub@web-dev -f json","expect":"返回 JSON，包含 preset 定义（skills、prompts、mcpServers 等引用），退出码 0"},
    {"id":"p5-preset-show-devops","description":"[Phase 5 Preset] 查看 devops preset 详情","command":"preset show actant-hub@devops -f json","expect":"返回 JSON，包含 devops 相关组件引用"},
    {"id":"p5-preset-show-nonexist","description":"[Phase 5 Preset] 查看不存在的 preset","command":"preset show nonexistent-pkg@nonexistent-preset","expect":"退出码非 0，错误信息提示 preset 不存在"},
    {"id":"p5-tpl-install","description":"[Phase 5 Preset] 从源安装模板","command":"template install actant-hub@code-reviewer","expect":"成功安装 code-reviewer 模板（从 actant-hub 源），退出码 0","note":"需要 actant-hub 已同步。安装后模板可通过 template show 查看"},
    {"id":"p5-preset-apply","description":"[Phase 5 Preset] 应用 preset 到模板（使用命名空间全名）","command":"preset apply actant-hub@web-dev actant-hub@code-reviewer","expect":"成功应用，退出码 0，模板的 domainContext 被 preset 扩展"},
    {"id":"p5-tpl-show-applied","description":"[Phase 5 Preset] 验证 preset 已合并到模板","command":"template show actant-hub@code-reviewer -f json","expect":"返回 JSON，domainContext 中应包含 web-dev preset 引入的额外 skills/prompts/mcp 等引用"},

    {"id":"p6-agent-list-empty","description":"[Phase 6 Agent 基础] 初始 Agent 列表","command":"agent list -f json","expect":"返回空数组，退出码 0"},
    {"id":"p6-agent-create","description":"[Phase 6 Agent 基础] 创建 cursor 后端 Agent","command":"agent create qa-cursor-1 -t qa-cursor-tpl -f json","expect":"返回 JSON，name=qa-cursor-1，status=created，退出码 0","artifacts":"$ACTANT_HOME/instances/qa-cursor-1/ 目录应被创建"},
    {"id":"p6-agent-list-after","description":"[Phase 6 Agent 基础] 创建后列出","command":"agent list -f json","expect":"返回数组包含 qa-cursor-1，status=created"},
    {"id":"p6-agent-status","description":"[Phase 6 Agent 基础] 查看状态","command":"agent status qa-cursor-1 -f json","expect":"返回 JSON，status=created，name=qa-cursor-1，backendType=cursor"},
    {"id":"p6-agent-wb-actant","description":"[Phase 6 Agent 基础] 白盒验证 .actant.json","command":"_whitebox_read:$ACTANT_HOME/instances/qa-cursor-1/.actant.json","expect":"合法 JSON，包含 name=qa-cursor-1、template=qa-cursor-tpl、backendType=cursor、status=created","artifacts":"$ACTANT_HOME/instances/qa-cursor-1/.actant.json 存在"},
    {"id":"p6-agent-wb-agents-md","description":"[Phase 6 Agent 基础] 白盒验证 AGENTS.md 存在","command":"_whitebox_read:$ACTANT_HOME/instances/qa-cursor-1/AGENTS.md","expect":"文件存在（即使内容可能为空或最小化）"},
    {"id":"p6-agent-wb-cursor-dir","description":"[Phase 6 Agent 基础] 白盒验证 .cursor/ 目录结构","command":"_whitebox_ls:$ACTANT_HOME/instances/qa-cursor-1/.cursor/","expect":".cursor/ 目录存在，可能包含 rules/ 子目录"},
    {"id":"p6-agent-resolve","description":"[Phase 6 Agent 基础] Resolve Agent（获取启动信息）","command":"agent resolve qa-cursor-1 -f json","expect":"返回 JSON，包含 command（cursor 或 cursor.cmd）和 args、workspaceDir，退出码 0"},
    {"id":"p6-agent-open","description":"[Phase 6 Agent 基础] Open Agent（在 IDE 中打开）","command":"agent open qa-cursor-1","expect":"退出码 0，或因 cursor 二进制不在 PATH 中而退出码非 0（均为合法行为）","note":"cursor binary 可能未安装。成功时会启动 Cursor IDE；失败时应有清晰错误信息"},
    {"id":"p6-agent-status-after-open","description":"[Phase 6 Agent 基础] Open 后状态不变","command":"agent status qa-cursor-1 -f json","expect":"status 仍为 created（open 不改变 agent 状态）"},
    {"id":"p6-agent-destroy","description":"[Phase 6 Agent 基础] 销毁 Agent","command":"agent destroy qa-cursor-1 --force","expect":"成功销毁，退出码 0"},
    {"id":"p6-agent-list-after-destroy","description":"[Phase 6 Agent 基础] 销毁后列出","command":"agent list -f json","expect":"qa-cursor-1 已不在列表中"},
    {"id":"p6-agent-wb-dir-removed","description":"[Phase 6 Agent 基础] 白盒验证实例目录已删除","command":"_whitebox_ls:$ACTANT_HOME/instances/qa-cursor-1/","expect":"目录不存在（已被删除）"},
    {"id":"p6-agent-destroy-no-force","description":"[Phase 6 Agent 基础] 不使用 --force 销毁（应拒绝）","command":"agent destroy nonexistent-agent-xyz","expect":"退出码 1，输出两行警告: Destroying agent ... will remove its entire workspace 和 Use --force to skip this warning"},
    {"id":"p6-agent-status-all","description":"[Phase 6 Agent 基础] 无参数 agent status（列出全部 Agent）","command":"agent status -f json","expect":"退出码 0，等价于 agent list，返回所有 Agent 的状态数组"},

    {"id":"p7-create-cursor","description":"[Phase 7 多后端] 创建 cursor 后端 Agent","command":"agent create mb-cursor -t qa-cursor-tpl -f json","expect":"成功创建，backendType=cursor"},
    {"id":"p7-create-claude","description":"[Phase 7 多后端] 创建 claude-code 后端 Agent","command":"agent create mb-claude -t qa-claude-tpl -f json","expect":"成功创建，backendType=claude-code"},
    {"id":"p7-create-pi","description":"[Phase 7 多后端] 创建 pi 后端 Agent","command":"agent create mb-pi -t qa-pi-tpl -f json","expect":"成功创建，backendType=pi"},
    {"id":"p7-list-three","description":"[Phase 7 多后端] 列出三个共存 Agent","command":"agent list -f json","expect":"返回数组包含 mb-cursor、mb-claude、mb-pi，各自 backendType 正确"},
    {"id":"p7-status-cursor","description":"[Phase 7 多后端] 验证 cursor Agent 状态","command":"agent status mb-cursor -f json","expect":"status=created，backendType=cursor"},
    {"id":"p7-status-claude","description":"[Phase 7 多后端] 验证 claude-code Agent 状态","command":"agent status mb-claude -f json","expect":"status=created，backendType=claude-code"},
    {"id":"p7-status-pi","description":"[Phase 7 多后端] 验证 pi Agent 状态","command":"agent status mb-pi -f json","expect":"status=created，backendType=pi"},
    {"id":"p7-resolve-cursor","description":"[Phase 7 多后端] Resolve cursor Agent","command":"agent resolve mb-cursor -f json","expect":"返回 command 为 cursor 相关二进制"},
    {"id":"p7-resolve-claude","description":"[Phase 7 多后端] Resolve claude-code Agent","command":"agent resolve mb-claude -f json","expect":"返回 command 为 claude 相关二进制"},
    {"id":"p7-wb-cursor-ws","description":"[Phase 7 多后端] 白盒: cursor 工作区包含 .cursor/","command":"_whitebox_ls:$ACTANT_HOME/instances/mb-cursor/.cursor/","expect":".cursor/ 目录存在"},
    {"id":"p7-wb-claude-ws","description":"[Phase 7 多后端] 白盒: claude-code 工作区包含 .claude/","command":"_whitebox_ls:$ACTANT_HOME/instances/mb-claude/.claude/","expect":".claude/ 目录存在（claude-code builder 产物）"},
    {"id":"p7-attach-bad-pid","description":"[Phase 7 多后端] Attach 不存在的 PID","command":"agent attach mb-cursor --pid 99999","expect":"退出码非 0，错误信息（进程不存在）"},
    {"id":"p7-detach-not-attached","description":"[Phase 7 多后端] Detach 未 attach 的 Agent","command":"agent detach mb-cursor","expect":"退出码非 0，提示 Agent 未被 attach"},
    {"id":"p7-adopt-prep","description":"[Phase 7 多后端] 白盒准备: 创建 adopt 用模拟工作区","command":"_setup:create_dir_with_file $TEST_DIR/mock-workspace/.actant.json {\"name\":\"mock-ws-agent\",\"status\":\"stopped\",\"template\":\"qa-cursor-tpl\",\"backendType\":\"cursor\",\"workspaceDir\":\"$TEST_DIR/mock-workspace\"}","expect":"目录和 .actant.json 文件创建成功","note":"QA agent 应使用 Shell mkdir + Write 工具创建目录和 JSON 文件"},
    {"id":"p7-adopt","description":"[Phase 7 多后端] Adopt 已有工作区","command":"agent adopt $TEST_DIR/mock-workspace --rename adopted-agent -f json","expect":"成功 adopt，返回 Agent 信息，退出码 0"},
    {"id":"p7-adopt-status","description":"[Phase 7 多后端] 验证 adopted Agent 状态（已知限制）","command":"agent status adopted-agent -f json","expect":"退出码非 0，Agent not found。已知架构限制：adopt 通过 instanceRegistry 注册但未同步到 agentManager 缓存","note":"adopt 注册与 agent manager 缓存不同步，已创建 Issue 跟踪"},
    {"id":"p7-adopt-destroy","description":"[Phase 7 多后端] 销毁 adopted Agent","command":"agent destroy adopted-agent --force","expect":"成功销毁，退出码 0"},
    {"id":"p7-destroy-cursor","description":"[Phase 7 多后端] 销毁 cursor Agent","command":"agent destroy mb-cursor --force","expect":"成功销毁"},
    {"id":"p7-destroy-claude","description":"[Phase 7 多后端] 销毁 claude Agent","command":"agent destroy mb-claude --force","expect":"成功销毁"},
    {"id":"p7-destroy-pi","description":"[Phase 7 多后端] 销毁 pi Agent","command":"agent destroy mb-pi --force","expect":"成功销毁"},
    {"id":"p7-list-empty","description":"[Phase 7 多后端] 确认全部销毁","command":"agent list -f json","expect":"返回空数组"},

    {"id":"p8-ctx-create","description":"[Phase 8 域上下文物化] 使用富模板创建 Agent","command":"agent create rich-agent -t qa-rich-tpl -f json","expect":"成功创建，name=rich-agent，退出码 0。可能有域组件引用警告（如果某些组件未加载），但创建应成功","artifacts":"$ACTANT_HOME/instances/rich-agent/ 完整工作区"},
    {"id":"p8-ctx-status","description":"[Phase 8 域上下文物化] 验证 Agent 创建成功","command":"agent status rich-agent -f json","expect":"status=created，backendType=cursor"},
    {"id":"p8-ctx-wb-rules-cr","description":"[Phase 8 域上下文物化] 白盒: code-review skill → .cursor/rules/code-review.mdc","command":"_whitebox_read:$ACTANT_HOME/instances/rich-agent/.cursor/rules/code-review.mdc","expect":"文件存在且内容非空，包含 Code Review Checklist 相关内容"},
    {"id":"p8-ctx-wb-rules-ts","description":"[Phase 8 域上下文物化] 白盒: typescript-expert skill → .cursor/rules/typescript-expert.mdc","command":"_whitebox_read:$ACTANT_HOME/instances/rich-agent/.cursor/rules/typescript-expert.mdc","expect":"文件存在且内容非空，包含 TypeScript Best Practices"},
    {"id":"p8-ctx-wb-agents-md","description":"[Phase 8 域上下文物化] 白盒: AGENTS.md 包含 skill 内容","command":"_whitebox_read:$ACTANT_HOME/instances/rich-agent/AGENTS.md","expect":"文件包含 code-review 和 typescript-expert 的 skill 内容"},
    {"id":"p8-ctx-wb-prompts","description":"[Phase 8 域上下文物化] 白盒: prompts/system.md 包含 prompt 内容","command":"_whitebox_read:$ACTANT_HOME/instances/rich-agent/prompts/system.md","expect":"文件包含 senior code reviewer 相关内容"},
    {"id":"p8-ctx-wb-mcp","description":"[Phase 8 域上下文物化] 白盒: .cursor/mcp.json 包含 MCP 配置","command":"_whitebox_read:$ACTANT_HOME/instances/rich-agent/.cursor/mcp.json","expect":"合法 JSON，包含 filesystem 服务配置，command=npx，args 包含 @anthropic/mcp-filesystem"},
    {"id":"p8-ctx-wb-workflow","description":"[Phase 8 域上下文物化] 白盒: .trellis/workflow.md 包含 workflow","command":"_whitebox_read:$ACTANT_HOME/instances/rich-agent/.trellis/workflow.md","expect":"文件包含 Development Workflow 相关内容"},
    {"id":"p8-ctx-wb-extensions","description":"[Phase 8 域上下文物化] 白盒: .cursor/extensions.json 包含 plugin 配置","command":"_whitebox_read:$ACTANT_HOME/instances/rich-agent/.cursor/extensions.json","expect":"合法 JSON，包含 web-search plugin 信息"},
    {"id":"p8-ctx-wb-actant-json","description":"[Phase 8 域上下文物化] 白盒: .actant.json 完整元数据","command":"_whitebox_read:$ACTANT_HOME/instances/rich-agent/.actant.json","expect":"合法 JSON，包含 domainContext 引用、template=qa-rich-tpl、backendType=cursor"},
    {"id":"p8-ctx-wb-cursor-settings","description":"[Phase 8 域上下文物化] 白盒: .cursor/settings.json 权限","command":"_whitebox_read:$ACTANT_HOME/instances/rich-agent/.cursor/settings.json","expect":"文件存在（可能为空对象或包含权限设置）"},
    {"id":"p8-ctx-resolve","description":"[Phase 8 域上下文物化] Resolve 验证物化完整","command":"agent resolve rich-agent -f json","expect":"退出码 0，返回 resolve 信息"},
    {"id":"p8-ctx-destroy","description":"[Phase 8 域上下文物化] 销毁并验证","command":"agent destroy rich-agent --force","expect":"成功销毁"},
    {"id":"p8-ctx-wb-dir-gone","description":"[Phase 8 域上下文物化] 白盒确认工作区删除","command":"_whitebox_ls:$ACTANT_HOME/instances/rich-agent/","expect":"目录不存在"},

    {"id":"p9-comm-create","description":"[Phase 9 Agent 通信] 创建 Pi 后端 Agent","command":"agent create comm-agent -t qa-pi-tpl -f json","expect":"成功创建，backendType=pi"},
    {"id":"p9-comm-start","description":"[Phase 9 Agent 通信] 启动 Pi Agent","command":"agent start comm-agent","expect":"成功启动，退出码 0。Pi 后端为 in-process，ACP 桥接启动","note":"Pi 需要 @actant/pi 包已构建。如失败，检查 build 状态"},
    {"id":"p9-comm-status-running","description":"[Phase 9 Agent 通信] 验证运行状态","command":"agent status comm-agent -f json","expect":"status=running"},
    {"id":"p9-comm-run","description":"[Phase 9 Agent 通信] agent run 发送 prompt","command":"agent run comm-agent --prompt \"Say hello in one word\" --timeout 30000","expect":"返回文本响应（LLM 回复），退出码 0。如无 API key，可能返回认证错误（WARN 级别）","note":"需要 ANTHROPIC_API_KEY 环境变量。无 key 时 LLM 调用失败属预期行为"},
    {"id":"p9-comm-prompt","description":"[Phase 9 Agent 通信] agent prompt 通过 ACP session","command":"agent prompt comm-agent -m \"What is 2+2?\" -f json","expect":"返回 JSON 包含 response 和 sessionId，退出码 0。如无 API key 或 agent run 超时后 ACP 连接可能已断开，返回错误（WARN）","note":"前一步 agent run 可能超时导致 ACP 连接中断，此步失败属预期行为"},
    {"id":"p9-comm-dispatch","description":"[Phase 9 Agent 通信] dispatch 后台任务","command":"agent dispatch comm-agent -m \"Background analysis task\" -p high","expect":"成功入队或提示调度器相关信息，退出码 0"},
    {"id":"p9-comm-tasks","description":"[Phase 9 Agent 通信] 查看任务队列","command":"agent tasks comm-agent -f json","expect":"返回 JSON 包含 queued/processing/tasks 字段，退出码 0"},
    {"id":"p9-comm-logs","description":"[Phase 9 Agent 通信] 查看执行日志","command":"agent logs comm-agent -f json","expect":"返回日志数组（可能为空），退出码 0"},
    {"id":"p9-comm-stop","description":"[Phase 9 Agent 通信] 停止 Agent","command":"agent stop comm-agent","expect":"成功停止，退出码 0"},
    {"id":"p9-comm-status-stopped","description":"[Phase 9 Agent 通信] 验证停止状态","command":"agent status comm-agent -f json","expect":"status=stopped"},
    {"id":"p9-comm-destroy","description":"[Phase 9 Agent 通信] 销毁通信测试 Agent","command":"agent destroy comm-agent --force","expect":"成功销毁"},
    {"id":"p9-err-dispatch-noagent","description":"[Phase 9 Agent 通信] dispatch 不存在的 Agent","command":"agent dispatch ghost-comm-xyz -m \"test\"","expect":"退出码非 0，错误信息"},
    {"id":"p9-err-prompt-stopped","description":"[Phase 9 Agent 通信] prompt 已停止的 Agent","command":"agent prompt ghost-comm-xyz -m \"test\"","expect":"退出码非 0，提示 Agent 不存在或未运行"},
    {"id":"p9-err-run-noagent","description":"[Phase 9 Agent 通信] run 不存在的 Agent","command":"agent run ghost-comm-xyz --prompt \"test\"","expect":"退出码非 0，错误信息"},

    {"id":"p10-sched-create","description":"[Phase 10 Scheduler] 创建带 heartbeat 的 Agent","command":"agent create sched-agent -t qa-sched-tpl -f json","expect":"成功创建，schedule 配置应包含 heartbeat"},
    {"id":"p10-sched-start","description":"[Phase 10 Scheduler] 启动带 scheduler 的 Agent","command":"agent start sched-agent","expect":"成功启动，退出码 0","note":"Pi backend + scheduler 配置。heartbeat intervalMs=30000"},
    {"id":"p10-sched-status","description":"[Phase 10 Scheduler] 验证运行状态","command":"agent status sched-agent -f json","expect":"status=running"},
    {"id":"p10-sched-list","description":"[Phase 10 Scheduler] 列出 schedule 源","command":"schedule list sched-agent -f json","expect":"返回 JSON，sources 包含 heartbeat 源，running=true"},
    {"id":"p10-sched-dispatch","description":"[Phase 10 Scheduler] 手动 dispatch 任务","command":"agent dispatch sched-agent -m \"Scheduled health check\" -p normal","expect":"queued=true 或成功入队信息"},
    {"id":"p10-sched-tasks","description":"[Phase 10 Scheduler] 查看任务队列","command":"agent tasks sched-agent -f json","expect":"返回包含刚 dispatch 的任务或处理中状态"},
    {"id":"p10-sched-dispatch-critical","description":"[Phase 10 Scheduler] dispatch 高优先级任务","command":"agent dispatch sched-agent -m \"Critical alert\" -p critical","expect":"成功入队或提示无调度器（调度器可能未完全就绪），退出码 0 或 1","note":"EmployeeScheduler 初始化可能存在时序问题，dispatch 可能在调度器就绪前执行"},
    {"id":"p10-sched-logs","description":"[Phase 10 Scheduler] 查看执行日志","command":"agent logs sched-agent -f json","expect":"返回日志数组，退出码 0"},
    {"id":"p10-sched-stop","description":"[Phase 10 Scheduler] 停止 Agent","command":"agent stop sched-agent","expect":"成功停止"},
    {"id":"p10-sched-destroy","description":"[Phase 10 Scheduler] 销毁","command":"agent destroy sched-agent --force","expect":"成功销毁"},

    {"id":"p11-session-setup","description":"[Phase 11 Session] 创建并启动 ACP Agent 用于 session 测试","command":"agent create session-agent -t qa-pi-tpl -f json","expect":"成功创建"},
    {"id":"p11-session-start","description":"[Phase 11 Session] 启动 Agent","command":"agent start session-agent","expect":"成功启动，退出码 0"},
    {"id":"p11-session-list-empty","description":"[Phase 11 Session] 列出 sessions（应为空）","command":"_rpc:session.list {\"agentName\":\"session-agent\"}","expect":"返回空数组"},
    {"id":"p11-session-create","description":"[Phase 11 Session] 创建 session","command":"_rpc:session.create {\"agentName\":\"session-agent\",\"clientId\":\"qa-client-1\"}","expect":"返回 SessionLeaseInfo，包含 sessionId"},
    {"id":"p11-session-list-one","description":"[Phase 11 Session] 列出 sessions（应有 1 个）","command":"_rpc:session.list {\"agentName\":\"session-agent\"}","expect":"返回包含 1 个 session 的数组"},
    {"id":"p11-session-prompt","description":"[Phase 11 Session] 通过 session 发送 prompt","command":"_rpc:session.prompt {\"sessionId\":\"$LAST_SESSION_ID\",\"text\":\"Say hi\"}","expect":"返回 JSON 包含 text 和 stopReason。如无 API key，返回 LLM 错误（WARN）","note":"$LAST_SESSION_ID 应从 session.create 的返回值中获取"},
    {"id":"p11-session-cancel","description":"[Phase 11 Session] 取消 session","command":"_rpc:session.cancel {\"sessionId\":\"$LAST_SESSION_ID\"}","expect":"返回 {ok: true} 或提示无活动请求"},
    {"id":"p11-session-close","description":"[Phase 11 Session] 关闭 session","command":"_rpc:session.close {\"sessionId\":\"$LAST_SESSION_ID\"}","expect":"返回 {ok: true}"},
    {"id":"p11-session-list-closed","description":"[Phase 11 Session] 关闭后列出（应为空）","command":"_rpc:session.list {\"agentName\":\"session-agent\"}","expect":"session 已从列表中移除"},
    {"id":"p11-proxy-help","description":"[Phase 11 Proxy] Proxy 帮助信息","command":"proxy --help","expect":"输出 proxy 用法说明，包含 --lease 和 -t 选项，退出码 0"},
    {"id":"p11-proxy-nonexist","description":"[Phase 11 Proxy] 对不存在的 Agent 启动 proxy","command":"proxy nonexistent-proxy-agent-xyz","expect":"退出码非 0，错误信息"},
    {"id":"p11-session-stop","description":"[Phase 11 Session] 停止 session 测试 Agent","command":"agent stop session-agent","expect":"成功停止，退出码 0","note":"必须先停止再销毁，否则 Windows 上会 EBUSY"},
    {"id":"p11-session-cleanup","description":"[Phase 11 Session] 清理 session 测试 Agent","command":"agent destroy session-agent --force","expect":"成功销毁"},

    {"id":"p12-update-check","description":"[Phase 12 Self-Update] 检查版本（--check）","command":"self-update --check --source $PROJECT_ROOT","expect":"输出版本信息（Source version 和 Last update 状态），退出码 0"},
    {"id":"p12-update-dryrun","description":"[Phase 12 Self-Update] Dry run 更新","command":"self-update --dry-run --no-agent --source $PROJECT_ROOT","expect":"输出计划执行的操作（不实际执行），退出码 0 或输出 update manifest 信息"},
    {"id":"p12-update-wb-manifest","description":"[Phase 12 Self-Update] 白盒验证 update-manifest.json","command":"_whitebox_read:$ACTANT_HOME/update-manifest.json","expect":"文件存在，包含 updateId、sourcePath、phase 字段"},
    {"id":"p12-update-nosource","description":"[Phase 12 Self-Update] 无 --source 且 config.json devSourcePath 为空","command":"self-update --check","expect":"退出码 1，输出红色文本: No source path specified. Use --source <path> or set devSourcePath in ~/.actant/config.json"},

    {"id":"p13-err-agent-create-notpl","description":"[Phase 13 错误处理] 创建 Agent 不指定模板","command":"agent create no-tpl-agent","expect":"退出码 1，Commander 输出: error: required option '-t, --template <template>' not specified"},
    {"id":"p13-err-agent-create-badtpl","description":"[Phase 13 错误处理] 使用不存在的模板创建","command":"agent create bad-agent -t nonexistent-tpl-xyz-99","expect":"退出码非 0，提示模板不存在"},
    {"id":"p13-err-agent-start-noexist","description":"[Phase 13 错误处理] 启动不存在的 Agent","command":"agent start ghost-agent-xyz-99","expect":"退出码非 0，错误信息"},
    {"id":"p13-err-agent-stop-noexist","description":"[Phase 13 错误处理] 停止不存在的 Agent","command":"agent stop ghost-agent-xyz-99","expect":"退出码非 0，错误信息"},
    {"id":"p13-err-agent-status-noexist","description":"[Phase 13 错误处理] 查看不存在 Agent 状态","command":"agent status ghost-agent-xyz-99","expect":"退出码非 0，错误信息"},
    {"id":"p13-err-agent-resolve-noexist","description":"[Phase 13 错误处理] Resolve 不存在的 Agent","command":"agent resolve ghost-agent-xyz-99","expect":"退出码非 0，错误信息"},
    {"id":"p13-err-agent-destroy-force","description":"[Phase 13 错误处理] destroy --force 不存在的 Agent（幂等）","command":"agent destroy ghost-agent-xyz-99 --force","expect":"退出码 0，输出 Destroyed ghost-agent-xyz-99 (already absent)。--force 模式将 AGENT_NOT_FOUND(-32003) 视为成功"},
    {"id":"p13-err-dup-setup","description":"[Phase 13 错误处理] 创建用于重复测试的 Agent","command":"agent create dup-test -t qa-cursor-tpl","expect":"成功创建"},
    {"id":"p13-err-dup-create","description":"[Phase 13 错误处理] 重复创建同名 Agent","command":"agent create dup-test -t qa-cursor-tpl","expect":"退出码非 0，提示 Agent 已存在"},
    {"id":"p13-err-dup-cleanup","description":"[Phase 13 错误处理] 清理重复测试 Agent","command":"agent destroy dup-test --force","expect":"成功销毁"},
    {"id":"p13-err-skill-show-noexist","description":"[Phase 13 错误处理] 查看不存在的 skill","command":"skill show nonexistent-skill-xyz-99","expect":"退出码非 0，错误信息"},
    {"id":"p13-err-prompt-show-noexist","description":"[Phase 13 错误处理] 查看不存在的 prompt","command":"prompt show nonexistent-prompt-xyz-99","expect":"退出码非 0，错误信息"},
    {"id":"p13-err-mcp-show-noexist","description":"[Phase 13 错误处理] 查看不存在的 MCP","command":"mcp show nonexistent-mcp-xyz-99","expect":"退出码非 0，错误信息"},
    {"id":"p13-err-wf-show-noexist","description":"[Phase 13 错误处理] 查看不存在的 workflow","command":"workflow show nonexistent-wf-xyz-99","expect":"退出码非 0，错误信息"},
    {"id":"p13-err-plugin-show-noexist","description":"[Phase 13 错误处理] 查看不存在的 plugin","command":"plugin show nonexistent-plugin-xyz-99","expect":"退出码非 0，错误信息"},
    {"id":"p13-err-tpl-validate-nofile","description":"[Phase 13 错误处理] 验证不存在的模板文件","command":"template validate /tmp/this-file-does-not-exist-xyz-12345.json","expect":"退出码非 0，错误信息提示文件不存在"},
    {"id":"p13-err-tpl-show-noexist","description":"[Phase 13 错误处理] 查看不存在的模板","command":"template show nonexistent-tpl-xyz-99","expect":"退出码非 0"},
    {"id":"p13-err-source-validate-noparam","description":"[Phase 13 错误处理] source validate 无参数","command":"source validate","expect":"退出码 1，输出 Provide a source name or --path <dir>"},
    {"id":"p13-err-source-remove-noexist","description":"[Phase 13 错误处理] 移除不存在的 source","command":"source remove nonexistent-source-xyz-99","expect":"退出码 0，输出 Source not found（source remove 对不存在源为幂等操作）"},
    {"id":"p13-err-schedule-noexist","description":"[Phase 13 错误处理] 列出不存在 Agent 的 schedule","command":"schedule list nonexistent-sched-xyz-99","expect":"退出码非 0，错误信息"},
    {"id":"p13-err-session-noagent","description":"[Phase 13 错误处理] 对不存在 Agent 创建 session","command":"_rpc:session.create {\"agentName\":\"ghost-session-xyz\",\"clientId\":\"qa\"}","expect":"返回错误，Agent 不存在"},
    {"id":"p13-err-session-badid","description":"[Phase 13 错误处理] 使用无效 sessionId prompt","command":"_rpc:session.prompt {\"sessionId\":\"invalid-session-id-xyz\",\"text\":\"hi\"}","expect":"返回错误，session 不存在"},

    {"id":"p14-sec-create-1","description":"[Phase 14 安全] 创建含 anthropic provider 的 Agent","command":"agent create sec-agent-1 -t qa-sec-tpl -f json","expect":"成功创建"},
    {"id":"p14-sec-wb-no-apikey","description":"[Phase 14 安全] 白盒: .actant.json 不含 apiKey 值","command":"_whitebox_read:$ACTANT_HOME/instances/sec-agent-1/.actant.json","expect":"文件中 provider 配置应包含 type 和 config.apiKeyEnv，但不应包含实际的 apiKey 值（仅有环境变量名引用）"},
    {"id":"p14-sec-create-2","description":"[Phase 14 安全] 创建第二个含 provider 的 Agent","command":"agent create sec-agent-2 -t qa-claude-tpl -f json","expect":"成功创建"},
    {"id":"p14-sec-wb-no-apikey-2","description":"[Phase 14 安全] 白盒: 第二个 Agent .actant.json 不含 apiKey","command":"_whitebox_read:$ACTANT_HOME/instances/sec-agent-2/.actant.json","expect":"provider 配置不含明文 apiKey"},
    {"id":"p14-sec-grep-instances","description":"[Phase 14 安全] 白盒: instances/ 全局搜索 apiKey 泄露","command":"_whitebox_grep:apiKey in $ACTANT_HOME/instances/","expect":"搜索结果中不应包含实际 API key 值（apiKeyEnv 作为环境变量名引用是允许的）"},
    {"id":"p14-sec-grep-secrets","description":"[Phase 14 安全] 白盒: 搜索常见密钥模式","command":"_whitebox_grep:(sk-|anthropic_api_key.*=) in $ACTANT_HOME/instances/","expect":"grep 结果为空，instances/ 下无密钥泄露"},
    {"id":"p14-sec-grep-templates","description":"[Phase 14 安全] 白盒: 模板持久化文件不含明文密钥","command":"_whitebox_grep:(sk-|secret_key) in $ACTANT_HOME/configs/templates/","expect":"模板文件中不含明文 API 密钥"},
    {"id":"p14-sec-cleanup","description":"[Phase 14 安全] 清理安全测试 Agent","command":"agent destroy sec-agent-1 --force","expect":"成功销毁"},
    {"id":"p14-sec-cleanup-2","description":"[Phase 14 安全] 清理第二个安全测试 Agent","command":"agent destroy sec-agent-2 --force","expect":"成功销毁"},

    {"id":"p15-edge-destroy-twice","description":"[Phase 15 幂等性] destroy --force 两次（幂等）","command":"agent destroy idempotent-test-xyz --force","expect":"退出码 0（第一次可能找不到也没关系，--force 幂等）"},
    {"id":"p15-edge-destroy-twice-2","description":"[Phase 15 幂等性] 再次 destroy 同一个名字","command":"agent destroy idempotent-test-xyz --force","expect":"退出码 0（仍然幂等）"},
    {"id":"p15-edge-tpl-load-twice","description":"[Phase 15 幂等性] template load 同一文件两次","command":"template load $FIXTURE_DIR/code-review-agent.json","expect":"退出码 0，覆盖加载或提示已存在"},
    {"id":"p15-edge-tpl-load-twice-2","description":"[Phase 15 幂等性] 第二次 load（allowOverwrite=true）","command":"template load $FIXTURE_DIR/code-review-agent.json","expect":"退出码 0，成功覆盖（TemplateRegistry 配置为 allowOverwrite: true）"},
    {"id":"p15-edge-longname","description":"[Phase 15 边界] 创建长名称 Agent（50 字符）","command":"agent create this-is-a-very-long-agent-name-for-boundary-test -t qa-cursor-tpl -f json","expect":"成功创建或因名称过长而失败（取决于系统限制），退出码应明确"},
    {"id":"p15-edge-longname-cleanup","description":"[Phase 15 边界] 清理长名称 Agent","command":"agent destroy this-is-a-very-long-agent-name-for-boundary-test --force","expect":"退出码 0"},
    {"id":"p15-edge-overwrite","description":"[Phase 15 边界] 使用 --overwrite 创建 Agent","command":"agent create overwrite-test -t qa-cursor-tpl --overwrite -f json","expect":"成功创建"},
    {"id":"p15-edge-overwrite-2","description":"[Phase 15 边界] 再次 --overwrite 同名 Agent","command":"agent create overwrite-test -t qa-cursor-tpl --overwrite -f json","expect":"成功覆盖创建，退出码 0"},
    {"id":"p15-edge-overwrite-cleanup","description":"[Phase 15 边界] 清理 overwrite Agent","command":"agent destroy overwrite-test --force","expect":"成功销毁"},
    {"id":"p15-edge-format-quiet","description":"[Phase 15 边界] quiet 格式输出","command":"daemon status -f quiet","expect":"输出 running 或 stopped（简洁单词），退出码 0"},

    {"id":"p16-conc-create-1","description":"[Phase 16 并发] 创建 Agent 1/5","command":"agent create conc-agent-1 -t qa-cursor-tpl -f json","expect":"成功创建"},
    {"id":"p16-conc-create-2","description":"[Phase 16 并发] 创建 Agent 2/5","command":"agent create conc-agent-2 -t qa-claude-tpl -f json","expect":"成功创建"},
    {"id":"p16-conc-create-3","description":"[Phase 16 并发] 创建 Agent 3/5","command":"agent create conc-agent-3 -t qa-pi-tpl -f json","expect":"成功创建"},
    {"id":"p16-conc-create-4","description":"[Phase 16 并发] 创建 Agent 4/5","command":"agent create conc-agent-4 -t qa-cursor-tpl -f json","expect":"成功创建"},
    {"id":"p16-conc-create-5","description":"[Phase 16 并发] 创建 Agent 5/5","command":"agent create conc-agent-5 -t qa-sec-tpl -f json","expect":"成功创建"},
    {"id":"p16-conc-list","description":"[Phase 16 并发] 列出全部 5 个 Agent","command":"agent list -f json","expect":"返回数组包含 conc-agent-1 到 conc-agent-5，各自 backendType 正确"},
    {"id":"p16-conc-destroy-1","description":"[Phase 16 并发] 销毁 Agent 1","command":"agent destroy conc-agent-1 --force","expect":"成功销毁"},
    {"id":"p16-conc-destroy-2","description":"[Phase 16 并发] 销毁 Agent 2","command":"agent destroy conc-agent-2 --force","expect":"成功销毁"},
    {"id":"p16-conc-destroy-3","description":"[Phase 16 并发] 销毁 Agent 3","command":"agent destroy conc-agent-3 --force","expect":"成功销毁"},
    {"id":"p16-conc-destroy-4","description":"[Phase 16 并发] 销毁 Agent 4","command":"agent destroy conc-agent-4 --force","expect":"成功销毁"},
    {"id":"p16-conc-destroy-5","description":"[Phase 16 并发] 销毁 Agent 5","command":"agent destroy conc-agent-5 --force","expect":"成功销毁"},
    {"id":"p16-conc-list-empty","description":"[Phase 16 并发] 确认全部销毁","command":"agent list -f json","expect":"返回空数组"},

    {"id":"p17-final-agent-list","description":"[Phase 17 清理] 确认无残留 Agent","command":"agent list -f json","expect":"返回空数组"},
    {"id":"p17-final-tpl-list","description":"[Phase 17 清理] 确认模板状态","command":"template list -f json","expect":"退出码 0，返回模板列表"},
    {"id":"p17-final-daemon-status","description":"[Phase 17 清理] 确认 Daemon 运行状态","command":"daemon status -f json","expect":"running=true，退出码 0"},
    {"id":"p17-daemon-stop","description":"[Phase 17 清理] 停止 Daemon","command":"daemon stop","expect":"成功停止，退出码 0"},
    {"id":"p17-daemon-after-stop","description":"[Phase 17 清理] 确认 Daemon 已停止","command":"daemon status","expect":"退出码非 0，提示 daemon 未运行"}
  ],

  "cleanup": [
    "agent destroy qa-cursor-1 --force",
    "agent destroy mb-cursor --force",
    "agent destroy mb-claude --force",
    "agent destroy mb-pi --force",
    "agent destroy adopted-agent --force",
    "agent destroy rich-agent --force",
    "agent destroy comm-agent --force",
    "agent destroy sched-agent --force",
    "agent destroy session-agent --force",
    "agent destroy sec-agent-1 --force",
    "agent destroy sec-agent-2 --force",
    "agent destroy dup-test --force",
    "agent destroy overwrite-test --force",
    "agent destroy this-is-a-very-long-agent-name-for-boundary-test --force",
    "agent destroy conc-agent-1 --force",
    "agent destroy conc-agent-2 --force",
    "agent destroy conc-agent-3 --force",
    "agent destroy conc-agent-4 --force",
    "agent destroy conc-agent-5 --force",
    "source remove qa-local",
    "daemon stop"
  ]
}
